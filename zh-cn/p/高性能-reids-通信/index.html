<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="åŸºäºæºç åˆ†æredisçš„é«˜æ€§èƒ½é€šä¿¡æ­å»ºï¼Œä»¥åŠä½¿ç”¨epollåšioå¤šè·¯å¤ç”¨çš„æµç¨‹">
<title>é«˜æ€§èƒ½ reids-é€šä¿¡</title>

<link rel='canonical' href='https://wencynyu.github.io/zh-cn/p/%E9%AB%98%E6%80%A7%E8%83%BD-reids-%E9%80%9A%E4%BF%A1/'>

<link rel="stylesheet" href="/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css"><meta property='og:title' content="é«˜æ€§èƒ½ reids-é€šä¿¡">
<meta property='og:description' content="åŸºäºæºç åˆ†æredisçš„é«˜æ€§èƒ½é€šä¿¡æ­å»ºï¼Œä»¥åŠä½¿ç”¨epollåšioå¤šè·¯å¤ç”¨çš„æµç¨‹">
<meta property='og:url' content='https://wencynyu.github.io/zh-cn/p/%E9%AB%98%E6%80%A7%E8%83%BD-reids-%E9%80%9A%E4%BF%A1/'>
<meta property='og:site_name' content='wenxin-blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2024-11-20T03:44:33&#43;08:00'/><meta property='article:modified_time' content='2024-11-20T03:44:33&#43;08:00'/>
<meta name="twitter:title" content="é«˜æ€§èƒ½ reids-é€šä¿¡">
<meta name="twitter:description" content="åŸºäºæºç åˆ†æredisçš„é«˜æ€§èƒ½é€šä¿¡æ­å»ºï¼Œä»¥åŠä½¿ç”¨epollåšioå¤šè·¯å¤ç”¨çš„æµç¨‹">
    <link rel="shortcut icon" href="/favicon.png" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/zh-cn/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu897059592634026878.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ¥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/zh-cn">wenxin-blog</a></h1>
            <h2 class="site-description">There are some programing and life blog by wenxin.</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/wencynyu'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/zh-cn/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>ä¸»é¡µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/zh-cn/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>å½’æ¡£</span>
            </a>
        </li>
        
        
        <li >
            <a href='/zh-cn/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/zh-cn/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                    
                        <li id="i18n-switch">  
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                            <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                                
                                    <option value="https://wencynyu.github.io/en/" >English</option>
                                
                                    <option value="https://wencynyu.github.io/zh-cn/" selected>ä¸­æ–‡</option>
                                
                            </select>
                        </li>
                    
                

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>æš—è‰²æ¨¡å¼</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#æºç åˆ†æ">æºç åˆ†æ</a>
      <ol>
        <li><a href="#ç³»ç»Ÿåˆå§‹åŒ–--eventloopäº‹ä»¶å¾ªç¯æ€»çº¿æ„å»º">ç³»ç»Ÿåˆå§‹åŒ– &amp; eventloopäº‹ä»¶å¾ªç¯æ€»çº¿æ„å»º</a></li>
        <li><a href="#å¤šè·¯å¤ç”¨å¤„ç†æ–¹æ³•ç±»ä¼¼nettyä¸­çš„handlerå®ç°">å¤šè·¯å¤ç”¨å¤„ç†æ–¹æ³•ï¼ˆç±»ä¼¼nettyä¸­çš„handlerå®ç°ï¼‰</a>
          <ol>
            <li><a href="#processinputbufferè¯»å–clientè¯·æ±‚ä¿¡æ¯">processInputBufferè¯»å–clientè¯·æ±‚ä¿¡æ¯</a></li>
            <li><a href="#åè®®è§£æ">åè®®è§£æ</a></li>
            <li><a href="#processcommandå¤„ç†å‘½ä»¤">processCommandå¤„ç†å‘½ä»¤</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#å†…æ ¸å‡½æ•°åˆ†æ">å†…æ ¸å‡½æ•°åˆ†æ</a>
      <ol>
        <li><a href="#epoll_create">epoll_create</a>
          <ol>
            <li><a href="#å‚æ•°ä»‹ç»">å‚æ•°ä»‹ç»</a></li>
            <li><a href="#è¿”å›å€¼">è¿”å›å€¼</a></li>
          </ol>
        </li>
        <li><a href="#epoll_ctl">epoll_ctl</a>
          <ol>
            <li><a href="#å‚æ•°ä»‹ç»-1">å‚æ•°ä»‹ç»</a></li>
            <li><a href="#è¿”å›å€¼-1">è¿”å›å€¼</a></li>
          </ol>
        </li>
        <li><a href="#epoll_wait">epoll_wait</a>
          <ol>
            <li><a href="#å‚æ•°ä»‹ç»-2">å‚æ•°ä»‹ç»</a></li>
            <li><a href="#è¿”å›å€¼-2">è¿”å›å€¼</a></li>
          </ol>
        </li>
        <li><a href="#è¾¹ç¼˜è§¦å‘--æ°´å¹³è§¦å‘">è¾¹ç¼˜è§¦å‘ &amp; æ°´å¹³è§¦å‘</a>
          <ol>
            <li><a href="#æ§åˆ¶">æ§åˆ¶</a></li>
          </ol>
        </li>
        <li><a href="#epoll_waitå¦‚ä½•å®ç°ç­‰å¾…">epoll_waitå¦‚ä½•å®ç°ç­‰å¾…</a>
          <ol>
            <li><a href="#æ€»ç»“">æ€»ç»“</a></li>
            <li><a href="#ä¸€ç›´æ²¡æœ‰äº‹ä»¶å‘ç”Ÿçš„ä¾‹å­">ä¸€ç›´æ²¡æœ‰äº‹ä»¶å‘ç”Ÿçš„ä¾‹å­</a></li>
          </ol>
        </li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/zh-cn/categories/%E5%90%8E%E7%AB%AF/" >
                åç«¯
            </a>
        
            <a href="/zh-cn/categories/nosql/" >
                NoSql
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/zh-cn/p/%E9%AB%98%E6%80%A7%E8%83%BD-reids-%E9%80%9A%E4%BF%A1/">é«˜æ€§èƒ½ reids-é€šä¿¡</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            åŸºäºæºç åˆ†æredisçš„é«˜æ€§èƒ½é€šä¿¡æ­å»ºï¼Œä»¥åŠä½¿ç”¨epollåšioå¤šè·¯å¤ç”¨çš„æµç¨‹
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Nov 20, 2024</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 25 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="redisé€šä¿¡">redisé€šä¿¡
</h1><h2 id="æºç åˆ†æ">æºç åˆ†æ
</h2><h3 id="ç³»ç»Ÿåˆå§‹åŒ–--eventloopäº‹ä»¶å¾ªç¯æ€»çº¿æ„å»º">ç³»ç»Ÿåˆå§‹åŒ– &amp; eventloopäº‹ä»¶å¾ªç¯æ€»çº¿æ„å»º
</h3><ol>
<li>ä»mainå‡½æ•°è¯´èµ·ï¼ˆåŸ300+è¡Œï¼Œç²¾ç®€éƒ¨åˆ†éæ ¸å¿ƒå†…å®¹ååŒ…å«æ³¨é‡Š100+è¡Œï¼‰
<ul>
<li>ç½‘ç»œé€šä¿¡ç›¸å…³ä¸»è¦ä¸ºï¼šåœ¨mainå‡½æ•°ä¸­å¯åŠ¨epollç›‘å¬ï¼Œioå¤šè·¯å¤ç”¨</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">config_from_stdin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* ç³»ç»ŸåŸºç¡€ä¾èµ–åˆå§‹åŒ–ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm">    1. æ—¶åŒºè®¾ç½®
</span></span></span><span class="line"><span class="cl"><span class="cm">    2. å†…å­˜oomå¤„ç†æ–¹æ³•
</span></span></span><span class="line"><span class="cl"><span class="cm">    3. éšæœºæ•°/å“ˆå¸Œç§å­ç”Ÿæˆ
</span></span></span><span class="line"><span class="cl"><span class="cm">    4. crc64æ ¡éªŒç åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">exec_name</span> <span class="o">=</span> <span class="nf">strrchr</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="sc">&#39;/&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">exec_name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="n">exec_name</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="p">.</span><span class="n">sentinel_mode</span> <span class="o">=</span> <span class="nf">checkForSentinelMode</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">,</span> <span class="n">exec_name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">initServerConfig</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ACLInit</span><span class="p">();</span> <span class="cm">/* åˆå§‹åŒ– ACLï¼ˆè®¿é—®æ§åˆ¶åˆ—è¡¨ï¼‰ç³»ç»Ÿï¼Œç½‘ç»œè¿æ¥æ—¶éœ€è¦æ ¹æ®ACLæ§åˆ¶æƒé™ï¼Œæ­¤æ—¶æœªåŠ è½½å®é™…é…ç½® */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">moduleInitModulesSystem</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">connTypeInitialize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* å­˜å‚¨å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„å’Œå¯åŠ¨å‚æ•°ï¼Œç”¨äºä»¥åé‡å¯æœåŠ¡å™¨ */</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="p">.</span><span class="n">executable</span> <span class="o">=</span> <span class="nf">getAbsolutePath</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="p">.</span><span class="n">exec_argv</span> <span class="o">=</span> <span class="nf">zmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">argc</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="p">.</span><span class="n">exec_argv</span><span class="p">[</span><span class="n">argc</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="n">server</span><span class="p">.</span><span class="n">exec_argv</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nf">zstrdup</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* åˆå§‹åŒ– Sentinel ç›¸å…³é…ç½®ï¼ˆå¦‚æœæ˜¯ Sentinel æ¨¡å¼ï¼‰ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">sentinel_mode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">initSentinelConfig</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nf">initSentinel</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* æ£€æŸ¥æ˜¯å¦éœ€è¦å¯åŠ¨ redis-check-rdb æˆ– redis-check-aof æ¨¡å¼ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">strstr</span><span class="p">(</span><span class="n">exec_name</span><span class="p">,</span><span class="s">&#34;redis-check-rdb&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">redis_check_rdb_main</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nf">strstr</span><span class="p">(</span><span class="n">exec_name</span><span class="p">,</span><span class="s">&#34;redis-check-aof&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">redis_check_aof_main</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* å‚æ•°è§£æ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">sds</span> <span class="n">options</span> <span class="o">=</span> <span class="nf">sdsempty</span><span class="p">();</span> <span class="c1">// ä½¿ç”¨å†…éƒ¨å®šä¹‰çš„sdså­—ç¬¦ä¸²ç»“æ„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* è§£æç‰¹æ®Šå‚æ•° --versionï¼Œ--help */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;-v&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">            <span class="nf">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;--version&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">sds</span> <span class="n">version</span> <span class="o">=</span> <span class="nf">getVersion</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Redis server %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">sdsfree</span><span class="p">(</span><span class="n">version</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;--help&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">            <span class="nf">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;-h&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nf">usage</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">sds</span> <span class="o">*</span><span class="n">argv_tmp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">argc_tmp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">handled_last_config_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span><span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* éå†è§£æå‚æ•° */</span>
</span></span><span class="line"><span class="cl">            <span class="n">j</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* æ ¹æ®å‚æ•°å®Œæˆå¿…è¦æ–‡ä»¶é…ç½®çš„åŠ è½½ */</span>
</span></span><span class="line"><span class="cl">        <span class="nf">loadServerConfig</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">configfile</span><span class="p">,</span> <span class="n">config_from_stdin</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">sentinel_mode</span><span class="p">)</span> <span class="nf">loadSentinelConfigFromQueue</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sdsfree</span><span class="p">(</span><span class="n">options</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">sentinel_mode</span><span class="p">)</span> <span class="nf">sentinelCheckConfigFile</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* æ ¸å¿ƒï¼šå¯åŠ¨æœåŠ¡ */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">initServer</span><span class="p">();</span> <span class="c1">// æ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼šè½½å…¥serverå¯¹è±¡ç›¸å…³çš„æ ¸å¿ƒç»„ä»¶ï¼šsignalä¿¡å·å¤„ç†å™¨ï¼Œthreadçº¿ç¨‹ç®¡ç†å™¨ï¼Œeventloopäº‹ä»¶å¤„ç†æ€»çº¿ç­‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">background</span> <span class="o">||</span> <span class="n">server</span><span class="p">.</span><span class="n">pidfile</span><span class="p">)</span> <span class="nf">createPidFile</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">set_proc_title</span><span class="p">)</span> <span class="nf">redisSetProcTitle</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">redisAsciiArt</span><span class="p">();</span> <span class="c1">// æ‰“å°å¯åŠ¨redisçš„ASCIIæ–‡å­—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">checkTcpBacklogSettings</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">cluster_enabled</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">clusterInit</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="p">.</span><span class="n">sentinel_mode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">moduleInitModulesSystemLast</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nf">moduleLoadFromQueue</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// aclè¯»å–å®é™…é…ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ACLLoadUsersAtStartup</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">initListeners</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">cluster_enabled</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">clusterInitLast</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">InitServerLast</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="p">.</span><span class="n">sentinel_mode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ésentinelæ¨¡å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">serverLog</span><span class="p">(</span><span class="n">LL_NOTICE</span><span class="p">,</span><span class="s">&#34;Server initialized&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">aofLoadManifestFromDisk</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nf">loadDataFromDisk</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nf">aofOpenIfNeededOnServerStart</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nf">aofDelHistoryFiles</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nf">applyAppendOnlyConfig</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// é›†ç¾¤æ¨¡å¼æ ¡éªŒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">cluster_enabled</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">serverAssert</span><span class="p">(</span><span class="nf">verifyClusterConfigWithData</span><span class="p">()</span> <span class="o">==</span> <span class="n">C_OK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// æ‰“å°æ‰€æœ‰ç›‘å¬å™¨çš„çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">CONN_TYPE_MAX</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">connListener</span> <span class="o">*</span><span class="n">listener</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">server</span><span class="p">.</span><span class="n">listeners</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">ct</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nf">serverLog</span><span class="p">(</span><span class="n">LL_NOTICE</span><span class="p">,</span><span class="s">&#34;Ready to accept connections %s&#34;</span><span class="p">,</span> <span class="n">listener</span><span class="o">-&gt;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="nf">get_type</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">supervised_mode</span> <span class="o">==</span> <span class="n">SUPERVISED_SYSTEMD</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å¦‚æœæ˜¯ç”± systemd ç›‘ç£è¿è¡Œçš„ Redis å®ä¾‹ï¼Œé€šçŸ¥ systemd Redis çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sentinelIsRunning</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">supervised_mode</span> <span class="o">==</span> <span class="n">SUPERVISED_SYSTEMD</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// å¦‚æœæ˜¯ç”± systemd ç›‘ç£è¿è¡Œçš„ sentinel å®ä¾‹ï¼Œé€šçŸ¥ systemd sentinel çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* å†…å­˜åˆ†é…è¿‡å°ï¼ˆ1MBï¼‰è­¦å‘Š */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">maxmemory</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">server</span><span class="p">.</span><span class="n">maxmemory</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">serverLog</span><span class="p">(</span><span class="n">LL_WARNING</span><span class="p">,</span><span class="s">&#34;WARNING: You specified a maxmemory value that is less than 1MB (current value is %llu bytes). Are you sure this is what you really want?&#34;</span><span class="p">,</span> <span class="n">server</span><span class="p">.</span><span class="n">maxmemory</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">redisSetCpuAffinity</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">server_cpulist</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setOOMScoreAdj</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// epollç›‘å¬ï¼Œioå¤šè·¯å¤ç”¨ï¼Œæ­»å¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">aeMain</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">el</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">aeDeleteEventLoop</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">el</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>æ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼šinitServeræ–¹æ³•ï¼Œè½½å…¥serverå¯¹è±¡ç›¸å…³çš„æ ¸å¿ƒç»„ä»¶ï¼šsignalä¿¡å·å¤„ç†å™¨ï¼Œthreadçº¿ç¨‹ç®¡ç†å™¨ï¼Œeventloopäº‹ä»¶å¤„ç†æ€»çº¿ç­‰ã€‚ï¼ˆåŸ200+è¡Œï¼Œç²¾ç®€éƒ¨åˆ†éæ ¸å¿ƒå†…å®¹ååŒ…å«æ³¨é‡Š60+è¡Œï¼‰
<ul>
<li>ç½‘ç»œé€šä¿¡ç›¸å…³ä¸»è¦ä¸ºï¼šåœ¨åˆå§‹åŒ–å‡½æ•°ä¸­åˆ›å»ºthreadçº¿ç¨‹ç®¡ç†å™¨ï¼Œeventloopäº‹ä»¶å¤„ç†æ€»çº¿</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">initServer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ä¿¡å·å¤„ç†å™¨ï¼Œä¾‹å¦‚ctrl+cå‘é€SIGKILLä¿¡å·ï¼Œæ­¤æ—¶éœ€è¦å…³é—­æœåŠ¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">setupSignalHandlers</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// çº¿ç¨‹ç®¡ç†å™¨åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ThreadsManager_init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">makeThreadKillable</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* åœ¨ä»é…ç½®ç³»ç»Ÿè®¾ç½®é»˜è®¤å€¼åè¿›è¡Œåˆå§‹åŒ– */</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="p">.</span><span class="n">aof_state</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">aof_enabled</span> <span class="o">?</span> <span class="nl">AOF_ON</span> <span class="p">:</span> <span class="n">AOF_OFF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="p">.</span><span class="n">fsynced_reploff</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">aof_enabled</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="p">.</span><span class="n">hz</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">config_hz</span><span class="p">;</span> <span class="c1">// å¿ƒè·³é¢‘ç‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">server</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="nf">getpid</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ›å»ºeventloopäº‹ä»¶å¤„ç†æ€»çº¿ï¼ŒåŸºäºepollæœºåˆ¶ï¼ˆlinuxï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">server</span><span class="p">.</span><span class="n">el</span> <span class="o">=</span> <span class="nf">aeCreateEventLoop</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">maxclients</span><span class="o">+</span><span class="n">CONFIG_FDSET_INCR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">el</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">serverLog</span><span class="p">(</span><span class="n">LL_WARNING</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;Failed creating the event loop. Error message: &#39;%s&#39;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nf">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="cm">/* åˆ›å»ºå®šæ—¶å™¨å›è°ƒï¼Œè¿™æ˜¯æˆ‘ä»¬å¤„ç†è®¸å¤šåå°æ“ä½œçš„æ–¹å¼ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">       æ¯”å¦‚å®¢æˆ·ç«¯è¶…æ—¶ã€æœªè®¿é—®çš„è¿‡æœŸé”®çš„æ·˜æ±°ç­‰ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">aeCreateTimeEvent</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">el</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">serverCron</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="n">AE_ERR</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">serverPanic</span><span class="p">(</span><span class="s">&#34;Can&#39;t create event loop timers.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* ä¸ºç”¨äºå”¤é†’äº‹ä»¶å¾ªç¯çš„ç®¡é“æ³¨å†Œä¸€ä¸ªå¯è¯»äº‹ä»¶ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">       ç”¨äºæ¨¡å—çº¿ç¨‹é—´çš„é€šä¿¡ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">aeCreateFileEvent</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">el</span><span class="p">,</span> <span class="n">server</span><span class="p">.</span><span class="n">module_pipe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">AE_READABLE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">modulePipeReadable</span><span class="p">,</span><span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="n">AE_ERR</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">serverPanic</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;Error registering the readable event for the module pipe.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* æ³¨å†Œepollé˜»å¡å‰åçš„å›è°ƒå‡½æ•°ï¼ˆéœ€åœ¨åŠ è½½æŒä¹…åŒ–ä¹‹å‰å®Œæˆï¼Œå› ä¸ºå®ƒä¼šè¢« processEventsWhileBlocked ä½¿ç”¨ï¼‰ */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">aeSetBeforeSleepProc</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">el</span><span class="p">,</span><span class="n">beforeSleep</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">aeSetAfterSleepProc</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">el</span><span class="p">,</span><span class="n">afterSleep</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* 32ä½è€ç³»ç»Ÿå—é™äºå¯»å€ä¸Šé™32bitï¼Œæœ€å¤šè®¿é—®2^32ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯4294967296B -&gt; 4GBï¼Œredisä¼šé»˜è®¤é™åˆ¶3GBä¸Šé™ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">arch_bits</span> <span class="o">==</span> <span class="mi">32</span> <span class="o">&amp;&amp;</span> <span class="n">server</span><span class="p">.</span><span class="n">maxmemory</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">serverLog</span><span class="p">(</span><span class="n">LL_WARNING</span><span class="p">,</span><span class="s">&#34;Warning: 32 bit instance detected but no memory limit set. Setting 3 GB maxmemory limit with &#39;noeviction&#39; policy now.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">server</span><span class="p">.</span><span class="n">maxmemory</span> <span class="o">=</span> <span class="mi">3072LL</span><span class="o">*</span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span> <span class="cm">/* 3 GB */</span>
</span></span><span class="line"><span class="cl">        <span class="n">server</span><span class="p">.</span><span class="n">maxmemory_policy</span> <span class="o">=</span> <span class="n">MAXMEMORY_NO_EVICTION</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// è„šæœ¬ç³»ç»Ÿåˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">luaEnvInit</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">scriptingInit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">functionsInit</span><span class="p">()</span> <span class="o">==</span> <span class="n">C_ERR</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">serverPanic</span><span class="p">(</span><span class="s">&#34;Functions initialization failed, check the server logs.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// åŸºæœ¬ç›‘æ§åˆå§‹åŒ–ï¼šæä¾›æ…¢æŸ¥è¯¢å‘Šè­¦/å»¶è¿Ÿç›‘æ§ç­‰åŠŸèƒ½
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">slowlogInit</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">latencyMonitorInit</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å‚ç…§é…ç½®åˆå§‹åŒ–å¯†ç ï¼Œä¸€èˆ¬ä¸å¯ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ACLUpdateDefaultUserPassword</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">requirepass</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// å®šæ—¶å™¨åŠŸèƒ½åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">applyWatchdogPeriod</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">maxmemory_clients</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">initServerClientMemUsageBuckets</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>aeCreateEventLoopæ–¹æ³•ï¼šåˆ›å»ºäº‹ä»¶å¾ªç¯æ€»çº¿</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="n">aeEventLoop</span> <span class="o">*</span><span class="nf">aeCreateEventLoop</span><span class="p">(</span><span class="kt">int</span> <span class="n">setsize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">monotonicInit</span><span class="p">();</span>    <span class="cm">/* just in case the calling app didn&#39;t initialize */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// åˆ†é…å†…å­˜ï¼šæœ€å¤§æ„Ÿå…´è¶£çš„fdä¸ºsetsize
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">((</span><span class="n">eventLoop</span> <span class="o">=</span> <span class="nf">zmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eventLoop</span><span class="p">)))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="nf">zmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">aeFileEvent</span><span class="p">)</span><span class="o">*</span><span class="n">setsize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">fired</span> <span class="o">=</span> <span class="nf">zmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">aeFiredEvent</span><span class="p">)</span><span class="o">*</span><span class="n">setsize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">fired</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">setsize</span> <span class="o">=</span> <span class="n">setsize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">timeEventHead</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">timeEventNextId</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">maxfd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">beforesleep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">aftersleep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">aeApiCreate</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">goto</span> <span class="n">err</span><span class="p">;</span> <span class="c1">// æ ¸å¿ƒï¼šè°ƒç”¨å°è£…çš„å‡½æ•°aeApiCreate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/* Eventsçš„å…³æ³¨äº‹ä»¶é»˜è®¤ç½®ä¸º0ï¼ˆä¸å…³æ³¨ä»»ä½•äº‹ä»¶ï¼‰*/</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">setsize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span> <span class="o">=</span> <span class="n">AE_NONE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">eventLoop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">err</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¤±è´¥åˆ™é‡Šæ”¾å†…å­˜
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">eventLoop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">zfree</span><span class="p">(</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">zfree</span><span class="p">(</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">fired</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">zfree</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*  ae_epoll.cï¼Œä»…åœ¨ä¸Šé¢ä»£ç ä¸­è°ƒç”¨ï¼Œåˆ›å»ºäº‹ä»¶æ€»çº¿	
</span></span></span><span class="line"><span class="cl"><span class="cm">	è¿™é‡Œä¾èµ–ç³»ç»Ÿå†…ç½®åº“å‡½æ•°ï¼šepoll_createï¼Œå…¶ä¸­sizeå‚æ•°ä»…ä¸ºå‚è€ƒå€¼ï¼Œå¯¹è¾ƒæ–°çš„linuxç‰ˆæœ¬æ¥è¯´æ— å®é™…ä½œç”¨
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">aeApiCreate</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeApiState</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="nf">zmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">aeApiState</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="nf">zmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">epoll_event</span><span class="p">)</span><span class="o">*</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">setsize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">zfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="o">-&gt;</span><span class="n">epfd</span> <span class="o">=</span> <span class="nf">epoll_create</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span> <span class="cm">/* 1024 is just a hint for the kernel */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">epfd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">zfree</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">zfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">anetCloexec</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">epfd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">apidata</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>ae_epoll.cå°è£…ç³»ç»Ÿåº“å‡½æ•°ï¼ˆæ— ç²¾ç®€ï¼‰</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/epoll.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">aeApiState</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">epfd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">epoll_event</span> <span class="o">*</span><span class="n">events</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">aeApiState</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* ä»…åœ¨aeCreateEventLoopä»£ç ä¸­è°ƒç”¨ï¼Œåˆ›å»ºäº‹ä»¶æ€»çº¿	
</span></span></span><span class="line"><span class="cl"><span class="cm">   ä¾èµ–ç³»ç»Ÿå†…ç½®åº“å‡½æ•°ï¼šepoll_createï¼Œå…¶ä¸­ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm">   sizeå‚æ•°ä»…ä¸ºå‚è€ƒå€¼ï¼Œå¯¹è¾ƒæ–°çš„linuxç‰ˆæœ¬æ¥è¯´æ— å®é™…ä½œç”¨
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">aeApiCreate</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeApiState</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="nf">zmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">aeApiState</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="nf">zmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">epoll_event</span><span class="p">)</span><span class="o">*</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">setsize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">zfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="o">-&gt;</span><span class="n">epfd</span> <span class="o">=</span> <span class="nf">epoll_create</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span> <span class="cm">/* 1024 is just a hint for the kernel */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">epfd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">zfree</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">zfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">anetCloexec</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">epfd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">apidata</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// resize eventæ•°ç»„ï¼Œç±»ä¼¼vector(c)/list(java)/slice(golang/python)åŠ¨æ€æ‰©å®¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">aeApiResize</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="kt">int</span> <span class="n">setsize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeApiState</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">apidata</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="nf">zrealloc</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">epoll_event</span><span class="p">)</span><span class="o">*</span><span class="n">setsize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// é‡Šæ”¾èµ„æº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">aeApiFree</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeApiState</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">apidata</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">epfd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">zfree</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">zfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* åœ¨eventloopä¸­æ³¨å†Œæ–°çš„fdï¼Œmaskä¸ºæ„Ÿå…´è¶£çš„äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="cm">   ä¾èµ–ç³»ç»Ÿå†…ç½®åº“å‡½æ•°epoll_ctlï¼Œå…¶ä¸­ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm">   epfdä¸ºäº‹ä»¶æ€»çº¿fdï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">   opä¸ºæ³¨å†Œæ“ä½œï¼Œæšä¸¾EPOLL_CTL_ADD, EPOLL_CTL_ADD, EPOLL_CTL_DELï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">   fdä¸ºæ³¨å†Œçš„æ–°fdï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">   eeä¸ºæ–°å»ºçš„epoll_eventç»“æ„ä½“å®ä¾‹
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">aeApiAddEvent</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeApiState</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">apidata</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">ee</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span> <span class="cm">/* avoid valgrind warning */</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* If the fd was already monitored for some event, we need a MOD
</span></span></span><span class="line"><span class="cl"><span class="cm">     * operation. Otherwise we need an ADD operation. */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">op</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">fd</span><span class="p">].</span><span class="n">mask</span> <span class="o">==</span> <span class="n">AE_NONE</span> <span class="o">?</span>
</span></span><span class="line"><span class="cl">            <span class="nl">EPOLL_CTL_ADD</span> <span class="p">:</span> <span class="n">EPOLL_CTL_MOD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ee</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mask</span> <span class="o">|=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">fd</span><span class="p">].</span><span class="n">mask</span><span class="p">;</span> <span class="cm">/* Merge old events */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AE_READABLE</span><span class="p">)</span> <span class="n">ee</span><span class="p">.</span><span class="n">events</span> <span class="o">|=</span> <span class="n">EPOLLIN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AE_WRITABLE</span><span class="p">)</span> <span class="n">ee</span><span class="p">.</span><span class="n">events</span> <span class="o">|=</span> <span class="n">EPOLLOUT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ee</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">epoll_ctl</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">epfd</span><span class="p">,</span><span class="n">op</span><span class="p">,</span><span class="n">fd</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ee</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* åœ¨eventloopä¸­æ³¨å†Œæ–°çš„fdï¼Œmaskä¸ºæ„Ÿå…´è¶£çš„äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="cm">   ä¾èµ–ç³»ç»Ÿå†…ç½®åº“å‡½æ•°epoll_ctlï¼Œå…¶ä¸­ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm">   epfdä¸ºäº‹ä»¶æ€»çº¿fdï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">   opä¸ºæ³¨å†Œæ“ä½œï¼Œæšä¸¾EPOLL_CTL_ADD, EPOLL_CTL_ADD, EPOLL_CTL_DELï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">   fdä¸ºæ³¨å†Œçš„æ–°fdï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">   eeä¸ºæ–°å»ºçš„epoll_eventç»“æ„ä½“å®ä¾‹ï¼Œå…³æ³¨çš„maskå†™åœ¨è¿™ä¸ªç»“æ„ä½“ä¸­
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">aeApiDelEvent</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delmask</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeApiState</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">apidata</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">ee</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span> <span class="cm">/* avoid valgrind warning */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">fd</span><span class="p">].</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">delmask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ee</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AE_READABLE</span><span class="p">)</span> <span class="n">ee</span><span class="p">.</span><span class="n">events</span> <span class="o">|=</span> <span class="n">EPOLLIN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AE_WRITABLE</span><span class="p">)</span> <span class="n">ee</span><span class="p">.</span><span class="n">events</span> <span class="o">|=</span> <span class="n">EPOLLOUT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ee</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">!=</span> <span class="n">AE_NONE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">epoll_ctl</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">epfd</span><span class="p">,</span><span class="n">EPOLL_CTL_MOD</span><span class="p">,</span><span class="n">fd</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ee</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* Note, Kernel &lt; 2.6.9 requires a non null event pointer even for
</span></span></span><span class="line"><span class="cl"><span class="cm">         * EPOLL_CTL_DEL. */</span>
</span></span><span class="line"><span class="cl">        <span class="nf">epoll_ctl</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">epfd</span><span class="p">,</span><span class="n">EPOLL_CTL_DEL</span><span class="p">,</span><span class="n">fd</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ee</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* åœ¨eventloopä¸­æ³¨å†Œæ–°çš„fdï¼Œmaskä¸ºæ„Ÿå…´è¶£çš„äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="cm">   ä¾èµ–ç³»ç»Ÿå†…ç½®åº“å‡½æ•°epoll_waitï¼Œå…¶ä¸­ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm">   epfdä¸ºäº‹ä»¶æ€»çº¿fdï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">   eventsä¸ºå·²æ³¨å†Œçš„å…¨éƒ¨æ„Ÿå…´è¶£äº‹ä»¶ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">   tvpç›¸å…³ä¸ºç­‰å¾…æ—¶é—´ï¼Œ-1ä¸ºä¸€ç›´é˜»å¡ï¼Œç›´åˆ°æœ‰æ³¨å†Œçš„æ„Ÿå…´è¶£äº‹ä»¶å‘ç”Ÿ
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">aeApiPoll</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">tvp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeApiState</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">apidata</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">numevents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">retval</span> <span class="o">=</span> <span class="nf">epoll_wait</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">epfd</span><span class="p">,</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">,</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">setsize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">tvp</span> <span class="o">?</span> <span class="p">(</span><span class="n">tvp</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="o">*</span><span class="mi">1000</span> <span class="o">+</span> <span class="p">(</span><span class="n">tvp</span><span class="o">-&gt;</span><span class="n">tv_usec</span> <span class="o">+</span> <span class="mi">999</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">numevents</span> <span class="o">=</span> <span class="n">retval</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">numevents</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">struct</span> <span class="n">epoll_event</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">events</span><span class="o">+</span><span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLIN</span><span class="p">)</span> <span class="n">mask</span> <span class="o">|=</span> <span class="n">AE_READABLE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLOUT</span><span class="p">)</span> <span class="n">mask</span> <span class="o">|=</span> <span class="n">AE_WRITABLE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLERR</span><span class="p">)</span> <span class="n">mask</span> <span class="o">|=</span> <span class="n">AE_WRITABLE</span><span class="o">|</span><span class="n">AE_READABLE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLHUP</span><span class="p">)</span> <span class="n">mask</span> <span class="o">|=</span> <span class="n">AE_WRITABLE</span><span class="o">|</span><span class="n">AE_READABLE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">fired</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">fd</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">fired</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">!=</span> <span class="n">EINTR</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">panic</span><span class="p">(</span><span class="s">&#34;aeApiPoll: epoll_wait, %s&#34;</span><span class="p">,</span> <span class="nf">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">numevents</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">aeApiName</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s">&#34;epoll&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>å“ªäº›åœ°æ–¹è°ƒç”¨äº†æ³¨å†Œäº‹ä»¶
<ul>
<li><strong>serverå¯åŠ¨è¿‡ç¨‹ä¸­ï¼šinitListeners -&gt; createSocketAcceptHandler ï¼ˆacceptï¼‰</strong>
<ul>
<li>connSocketAcceptHandler</li>
</ul>
</li>
<li><strong>åˆ›å»ºå®¢æˆ·ç«¯è¿æ¥æ—¶ï¼šConnectionType -&gt; connSocketConnectï¼ˆconnectï¼‰</strong>
<ul>
<li>ae_handler -&gt; connSocketSetReadHandler
<ul>
<li>å»ºç«‹clienté€šä¿¡æ—¶ï¼šcreateClient -&gt; readQueryFromClient</li>
</ul>
</li>
<li>ae_handler -&gt; connSocketSetWriteHandler
<ul>
<li>åˆå§‹åŒ–æœåŠ¡ç«¯æ—¶ï¼šinitServer -&gt; aeSetBeforeSleepProc -&gt; beforeSleep -&gt; handleClientsWithPendingWritesUsingThreads -&gt; sendReplyToClient</li>
</ul>
</li>
</ul>
</li>
<li>åŒæ­¥rdbæ•°æ®ï¼šinitServer -&gt; aeCreateTimeEvent(server.el, 1, serverCron, NULL, NULL) -&gt; serverCron -&gt; checkChildrenDone -&gt; replicationStartPendingFork -&gt; rdbSaveToSlavesSockets
<ul>
<li>rdbPipeReadHandler</li>
</ul>
</li>
<li>sentinelé€šä¿¡ï¼šinitServer -&gt; aeCreateTimeEvent(server.el, 1, serverCron, NULL, NULL) -&gt; serverCron -&gt; sentinelTimer -&gt; sentinelHandleDictOfRedisInstances -&gt; sentinelHandleRedisInstance -&gt; sentinelReconnectInstance -&gt; redisAeAttach -&gt; redisAeAddWrite</li>
<li>pipelineç®¡é“çš„bioé€šä¿¡ï¼šinitServer -&gt; InitServerLast -&gt; bioInit</li>
</ul>
</li>
<li>æ³¨å†Œäº‹ä»¶å¤„ç†ï¼šmain -&gt; aeMain -&gt; aeApiPoll -&gt; epoll_wait</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// æ­»å¾ªç¯å¤„ç†äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">aeMain</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">aeProcessEvents</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">,</span> <span class="n">AE_ALL_EVENTS</span><span class="o">|</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">AE_CALL_BEFORE_SLEEP</span><span class="o">|</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">AE_CALL_AFTER_SLEEP</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">aeEventLoop</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">maxfd</span><span class="p">;</span>   <span class="cm">/* highest file descriptor currently registered */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">setsize</span><span class="p">;</span> <span class="cm">/* max number of file descriptors tracked */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="kt">long</span> <span class="n">timeEventNextId</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeFileEvent</span> <span class="o">*</span><span class="n">events</span><span class="p">;</span> <span class="cm">/* Registered events */</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeFiredEvent</span> <span class="o">*</span><span class="n">fired</span><span class="p">;</span> <span class="cm">/* Fired events */</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeTimeEvent</span> <span class="o">*</span><span class="n">timeEventHead</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">stop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span><span class="n">apidata</span><span class="p">;</span> <span class="cm">/* This is used for polling API specific data */</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeBeforeSleepProc</span> <span class="o">*</span><span class="n">beforesleep</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeBeforeSleepProc</span> <span class="o">*</span><span class="n">aftersleep</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">aeEventLoop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">aeFileEvent</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span> <span class="cm">/* one of AE_(READABLE|WRITABLE|BARRIER) */</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeFileProc</span> <span class="o">*</span><span class="n">rfileProc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeFileProc</span> <span class="o">*</span><span class="n">wfileProc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span><span class="n">clientData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">aeFileEvent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">aeProcessEvents</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">numevents</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* å¦‚æœæ²¡æœ‰æ–‡ä»¶äº‹ä»¶å’Œæ—¶é—´äº‹ä»¶éœ€è¦å¤„ç†ï¼Œç›´æ¥è¿”å› */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AE_TIME_EVENTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AE_FILE_EVENTS</span><span class="p">))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* å³ä½¿æ²¡æœ‰æ–‡ä»¶äº‹ä»¶ï¼Œå¦‚æœæœ‰æ—¶é—´äº‹ä»¶ï¼Œä¹Ÿéœ€è¦è°ƒç”¨ aeApiPoll æ¥ç­‰å¾…ä¸‹ä¸€æ¬¡æ—¶é—´äº‹ä»¶çš„è§¦å‘ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">maxfd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AE_TIME_EVENTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AE_DONT_WAIT</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">,</span> <span class="o">*</span><span class="n">tvp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* NULL means infinite wait. */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int64_t</span> <span class="n">usUntilTimer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">beforesleep</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AE_CALL_BEFORE_SLEEP</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* Before sleep callback. */</span>
</span></span><span class="line"><span class="cl">            <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="nf">beforesleep</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* eventLoop-&gt;flags å¯èƒ½ä¼šåœ¨ beforeSleep ä¸­å‘ç”Ÿæ”¹å˜ï¼Œæ‰€ä»¥éœ€è¦åœ¨è°ƒç”¨ beforeSleep åé‡æ–°æ£€æŸ¥
</span></span></span><span class="line"><span class="cl"><span class="cm">		   åŒæ—¶ï¼Œflags å‚æ•°ä¼˜å…ˆçº§æ›´é«˜ï¼Œç‰¹åˆ«æ˜¯ AE_DONT_WAIT è®¾ç½®æ—¶ï¼Œåº”å¿½ç•¥ eventLoop-&gt;flags ä¸­çš„å€¼ */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AE_DONT_WAIT</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AE_DONT_WAIT</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="n">tv</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">tvp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tv</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AE_TIME_EVENTS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">usUntilTimer</span> <span class="o">=</span> <span class="nf">usUntilEarliestTimer</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">usUntilTimer</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="n">usUntilTimer</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">tv</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="n">usUntilTimer</span> <span class="o">%</span> <span class="mi">1000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">tvp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tv</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* è°ƒç”¨aeApiPollå¤šè·¯å¤ç”¨æ–¹æ³•ï¼ŒCall the multiplexing API, will return only on timeout or when some event fires. */</span>
</span></span><span class="line"><span class="cl">        <span class="n">numevents</span> <span class="o">=</span> <span class="nf">aeApiPoll</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">,</span> <span class="n">tvp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* å¦‚æœæ²¡æœ‰è¯·æ±‚å¤„ç†æ–‡ä»¶äº‹ä»¶ï¼Œå°±è·³è¿‡æ–‡ä»¶äº‹ä»¶çš„å¤„ç† */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AE_FILE_EVENTS</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">numevents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* After sleep callback. */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">aftersleep</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AE_CALL_AFTER_SLEEP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="nf">aftersleep</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">numevents</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">fired</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">aeFileEvent</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">fd</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">fired</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">fired</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Number of events fired for current fd. */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="cm">/* é»˜è®¤æƒ…å†µä¸‹ï¼Œå…ˆæ‰§è¡Œå¯è¯»äº‹ä»¶ï¼Œå†æ‰§è¡Œå¯å†™äº‹ä»¶ã€‚è¿™ä¸ªé¡ºåºå¯ä»¥ç¡®ä¿æœ‰å¯è¯»æ•°æ®æ—¶ï¼Œä¼˜å…ˆå¤„ç†è¯»å–è¯·æ±‚ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">             * å¦‚æœè®¾ç½®äº† AE_BARRIER æ ‡å¿—ï¼Œåˆ™è¡¨ç¤ºæˆ‘ä»¬å¸Œæœ›åè½¬æ‰§è¡Œé¡ºåºï¼Œå…ˆæ‰§è¡Œå¯å†™äº‹ä»¶ã€‚ */</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">invert</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AE_BARRIER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="cm">/* æ£€æŸ¥äº‹ä»¶æ˜¯å¦ä»ç„¶æœ‰æ•ˆï¼šå¯èƒ½å·²ç»å¤„ç†è¿‡çš„äº‹ä»¶åœ¨å½“å‰å›åˆä¸­å·²ç»è¢«ç§»é™¤ */</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">invert</span> <span class="o">&amp;&amp;</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AE_READABLE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">fe</span><span class="o">-&gt;</span><span class="nf">rfileProc</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">,</span><span class="n">fd</span><span class="p">,</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">clientData</span><span class="p">,</span><span class="n">mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">fired</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">fe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">fd</span><span class="p">];</span> <span class="cm">/* Refresh in case of resize. */</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="cm">/* æ‰§è¡Œå¯å†™äº‹ä»¶ */</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AE_WRITABLE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fired</span> <span class="o">||</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">wfileProc</span> <span class="o">!=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">rfileProc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">fe</span><span class="o">-&gt;</span><span class="nf">wfileProc</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">,</span><span class="n">fd</span><span class="p">,</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">clientData</span><span class="p">,</span><span class="n">mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">fired</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">             <span class="cm">/* å¦‚æœéœ€è¦åè½¬æ‰§è¡Œé¡ºåºï¼Œåœ¨å¯å†™äº‹ä»¶åæ‰§è¡Œå¯è¯»äº‹ä»¶ */</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">fe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">fd</span><span class="p">];</span> <span class="cm">/* Refresh in case of resize. */</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">((</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AE_READABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="o">!</span><span class="n">fired</span> <span class="o">||</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">wfileProc</span> <span class="o">!=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">rfileProc</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">fe</span><span class="o">-&gt;</span><span class="nf">rfileProc</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">,</span><span class="n">fd</span><span class="p">,</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">clientData</span><span class="p">,</span><span class="n">mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">fired</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">processed</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* å¦‚æœéœ€è¦å¤„ç†æ—¶é—´äº‹ä»¶ï¼Œåˆ™ç»§ç»­å¤„ç†æ—¶é—´äº‹ä»¶ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AE_TIME_EVENTS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">processed</span> <span class="o">+=</span> <span class="nf">processTimeEvents</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">processed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="å¤šè·¯å¤ç”¨å¤„ç†æ–¹æ³•ç±»ä¼¼nettyä¸­çš„handlerå®ç°">å¤šè·¯å¤ç”¨å¤„ç†æ–¹æ³•ï¼ˆç±»ä¼¼nettyä¸­çš„handlerå®ç°ï¼‰
</h3><ol start="7">
<li>åè®®è§£æï¼šcreateClient -&gt; readQueryFromClient -&gt; processInputBuffer -&gt; processXXXBuffer -&gt; processCommandAndResetClient
<ul>
<li>inlineï¼šprocessInlineBuffer</li>
<li>multiï¼šprocessMultibulkBuffer</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">readQueryFromClient</span><span class="p">(</span><span class="n">connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">client</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="nf">connGetPrivateData</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">nread</span><span class="p">,</span> <span class="n">big_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">size_t</span> <span class="n">qblen</span><span class="p">,</span> <span class="n">readlen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* å¦‚æœå¯ç”¨äº†çº¿ç¨‹åŒ– I/Oï¼Œå¹¶ä¸”éœ€è¦åœ¨é€€å‡ºäº‹ä»¶å¾ªç¯æ—¶ç¨åè¯»å–å®¢æˆ·ç«¯æ•°æ® */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">postponeClientRead</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* æ›´æ–°æœåŠ¡å™¨çš„æ€»è¯»å–æ¬¡æ•° */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">atomicIncr</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">stat_total_reads_processed</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">readlen</span> <span class="o">=</span> <span class="n">PROTO_IOBUF_LEN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="cm">/* å¦‚æœè¿™æ˜¯ä¸€ä¸ªå¤šæ‰¹é‡è¯·æ±‚ï¼Œå¹¶ä¸”æ­£åœ¨å¤„ç†ä¸€ä¸ªè¾ƒå¤§çš„æ‰¹é‡å›å¤ï¼Œå°½é‡ç¡®ä¿æŸ¥è¯¢ç¼“å†²åŒº
</span></span></span><span class="line"><span class="cl"><span class="cm">     * ç²¾ç¡®åŒ…å«è¡¨ç¤ºå¯¹è±¡çš„ SDS å­—ç¬¦ä¸²ï¼Œå³ä½¿è¿™å¯èƒ½ä¼šå¯¼è‡´æ›´å¤šçš„ read(2) è°ƒç”¨ã€‚ 
</span></span></span><span class="line"><span class="cl"><span class="cm">     * è¿™æ ·ï¼Œå‡½æ•° processMultiBulkBuffer() å¯ä»¥é¿å…å¤åˆ¶ç¼“å†²åŒºæ¥åˆ›å»º Redis å¯¹è±¡ã€‚ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">reqtype</span> <span class="o">==</span> <span class="n">PROTO_REQ_MULTIBULK</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">multibulklen</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bulklen</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bulklen</span> <span class="o">&gt;=</span> <span class="n">PROTO_MBULK_BIG_ARG</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* å¯¹äºå¤§çš„å‚æ•°ï¼Œå®¢æˆ·ç«¯æ€»æ˜¯ä½¿ç”¨å…¶ç§æœ‰çš„æŸ¥è¯¢ç¼“å†²åŒºã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">         * ä½¿ç”¨å¯é‡ç”¨çš„æŸ¥è¯¢ç¼“å†²åŒºå¯èƒ½ä¼šå¯¼è‡´å…¶è¶…å‡º 32kï¼Œæœ€ç»ˆè®©å®¢æˆ·ç«¯æ¥ç®¡è¿™ä¸ªç¼“å†²åŒºã€‚ */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">)</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">=</span> <span class="nf">sdsempty</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">ssize_t</span> <span class="n">remaining</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bulklen</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">)</span><span class="o">-</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">big_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* æ³¨æ„ï¼š&#39;remaining&#39; å˜é‡åœ¨æŸäº›è¾¹ç¼˜æƒ…å†µä¸‹å¯èƒ½ä¸ºé›¶ï¼Œä¾‹å¦‚å½“åœ¨ CLIENT PAUSE åæ¢å¤è¢«é˜»å¡çš„å®¢æˆ·ç«¯æ—¶ */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">remaining</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">readlen</span> <span class="o">=</span> <span class="n">remaining</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* å¦‚æœæ˜¯ä¸»å®¢æˆ·ç«¯ï¼Œåœ¨é‡åˆ°å¤§å‚æ•°æ—¶éœ€è¦æ‰©å¤§è¯»å–é•¿åº¦ï¼Œä½†ä¸éœ€è¦å¯¹é½åˆ°ä¸‹ä¸€ä¸ªå‚æ•°ï¼Œå¯ä»¥è¯»å–æ›´å¤šæ•°æ® */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_MASTER</span> <span class="o">&amp;&amp;</span> <span class="n">readlen</span> <span class="o">&lt;</span> <span class="n">PROTO_IOBUF_LEN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">readlen</span> <span class="o">=</span> <span class="n">PROTO_IOBUF_LEN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="n">thread_reusable_qb_used</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* å¦‚æœå¯é‡ç”¨çš„æŸ¥è¯¢ç¼“å†²åŒºå·²è¢«å…¶ä»–å®¢æˆ·ç«¯ä½¿ç”¨ï¼Œåˆ‡æ¢åˆ°ä½¿ç”¨å®¢æˆ·ç«¯çš„ç§æœ‰æŸ¥è¯¢ç¼“å†²åŒºã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">             * è¿™ç§æƒ…å†µä»…åœ¨é€šè¿‡ processEventsWhileBlocked() æ‰§è¡ŒåµŒå¥—å‘½ä»¤æ—¶å‘ç”Ÿã€‚ */</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">=</span> <span class="nf">sdsnewlen</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">PROTO_IOBUF_LEN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">sdsclear</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* å¦‚æœæŸ¥è¯¢ç¼“å†²åŒºä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºå¯é‡ç”¨çš„æŸ¥è¯¢ç¼“å†²åŒº */</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">thread_reusable_qb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">thread_reusable_qb</span> <span class="o">=</span> <span class="nf">sdsnewlen</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">PROTO_IOBUF_LEN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">sdsclear</span><span class="p">(</span><span class="n">thread_reusable_qb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="cm">/* å°†å¯é‡ç”¨çš„æŸ¥è¯¢ç¼“å†²åŒºåˆ†é…ç»™å®¢æˆ·ç«¯ï¼Œå¹¶æ ‡è®°ä¸ºæ­£åœ¨ä½¿ç”¨ */</span>
</span></span><span class="line"><span class="cl">            <span class="nf">serverAssert</span><span class="p">(</span><span class="nf">sdslen</span><span class="p">(</span><span class="n">thread_reusable_qb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">=</span> <span class="n">thread_reusable_qb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CLIENT_REUSABLE_QUERYBUFFER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">thread_reusable_qb_used</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">qblen</span> <span class="o">=</span> <span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_MASTER</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="c1">// ä¸»å®¢æˆ·ç«¯çš„æŸ¥è¯¢ç¼“å†²åŒºå¯ä»¥è´ªå©ªæ‰©å±•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="n">big_arg</span> <span class="o">||</span> <span class="nf">sdsalloc</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">PROTO_IOBUF_LEN</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* åœ¨è¯»å–å¤§å‚æ•°æ—¶ï¼Œæˆ‘ä»¬ä¸ä¼šè¯»å–è¶…è¿‡ä¸€ä¸ªå‚æ•°çš„å†…å®¹åˆ°æŸ¥è¯¢ç¼“å†²åŒºï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">         * æ‰€ä»¥ä¸éœ€è¦é¢„åˆ†é…å¤šäºæ‰€éœ€çš„ç©ºé—´ï¼Œå› æ­¤ä½¿ç”¨éè´ªå©ªæ‰©å±•ã€‚ */</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">=</span> <span class="nf">sdsMakeRoomForNonGreedy</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">,</span> <span class="n">readlen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* ç¨åå°†å³°å€¼è®¾ç½®ä¸ºå·²ä½¿ç”¨çš„éƒ¨åˆ†ï¼Œä½†è¿™é‡Œæˆ‘ä»¬è¿‡åº¦åˆ†é…ï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“éœ€è¦çš„ç©ºé—´ï¼Œç¡®ä¿åœ¨ä½¿ç”¨å‰ä¸ä¼šè¢«ç¼©å°ã€‚ */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf_peak</span> <span class="o">&lt;</span> <span class="n">qblen</span> <span class="o">+</span> <span class="n">readlen</span><span class="p">)</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf_peak</span> <span class="o">=</span> <span class="n">qblen</span> <span class="o">+</span> <span class="n">readlen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">=</span> <span class="nf">sdsMakeRoomFor</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">,</span> <span class="n">readlen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* ä»å¥—æ¥å­—ä¸­å°½å¯èƒ½å¤šåœ°è¯»å–æ•°æ®ï¼Œä»¥èŠ‚çœ read(2) ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°ã€‚ */</span>
</span></span><span class="line"><span class="cl">        <span class="n">readlen</span> <span class="o">=</span> <span class="nf">sdsavail</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">nread</span> <span class="o">=</span> <span class="nf">connRead</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="o">+</span><span class="n">qblen</span><span class="p">,</span> <span class="n">readlen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">nread</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">connGetState</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="o">==</span> <span class="n">CONN_STATE_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">serverLog</span><span class="p">(</span><span class="n">LL_VERBOSE</span><span class="p">,</span> <span class="s">&#34;ä»å®¢æˆ·ç«¯è¯»å–æ•°æ®æ—¶å‡ºé”™: %s&#34;</span><span class="p">,</span> <span class="nf">connGetLastError</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="nf">freeClientAsync</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nread</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">verbosity</span> <span class="o">&lt;=</span> <span class="n">LL_VERBOSE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">sds</span> <span class="n">info</span> <span class="o">=</span> <span class="nf">catClientInfoString</span><span class="p">(</span><span class="nf">sdsempty</span><span class="p">(),</span> <span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">serverLog</span><span class="p">(</span><span class="n">LL_VERBOSE</span><span class="p">,</span> <span class="s">&#34;å®¢æˆ·ç«¯å…³é—­äº†è¿æ¥ %s&#34;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">sdsfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">freeClientAsync</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* æ›´æ–°æŸ¥è¯¢ç¼“å†²åŒºçš„é•¿åº¦ */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sdsIncrLen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">,</span> <span class="n">nread</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">qblen</span> <span class="o">=</span> <span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf_peak</span> <span class="o">&lt;</span> <span class="n">qblen</span><span class="p">)</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf_peak</span> <span class="o">=</span> <span class="n">qblen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* æ›´æ–°æœ€åäº¤äº’æ—¶é—´ */</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span><span class="o">-&gt;</span><span class="n">lastinteraction</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">unixtime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_MASTER</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="o">-&gt;</span><span class="n">read_reploff</span> <span class="o">+=</span> <span class="n">nread</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">atomicIncr</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">stat_net_repl_input_bytes</span><span class="p">,</span> <span class="n">nread</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">atomicIncr</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">stat_net_input_bytes</span><span class="p">,</span> <span class="n">nread</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* å¯¹äºæ™®é€šå®¢æˆ·ç«¯ï¼Œå¦‚æœæŸ¥è¯¢ç¼“å†²åŒºçš„å¤§å°è¶…è¿‡é™åˆ¶æˆ–éœ€è¦èº«ä»½éªŒè¯ï¼Œåˆ™å…³é—­å®¢æˆ·ç«¯è¿æ¥ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_MASTER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* MULTI/EXEC é˜Ÿåˆ—ä¸­çš„å‘½ä»¤å°šæœªæ‰§è¡Œï¼Œå› æ­¤å®ƒä»¬ä¹Ÿç®—ä½œæŸ¥è¯¢ç¼“å†²åŒºçš„ä¸€éƒ¨åˆ† */</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mstate</span><span class="p">.</span><span class="n">argv_len_sums</span> <span class="o">+</span> <span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">server</span><span class="p">.</span><span class="n">client_max_querybuf_len</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mstate</span><span class="p">.</span><span class="n">argv_len_sums</span> <span class="o">+</span> <span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span> <span class="o">&amp;&amp;</span> <span class="nf">authRequired</span><span class="p">(</span><span class="n">c</span><span class="p">))))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">sds</span> <span class="n">ci</span> <span class="o">=</span> <span class="nf">catClientInfoString</span><span class="p">(</span><span class="nf">sdsempty</span><span class="p">(),</span><span class="n">c</span><span class="p">),</span> <span class="n">bytes</span> <span class="o">=</span> <span class="nf">sdsempty</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">bytes</span> <span class="o">=</span> <span class="nf">sdscatrepr</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">,</span><span class="mi">64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">serverLog</span><span class="p">(</span><span class="n">LL_WARNING</span><span class="p">,</span><span class="s">&#34;å…³é—­å®¢æˆ·ç«¯ï¼ŒæŸ¥è¯¢ç¼“å†²åŒºè¶…è¿‡æœ€å¤§é™åˆ¶: %s (æŸ¥è¯¢ç¼“å†²åŒºåˆå§‹å­—èŠ‚: %s)&#34;</span><span class="p">,</span> <span class="n">ci</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sdsfree</span><span class="p">(</span><span class="n">ci</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sdsfree</span><span class="p">(</span><span class="n">bytes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">freeClientAsync</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">atomicIncr</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">stat_client_qbuf_limit_disconnections</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* å¦‚æœå®¢æˆ·ç«¯è¾“å…¥ç¼“å†²åŒºè¿˜æœ‰æ•°æ®ï¼Œç»§ç»­è§£æå¹¶æ£€æŸ¥æ˜¯å¦æœ‰å®Œæ•´çš„å‘½ä»¤éœ€è¦æ‰§è¡Œ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">processInputBuffer</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="n">C_ERR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="n">c</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">done</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_REUSABLE_QUERYBUFFER</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">serverAssert</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* ç¡®ä¿å®¢æˆ·ç«¯çš„æŸ¥è¯¢ç¼“å†²åŒºåœ¨ processInputBuffer ä¸­è¢«ä¿®å‰ª */</span>
</span></span><span class="line"><span class="cl">        <span class="nf">resetReusableQueryBuf</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">beforeNextClient</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="processinputbufferè¯»å–clientè¯·æ±‚ä¿¡æ¯">processInputBufferè¯»å–clientè¯·æ±‚ä¿¡æ¯
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* è¯¥å‡½æ•°åœ¨æ¯æ¬¡å®¢æˆ·ç«¯ç»“æ„ä½“ &#39;c&#39; ä¸­æœ‰æ›´å¤šæŸ¥è¯¢ç¼“å†²åŒºéœ€è¦å¤„ç†æ—¶è¢«è°ƒç”¨ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm"> * å¯èƒ½æ˜¯å› ä¸ºæˆ‘ä»¬ä»å¥—æ¥å­—è¯»å–äº†æ›´å¤šçš„æ•°æ®ï¼Œæˆ–è€…å®¢æˆ·ç«¯è¢«é˜»å¡å¹¶åœ¨ä¹‹åé‡æ–°æ¿€æ´»ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm"> * æ‰€ä»¥å¯èƒ½å­˜åœ¨å¾…å¤„ç†çš„æŸ¥è¯¢ç¼“å†²åŒºï¼Œè¿™äº›ç¼“å†²åŒºå¯èƒ½å·²ç»ä»£è¡¨ä¸€ä¸ªå®Œæ•´çš„å‘½ä»¤éœ€è¦å¤„ç†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> * å¦‚æœåœ¨å¤„ç†è¿‡ç¨‹ä¸­å®¢æˆ·ç«¯å·²ç»è¢«é‡Šæ”¾ï¼Œåˆ™è¿”å› C_ERR */</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">processInputBuffer</span><span class="p">(</span><span class="n">client</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* å½“è¾“å…¥ç¼“å†²åŒºæœ‰å†…å®¹æ—¶ï¼Œç»§ç»­å¤„ç† */</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">&lt;</span> <span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* å¦‚æœå®¢æˆ·ç«¯å½“å‰è¢«é˜»å¡ï¼Œç«‹å³ä¸­æ­¢ */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_BLOCKED</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* å¦‚æœå®¢æˆ·ç«¯æœ‰å¾…å¤„ç†çš„å‘½ä»¤ï¼Œä¸è¦ç»§ç»­å¤„ç†æ›´å¤šçš„ç¼“å†²åŒº */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_PENDING_COMMAND</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* å¦‚æœå®¢æˆ·ç«¯æ˜¯ä¸»å®¢æˆ·ç«¯ï¼Œå¹¶ä¸”å½“å‰æœ‰å¿™ç¢Œè„šæœ¬ï¼Œæš‚åœå¤„ç†è¾“å…¥ */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">isInsideYieldingLongCommand</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_MASTER</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* å¦‚æœè®¾ç½®äº† CLIENT_CLOSE_AFTER_REPLY æ ‡å¿—ï¼Œå¤„ç†å®Œå›å¤åå°±å…³é—­è¿æ¥ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">         * ä¸å…è®¸ç»§ç»­å¤„ç†æ›´å¤šçš„å‘½ä»¤ */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CLIENT_CLOSE_AFTER_REPLY</span><span class="o">|</span><span class="n">CLIENT_CLOSE_ASAP</span><span class="p">))</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* å¦‚æœè¯·æ±‚ç±»å‹æœªçŸ¥ï¼Œåˆ¤æ–­è¯·æ±‚ç±»å‹ */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">reqtype</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;*&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">c</span><span class="o">-&gt;</span><span class="n">reqtype</span> <span class="o">=</span> <span class="n">PROTO_REQ_MULTIBULK</span><span class="p">;</span>  <span class="c1">// å¤šæ‰¹é‡è¯·æ±‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">c</span><span class="o">-&gt;</span><span class="n">reqtype</span> <span class="o">=</span> <span class="n">PROTO_REQ_INLINE</span><span class="p">;</span>  <span class="c1">// å•è¡Œå‘½ä»¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* æ ¹æ®è¯·æ±‚ç±»å‹å¤„ç†ç¼“å†²åŒº */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">reqtype</span> <span class="o">==</span> <span class="n">PROTO_REQ_INLINE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nf">processInlineBuffer</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">!=</span> <span class="n">C_OK</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>  <span class="c1">// å¤„ç†å•è¡Œå‘½ä»¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">reqtype</span> <span class="o">==</span> <span class="n">PROTO_REQ_MULTIBULK</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nf">processMultibulkBuffer</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">!=</span> <span class="n">C_OK</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>  <span class="c1">// å¤„ç†å¤šæ‰¹é‡å‘½ä»¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">serverPanic</span><span class="p">(</span><span class="s">&#34;Unknown request type&#34;</span><span class="p">);</span>  <span class="c1">// æœªçŸ¥çš„è¯·æ±‚ç±»å‹ï¼Œç¨‹åºå´©æºƒ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* å¤šæ‰¹é‡è¯·æ±‚å¤„ç†å¯èƒ½å¯¼è‡´ argc &lt;= 0 */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">resetClientInternal</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>  <span class="c1">// å¦‚æœæ²¡æœ‰æœ‰æ•ˆçš„å‚æ•°ï¼Œé‡ç½®å®¢æˆ·ç«¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* å¦‚æœæ˜¯ I/O çº¿ç¨‹ä¸Šä¸‹æ–‡ï¼Œä¸èƒ½åœ¨æ­¤æ‰§è¡Œå‘½ä»¤ï¼Œåªèƒ½æ ‡è®°å®¢æˆ·ç«¯éœ€è¦å¤„ç†å‘½ä»¤ */</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">io_threads_op</span> <span class="o">!=</span> <span class="n">IO_THREADS_OP_IDLE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">serverAssert</span><span class="p">(</span><span class="n">io_threads_op</span> <span class="o">==</span> <span class="n">IO_THREADS_OP_READ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CLIENT_PENDING_COMMAND</span><span class="p">;</span>  <span class="c1">// è®¾ç½®ä¸ºå¾…å¤„ç†å‘½ä»¤çŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="cm">/* å‡†å¤‡å¥½æ‰§è¡Œå‘½ä»¤äº† */</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nf">processCommandAndResetClient</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="n">C_ERR</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="cm">/* å¦‚æœå®¢æˆ·ç«¯å·²ç»ä¸å†æœ‰æ•ˆï¼Œé¿å…ç»§ç»­æ‰§è¡Œï¼Œç›´æ¥è¿”å› */</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* å¦‚æœå®¢æˆ·ç«¯æ˜¯ä¸»å®¢æˆ·ç«¯ï¼Œéœ€è¦è£å‰ªæŸ¥è¯¢ç¼“å†²åŒº */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_MASTER</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* å¦‚æœå®¢æˆ·ç«¯æ˜¯ä¸»å®¢æˆ·ç«¯ï¼Œè£å‰ªæŸ¥è¯¢ç¼“å†²åŒºåˆ° repl_applied æŒ‡å®šçš„ä½ç½®ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">         * å› ä¸ºä¸»å®¢æˆ·ç«¯çš„æŸ¥è¯¢ç¼“å†²åŒºä¸ä»…ç”¨äºè§£æå‘½ä»¤ï¼Œè¿˜ç”¨äºä»£ç†ç»™å­å¤åˆ¶å®ä¾‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         * éœ€è¦è£å‰ªæŸ¥è¯¢ç¼“å†²åŒºçš„åœºæ™¯ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 1. æ²¡æœ‰æ¥æ”¶åˆ°å®Œæ•´çš„å‘½ä»¤
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 2. ä¸»å®¢æˆ·ç«¯å› ä¸ºå®¢æˆ·ç«¯æš‚åœè€Œè¢«é˜»å¡
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 3. I/O çº¿ç¨‹æ“ä½œè¯»å–ï¼Œä¸»å®¢æˆ·ç«¯è¢«æ ‡è®°ä¸º CLIENT_PENDING_COMMAND
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         * åœ¨è¿™äº›åœºæ™¯ä¸‹ï¼Œqb_pos æŒ‡å‘å½“å‰å‘½ä»¤çš„ä¸€éƒ¨åˆ†æˆ–ä¸‹ä¸€ä¸ªå‘½ä»¤çš„å¼€å§‹ä½ç½®ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">         * å½“å‰å‘½ä»¤å°šæœªåº”ç”¨ï¼Œå› æ­¤ repl_applied ä¸ç­‰äº qb_posã€‚*/</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">repl_applied</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">sdsrange</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">repl_applied</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>  <span class="c1">// å‰©ä½™çš„å‘½ä»¤æ•°æ®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">-=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">repl_applied</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span><span class="o">-&gt;</span><span class="n">repl_applied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* å¦‚æœå®¢æˆ·ç«¯ä¸æ˜¯ä¸»å®¢æˆ·ç«¯ï¼Œè£å‰ªæŸ¥è¯¢ç¼“å†²åŒº */</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sdsrange</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>  <span class="c1">// å°†æŸ¥è¯¢ç¼“å†²åŒºè£å‰ªåˆ°å½“å‰ä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// é‡ç½®æŸ¥è¯¢ç¼“å†²åŒºä½ç½®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* åœ¨å¤„ç†æŸ¥è¯¢ç¼“å†²åŒºåæ›´æ–°å®¢æˆ·ç«¯çš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">     * è¿™å¯¹æŸ¥è¯¢ç¼“å†²åŒºæ¯”è¾ƒå¤§ä¸”æ²¡æœ‰åœ¨ä¸Šè¿°å¾ªç¯ä¸­è¢«å®Œå…¨å¤„ç†çš„å®¢æˆ·ç«¯å¾ˆé‡è¦ï¼ˆ
</span></span></span><span class="line"><span class="cl"><span class="cm">     * ä¾‹å¦‚éƒ¨åˆ†å‘é€çš„å¤§å‘½ä»¤ï¼‰ã€‚*/</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">io_threads_op</span> <span class="o">==</span> <span class="n">IO_THREADS_OP_IDLE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">updateClientMemUsageAndBucket</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">C_OK</span><span class="p">;</span>  <span class="c1">// è¿”å›å¤„ç†æˆåŠŸ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="åè®®è§£æ">åè®®è§£æ
</h4><ul>
<li>processInlineBufferï¼šset a bè¿™æ ·çš„ç®€å•å‘½ä»¤</li>
<li>processMultibulkBufferï¼šmset a b c dè¿™æ ·çš„å¤åˆå‘½ä»¤</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* ç±»ä¼¼äº processMultibulkBuffer()ï¼Œä½†æ˜¯ç”¨äºå¤„ç† inline åè®®ï¼Œè€Œä¸æ˜¯ RESP åè®®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> * è¯¥å‡½æ•°æ¶ˆè€—å®¢æˆ·ç«¯çš„æŸ¥è¯¢ç¼“å†²åŒºï¼Œå¹¶åœ¨å®¢æˆ·ç«¯ç»“æ„ä½“ä¸­åˆ›å»ºä¸€ä¸ªå‡†å¤‡æ‰§è¡Œçš„å‘½ä»¤ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> * å¦‚æœå‘½ä»¤å·²ç»å‡†å¤‡å¥½æ‰§è¡Œï¼Œåˆ™è¿”å› C_OKï¼›å¦‚æœä»ç„¶éœ€è¦è¯»å–æ›´å¤šåè®®æ•°æ®æ‰èƒ½å½¢æˆä¸€ä¸ªæœ‰æ•ˆçš„å‘½ä»¤ï¼Œåˆ™è¿”å› C_ERRã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> * å½“å‡ºç°åè®®é”™è¯¯æ—¶ï¼Œè¿”å› C_ERRï¼›åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯ç»“æ„ä½“ä¼šè¢«è®¾ç½®ä¸ºå›å¤é”™è¯¯å¹¶å…³é—­è¿æ¥ã€‚ */</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">processInlineBuffer</span><span class="p">(</span><span class="n">client</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">newline</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">linefeed_chars</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">sds</span> <span class="o">*</span><span class="n">argv</span><span class="p">,</span> <span class="n">aux</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">size_t</span> <span class="n">querylen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* æŸ¥æ‰¾æ¢è¡Œç¬¦çš„ä½ç½® */</span>
</span></span><span class="line"><span class="cl">    <span class="n">newline</span> <span class="o">=</span> <span class="nf">strchr</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* å¦‚æœæ²¡æœ‰æ‰¾åˆ° \r\n åˆ™è¿”å›ï¼Œä¸åšå¤„ç† */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">newline</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">)</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">&gt;</span> <span class="n">PROTO_INLINE_MAX_SIZE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">addReplyError</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&#34;Protocol error: too big inline request&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">setProtocolError</span><span class="p">(</span><span class="s">&#34;too big inline request&#34;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* å¤„ç† \r\n çš„æƒ…å†µ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">newline</span> <span class="o">!=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">newline</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;\r&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">newline</span><span class="o">--</span><span class="p">;</span>  <span class="c1">// å°† newline æŒ‡å‘ \r çš„å‰ä¸€ä¸ªå­—ç¬¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">linefeed_chars</span><span class="o">++</span><span class="p">;</span>  <span class="c1">// è®¡ç®—æ¢è¡Œç¬¦çš„å­—ç¬¦æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* æˆªå–ä»å½“å‰æŒ‡é’ˆåˆ° \r\n ä¹‹é—´çš„å†…å®¹ */</span>
</span></span><span class="line"><span class="cl">    <span class="n">querylen</span> <span class="o">=</span> <span class="n">newline</span> <span class="o">-</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">aux</span> <span class="o">=</span> <span class="nf">sdsnewlen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">,</span> <span class="n">querylen</span><span class="p">);</span>  <span class="c1">// åˆ›å»ºä¸€ä¸ªæ–°çš„ sds å­—ç¬¦ä¸²
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">argv</span> <span class="o">=</span> <span class="nf">sdssplitargs</span><span class="p">(</span><span class="n">aux</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argc</span><span class="p">);</span>  <span class="c1">// åˆ†å‰²å‘½ä»¤è¡Œå‚æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">sdsfree</span><span class="p">(</span><span class="n">aux</span><span class="p">);</span>  <span class="c1">// é‡Šæ”¾ä¸´æ—¶å˜é‡ aux
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">argv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">addReplyError</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&#34;Protocol error: unbalanced quotes in request&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">setProtocolError</span><span class="p">(</span><span class="s">&#34;unbalanced quotes in inline request&#34;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* å¦‚æœæŸ¥è¯¢é•¿åº¦ä¸º 0 ä¸”å®¢æˆ·ç«¯æ˜¯ä»å±èŠ‚ç‚¹ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">     * åˆ™è¡¨ç¤ºé€šè¿‡æ¢è¡Œç¬¦åˆ·æ–°æœ€åçš„ ACK æ—¶é—´ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">     * è¿™æ˜¯ä¸ºäº†è®©ä»å±èŠ‚ç‚¹åœ¨åŠ è½½å¤§å‹ RDB æ–‡ä»¶æ—¶èƒ½å¤ŸæŒç»­ä¿æŒè¿æ¥ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">querylen</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nf">clientTypeIsSlave</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="o">-&gt;</span><span class="n">repl_ack_time</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">unixtime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* ä¸»èŠ‚ç‚¹ä¸åº”è¯¥å‘é€ inline åè®®æ¥æ‰§è¡Œå®é™…çš„å‘½ä»¤ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">     * å¦‚æœå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œå¯èƒ½æ˜¯ Redis åè®®å‡ºç°äº†åŒæ­¥é—®é¢˜ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">     * æ¯”å¦‚ç”±äº PSYNC å‡ºé”™å¯¼è‡´çš„åè®®ä¸ä¸€è‡´ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * ä½†æ˜¯æœ‰ä¸€ä¸ªä¾‹å¤–ï¼šä¸»èŠ‚ç‚¹å¯èƒ½åªä¼šå‘é€ä¸€ä¸ªæ¢è¡Œç¬¦æ¥ä¿æŒè¿æ¥æ´»åŠ¨ã€‚ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">querylen</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_MASTER</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sdsfreesplitres</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="n">argc</span><span class="p">);</span>  <span class="c1">// é‡Šæ”¾å‚æ•°æ•°ç»„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">serverLog</span><span class="p">(</span><span class="n">LL_WARNING</span><span class="p">,</span> <span class="s">&#34;WARNING: Receiving inline protocol from master, master stream corruption? Closing the master connection and discarding the cached master.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">setProtocolError</span><span class="p">(</span><span class="s">&#34;Master using the inline protocol. Desync?&#34;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* ç§»åŠ¨æŸ¥è¯¢ç¼“å†²åŒºä½ç½®ï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªæŸ¥è¯¢å‘½ä»¤ */</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">+=</span> <span class="n">querylen</span> <span class="o">+</span> <span class="n">linefeed_chars</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* åœ¨å®¢æˆ·ç«¯ç»“æ„ä½“ä¸­è®¾ç½® argv æ•°ç»„ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* å¦‚æœå‚æ•°æ•°é‡è¶…è¿‡å½“å‰åˆ†é…çš„ç©ºé—´ï¼Œé‡æ–°åˆ†é…å†…å­˜ */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">zfree</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">);</span>  <span class="c1">// é‡Šæ”¾æ—§çš„ argv
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span> <span class="o">=</span> <span class="nf">zmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">robj</span><span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">argc</span><span class="p">);</span>  <span class="c1">// åˆ†é…æ–°çš„ argv æ•°ç»„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len</span> <span class="o">=</span> <span class="n">argc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len_sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// é‡ç½®å‚æ•°é•¿åº¦æ€»å’Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* ä¸ºæ‰€æœ‰çš„å‚æ•°åˆ›å»º Redis å¯¹è±¡ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">]</span> <span class="o">=</span> <span class="nf">createObject</span><span class="p">(</span><span class="n">OBJ_STRING</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>  <span class="c1">// åˆ›å»ºå­—ç¬¦ä¸²ç±»å‹çš„ Redis å¯¹è±¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">c</span><span class="o">-&gt;</span><span class="n">argc</span><span class="o">++</span><span class="p">;</span>  <span class="c1">// å¢åŠ å‚æ•°è®¡æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len_sum</span> <span class="o">+=</span> <span class="nf">sdslen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>  <span class="c1">// æ›´æ–°å‚æ•°æ€»é•¿åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">zfree</span><span class="p">(</span><span class="n">argv</span><span class="p">);</span>  <span class="c1">// é‡Šæ”¾ä¸´æ—¶åˆ†å‰²åçš„å‚æ•°æ•°ç»„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">C_OK</span><span class="p">;</span>  <span class="c1">// è¿”å›å‘½ä»¤å·²å‡†å¤‡å¥½æ‰§è¡Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* å¤„ç†å®¢æˆ·ç«¯ &#39;c&#39; çš„æŸ¥è¯¢ç¼“å†²åŒºï¼Œå¹¶ä¸ºå‘½ä»¤æ‰§è¡Œè®¾ç½®å®¢æˆ·ç«¯çš„å‚æ•°å‘é‡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> * å¦‚æœå®¢æˆ·ç«¯æœ‰ä¸€ä¸ªæ ¼å¼æ­£ç¡®ã€å‡†å¤‡æ‰§è¡Œçš„å‘½ä»¤ï¼Œè¿”å› C_OKï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm"> * å¦åˆ™ï¼Œå¦‚æœè¿˜éœ€è¦æ›´å¤šçš„æ•°æ®æ‰èƒ½è·å¾—å®Œæ•´çš„å‘½ä»¤ï¼Œè¿”å› C_ERRã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> * å¦‚æœå‡ºç°åè®®é”™è¯¯ï¼Œè¿”å› C_ERRï¼›åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯ç»“æ„ä¼šè¢«è®¾ç½®ä¸ºå›å¤é”™è¯¯å¹¶å…³é—­è¿æ¥ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * å½“ processInputBuffer() æ£€æµ‹åˆ°ä¸‹ä¸€ä¸ªå‘½ä»¤æ˜¯ RESP æ ¼å¼æ—¶ä¼šè°ƒç”¨æ­¤å‡½æ•°ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm"> * å› ä¸ºå‘½ä»¤çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯ &#39;*&#39;ã€‚å¦åˆ™ï¼Œå¯¹äº inline å‘½ä»¤ä¼šè°ƒç”¨ processInlineBuffer()ã€‚*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">processMultibulkBuffer</span><span class="p">(</span><span class="n">client</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">newline</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="kt">long</span> <span class="n">ll</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">multibulklen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* å®¢æˆ·ç«¯åº”è¯¥å·²ç»è¢«é‡ç½® */</span>
</span></span><span class="line"><span class="cl">        <span class="nf">serverAssertWithInfo</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* å¤šé‡æ‰¹é‡é•¿åº¦ä¸èƒ½åœ¨æ²¡æœ‰ \r\n çš„æƒ…å†µä¸‹è¯»å– */</span>
</span></span><span class="line"><span class="cl">        <span class="n">newline</span> <span class="o">=</span> <span class="nf">strchr</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">,</span> <span class="sc">&#39;\r&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">newline</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">)</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">&gt;</span> <span class="n">PROTO_INLINE_MAX_SIZE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">addReplyError</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&#34;Protocol error: too big mbulk count string&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">setProtocolError</span><span class="p">(</span><span class="s">&#34;too big mbulk count string&#34;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* ç¼“å†²åŒºä¸­åº”ä¹ŸåŒ…å« \n */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">newline</span> <span class="o">-</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)(</span><span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">)</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* ç¡®å®šè¿™æ˜¯ä¸€æ•´è¡Œï¼Œå› ä¸º newline != NULLï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">         * æ‰€ä»¥å¯ä»¥ç»§ç»­è§£æå¤šé‡æ‰¹é‡é•¿åº¦ */</span>
</span></span><span class="line"><span class="cl">        <span class="nf">serverAssertWithInfo</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;*&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ok</span> <span class="o">=</span> <span class="nf">string2ll</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">,</span> <span class="n">newline</span> <span class="o">-</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ll</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span> <span class="o">||</span> <span class="n">ll</span> <span class="o">&gt;</span> <span class="n">INT_MAX</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">addReplyError</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&#34;Protocol error: invalid multibulk length&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">setProtocolError</span><span class="p">(</span><span class="s">&#34;invalid mbulk count&#34;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ll</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="nf">authRequired</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">addReplyError</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&#34;Protocol error: unauthenticated multibulk length&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">setProtocolError</span><span class="p">(</span><span class="s">&#34;unauth mbulk count&#34;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">newline</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">ll</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">C_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="o">-&gt;</span><span class="n">multibulklen</span> <span class="o">=</span> <span class="n">ll</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* åœ¨å®¢æˆ·ç«¯ç»“æ„ä½“ä¸­è®¾ç½® argv æ•°ç»„ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">         * å¦‚æœç©ºé—´ä¸è¶³æˆ–è€…éœ€è¦é€æ­¥åˆ†é…ç©ºé—´ï¼Œåˆ›å»ºæ–°çš„ argv */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">multibulklen</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">multibulklen</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">zfree</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">multibulklen</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span> <span class="o">=</span> <span class="nf">zmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">robj</span><span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len_sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">serverAssertWithInfo</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">multibulklen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">multibulklen</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* å¦‚æœæœªçŸ¥ï¼Œè¯»å–æ‰¹é‡é•¿åº¦ */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bulklen</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">newline</span> <span class="o">=</span> <span class="nf">strchr</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">,</span> <span class="sc">&#39;\r&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">newline</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">)</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">&gt;</span> <span class="n">PROTO_INLINE_MAX_SIZE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">addReplyError</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&#34;Protocol error: too big bulk count string&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">setProtocolError</span><span class="p">(</span><span class="s">&#34;too big bulk count string&#34;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="cm">/* ç¼“å†²åŒºä¸­ä¹Ÿåº”è¯¥åŒ…å« \n */</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">newline</span> <span class="o">-</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)(</span><span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">)</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;$&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">addReplyErrorFormat</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&#34;Protocol error: expected &#39;$&#39;, got &#39;%c&#39;&#34;</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">setProtocolError</span><span class="p">(</span><span class="s">&#34;expected $ but got something else&#34;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">ok</span> <span class="o">=</span> <span class="nf">string2ll</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">newline</span> <span class="o">-</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ll</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span> <span class="o">||</span> <span class="n">ll</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_MASTER</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ll</span> <span class="o">&gt;</span> <span class="n">server</span><span class="p">.</span><span class="n">proto_max_bulk_len</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">addReplyError</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&#34;Protocol error: invalid bulk length&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">setProtocolError</span><span class="p">(</span><span class="s">&#34;invalid bulk length&#34;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ll</span> <span class="o">&gt;</span> <span class="mi">16384</span> <span class="o">&amp;&amp;</span> <span class="nf">authRequired</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">addReplyError</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&#34;Protocol error: unauthenticated bulk length&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">setProtocolError</span><span class="p">(</span><span class="s">&#34;unauth bulk length&#34;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">=</span> <span class="n">newline</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_MASTER</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ll</span> <span class="o">&gt;=</span> <span class="n">PROTO_MBULK_BIG_ARG</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="cm">/* å¦‚æœå®¢æˆ·ç«¯ä¸æ˜¯ä¸»èŠ‚ç‚¹ï¼ˆå› ä¸ºä¸»èŠ‚ç‚¹çš„æŸ¥è¯¢ç¼“å†²åŒºåªèƒ½åœ¨æ•°æ®åº”ç”¨å¹¶å‘é€ç»™ä»èŠ‚ç‚¹åä¿®å‰ªï¼‰ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">                 *
</span></span></span><span class="line"><span class="cl"><span class="cm">                 * å¦‚æœæˆ‘ä»¬å°†ä»ç½‘ç»œè¯»å–ä¸€ä¸ªè¾ƒå¤§çš„å¯¹è±¡ï¼Œå°è¯•ä½¿å…¶ä» c-&gt;querybuf è¾¹ç•Œå¼€å§‹ï¼Œè¿™æ ·å¯ä»¥ä¼˜åŒ–å¯¹è±¡åˆ›å»ºï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">                 * é¿å…å¯¹æ•°æ®è¿›è¡Œå¤§é‡å¤åˆ¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">                 *
</span></span></span><span class="line"><span class="cl"><span class="cm">                 * ä½†æ˜¯åªæœ‰å½“æœªè§£æçš„æ•°æ®é•¿åº¦å°äºæˆ–ç­‰äº ll+2 æ—¶æ‰è¿™æ ·åšã€‚å¦åˆ™ï¼Œä¿®å‰ªæŸ¥è¯¢ç¼“å†²åŒºå°±æ˜¯æµªè´¹æ—¶é—´ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">                 * å› ä¸ºæ­¤æ—¶æŸ¥è¯¢ç¼“å†²åŒºä¸ä»…ä»…åŒ…å«æˆ‘ä»¬çš„å¤§æ‰¹é‡æ•°æ®ã€‚ */</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">)</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">ll</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">sdsrange</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/* æç¤º sds åº“æœ‰å…³å­—ç¬¦ä¸²é•¿åº¦çš„é¢„æœŸ */</span>
</span></span><span class="line"><span class="cl">                    <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">=</span> <span class="nf">sdsMakeRoomForNonGreedy</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">,</span> <span class="n">ll</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">-</span> <span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/* æˆ‘ä»¬åç»­ä¼šè®¾ç½®å³°å€¼ä¸ºä½¿ç”¨çš„éƒ¨åˆ†ï¼Œä½†æ­¤æ—¶è¶…é¢åˆ†é…æ˜¯ä¸ºäº†ç¡®ä¿ä¸ä¼šåœ¨ä½¿ç”¨å‰è¢«ç¼©å° */</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf_peak</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">ll</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf_peak</span> <span class="o">=</span> <span class="n">ll</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span><span class="o">-&gt;</span><span class="n">bulklen</span> <span class="o">=</span> <span class="n">ll</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* è¯»å–æ‰¹é‡å‚æ•° */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">)</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bulklen</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* æ•°æ®ä¸è¶³ï¼ˆ+2 æ˜¯æŒ‡å°¾éƒ¨çš„ \r\nï¼‰ */</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç©ºé—´å­˜å‚¨å‚æ•°ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿›è¡Œæ‰©å±• */</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">&gt;=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len</span> <span class="o">&lt;</span> <span class="n">INT_MAX</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">?</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">:</span> <span class="n">INT_MAX</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">multibulklen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span> <span class="o">=</span> <span class="nf">zrealloc</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">robj</span><span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="cm">/* ä¼˜åŒ–ï¼šå¦‚æœéä¸»èŠ‚ç‚¹å®¢æˆ·ç«¯çš„ç¼“å†²åŒºä»…åŒ…å«æˆ‘ä»¬çš„æ‰¹é‡å…ƒç´ ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">             * é‚£ä¹ˆç›´æ¥ä½¿ç”¨å½“å‰çš„ sds å­—ç¬¦ä¸²è€Œä¸æ˜¯é€šè¿‡å¤åˆ¶åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ */</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_MASTER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                <span class="n">c</span><span class="o">-&gt;</span><span class="n">bulklen</span> <span class="o">&gt;=</span> <span class="n">PROTO_MBULK_BIG_ARG</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                <span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bulklen</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argc</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nf">createObject</span><span class="p">(</span><span class="n">OBJ_STRING</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len_sum</span> <span class="o">+=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bulklen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nf">sdsIncrLen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">);</span> <span class="cm">/* å»é™¤ CRLF */</span>
</span></span><span class="line"><span class="cl">                <span class="cm">/* å‡è®¾å¦‚æœæˆ‘ä»¬çœ‹åˆ°ä¸€ä¸ªå¤§çš„å‚æ•°ï¼Œæ¥ä¸‹æ¥å¯èƒ½ä¼šçœ‹åˆ°å¦ä¸€ä¸ªç±»ä¼¼çš„ */</span>
</span></span><span class="line"><span class="cl">                <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">=</span> <span class="nf">sdsnewlen</span><span class="p">(</span><span class="n">SDS_NOINIT</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bulklen</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">sdsclear</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argc</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">createStringObject</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bulklen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len_sum</span> <span class="o">+=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bulklen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">+=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bulklen</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span><span class="o">-&gt;</span><span class="n">bulklen</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span><span class="o">-&gt;</span><span class="n">multibulklen</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* å½“ c-&gt;multibulklen ä¸º 0 æ—¶ï¼Œè¡¨ç¤ºå‘½ä»¤å¤„ç†å®Œæˆ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">multibulklen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">C_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* ä»ç„¶æ²¡æœ‰å‡†å¤‡å¥½å¤„ç†å‘½ä»¤ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="processcommandå¤„ç†å‘½ä»¤">processCommandå¤„ç†å‘½ä»¤
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* è¿™ä¸ªå‡½æ•°è°ƒç”¨ processCommand()ï¼ŒåŒæ—¶æ‰§è¡Œä¸€äº›å¯¹äºå®¢æˆ·ç«¯æ¥è¯´æœ‰ç”¨çš„é¢å¤–ä»»åŠ¡ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 1. å°†å½“å‰å®¢æˆ·ç«¯è®¾ç½®ä¸º &#39;c&#39;ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 2. å¦‚æœå‘½ä»¤å·²å¤„ç†ï¼Œåˆ™è°ƒç”¨ commandProcessed()ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * å¦‚æœå¤„ç†å‘½ä»¤è¿‡ç¨‹ä¸­å®¢æˆ·ç«¯è¢«é‡Šæ”¾ï¼Œåˆ™è¿”å› C_ERRï¼Œå¦åˆ™è¿”å› C_OKã€‚ */</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">processCommandAndResetClient</span><span class="p">(</span><span class="n">client</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">deadclient</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">client</span> <span class="o">*</span><span class="n">old_client</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">current_client</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// è®¾ç½®å½“å‰å¤„ç†çš„å®¢æˆ·ç«¯ä¸º &#39;c&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">server</span><span class="p">.</span><span class="n">current_client</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// å¤„ç†å‘½ä»¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nf">processCommand</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="n">C_OK</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœå‘½ä»¤æˆåŠŸå¤„ç†ï¼Œè°ƒç”¨ commandProcessed()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">commandProcessed</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// æ›´æ–°å®¢æˆ·ç«¯çš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œè€ƒè™‘åˆ°å‘½ä»¤æ‰§è¡Œåå¯èƒ½å¯¼è‡´è¾“å‡ºç¼“å†²åŒºçš„å¢é•¿
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">)</span> <span class="nf">updateClientMemUsageAndBucket</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// æ£€æŸ¥å½“å‰å®¢æˆ·ç«¯æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºè¡¨ç¤ºå®¢æˆ·ç«¯å·²ç»è¢«é‡Šæ”¾
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">current_client</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="n">deadclient</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">     * æ¢å¤ä¹‹å‰çš„å®¢æˆ·ç«¯è®¾ç½®ã€‚è¿™ä¸ªæ¢å¤æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºåœ¨è„šæœ¬è¶…æ—¶çš„æƒ…å†µä¸‹ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">     * æˆ‘ä»¬ä¼šä» processEventsWhileBlocked ä¸­è¿›å…¥è¯¥ä»£ç ï¼Œè¿™ä¼šå¯¼è‡´è®¾ç½® server.current_clientã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">     * å¦‚æœä¸æ¢å¤ï¼Œå¯èƒ½ä¼šé”™è¯¯åœ°è¿”å› 1ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯å·²ç»æ­»æ‰ï¼Œå¹¶åœæ­¢ä»å®¢æˆ·ç«¯ç¼“å†²åŒºè¯»å–æ•°æ®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="p">.</span><span class="n">current_client</span> <span class="o">=</span> <span class="n">old_client</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// performEvictions å¯èƒ½ä¼šåˆ·æ–°ä»èŠ‚ç‚¹çš„è¾“å‡ºç¼“å†²åŒºï¼Œè¿™å¯èƒ½å¯¼è‡´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä»èŠ‚ç‚¹ï¼ˆå¯èƒ½æ˜¯å½“å‰æ´»åŠ¨çš„å®¢æˆ·ç«¯ï¼‰è¢«é‡Šæ”¾ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">deadclient</span> <span class="o">?</span> <span class="nl">C_ERR</span> <span class="p">:</span> <span class="n">C_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="8">
<li>è¿”å›å†™å…¥çš„respç»™clientï¼šinitServer -&gt; aeSetBeforeSleepProc -&gt; beforeSleep -&gt; handleClientsWithPendingWritesUsingThreads -&gt; sendReplyToClient</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* å°†æ•°æ®å†™å…¥å®¢æˆ·ç«¯çš„è¾“å‡ºç¼“å†²åŒºã€‚å¦‚æœå®¢æˆ·ç«¯åœ¨è°ƒç”¨åä»ç„¶æœ‰æ•ˆï¼Œè¿”å› C_OKï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm"> * å¦‚æœå› é”™è¯¯è€Œè¢«é‡Šæ”¾ï¼Œè¿”å› C_ERRã€‚å¦‚æœè®¾ç½®äº† handler_installedï¼Œåˆ™ä¼šå°è¯•æ¸…é™¤å†™äº‹ä»¶ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * è¯¥å‡½æ•°ç”±çº¿ç¨‹è°ƒç”¨ï¼Œä½†æ€»æ˜¯å°† handler_installed è®¾ç½®ä¸º 0ã€‚å› æ­¤ï¼Œå½“ handler_installed è®¾ç½®ä¸º 0 æ—¶ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm"> * è¯¥å‡½æ•°å¿…é¡»æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">writeToClient</span><span class="p">(</span><span class="n">client</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">handler_installed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* æ›´æ–°æœåŠ¡å™¨çš„æ€»å†™å…¥æ¬¡æ•° */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">atomicIncr</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">stat_total_writes_processed</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">ssize_t</span> <span class="n">nwritten</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">totwritten</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* å¾ªç¯å†™å…¥å®¢æˆ·ç«¯çš„å¾…å¤„ç†å›å¤ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="nf">clientHasPendingReplies</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">_writeToClient</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nwritten</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">C_ERR</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">totwritten</span> <span class="o">+=</span> <span class="n">nwritten</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* æ³¨æ„ï¼šæˆ‘ä»¬é¿å…ä¸€æ¬¡å†™å…¥è¶…è¿‡ NET_MAX_WRITES_PER_EVENT å­—èŠ‚ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">         * åœ¨å•çº¿ç¨‹æœåŠ¡å™¨ä¸­ï¼Œå³ä½¿æ¥è‡ªè¶…é«˜é€Ÿé“¾æ¥çš„å¤§è¯·æ±‚æ€»æ˜¯èƒ½æ¥å—æ•°æ®ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">         * ä¹Ÿåº”è¯¥æœåŠ¡å…¶ä»–å®¢æˆ·ç«¯ï¼ˆåœ¨å®é™…åœºæ™¯ä¸­å¯ä»¥è€ƒè™‘ &#39;KEYS *&#39; å‘½ä»¤é€šè¿‡å›ç¯æ¥å£ï¼‰ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         * ç„¶è€Œï¼Œå¦‚æœè¶…å‡ºäº†æœ€å¤§å†…å­˜é™åˆ¶ï¼Œæˆ‘ä»¬ä¼šå¿½ç•¥æ­¤é™åˆ¶ï¼Œå°½å¯èƒ½åœ°å‘é€æ•°æ®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         * æ­¤å¤–ï¼Œå¦‚æœå®¢æˆ·ç«¯æ˜¯ä»èŠ‚ç‚¹æˆ–ç›‘è§†å™¨ï¼Œæˆ‘ä»¬ä¼šå°½å¯èƒ½å¤šåœ°å‘é€æ•°æ®ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">         * å¦åˆ™ï¼Œåœ¨é«˜é€Ÿæµé‡ä¸‹ï¼Œå¤åˆ¶/è¾“å‡ºç¼“å†²åŒºå¯èƒ½ä¼šæ— é™å¢é•¿ã€‚*/</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">totwritten</span> <span class="o">&gt;</span> <span class="n">NET_MAX_WRITES_PER_EVENT</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">maxmemory</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">             <span class="nf">zmalloc_used_memory</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">server</span><span class="p">.</span><span class="n">maxmemory</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">            <span class="o">!</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_SLAVE</span><span class="p">))</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼Œè®°å½•å·²ç»å‘é€çš„å­—èŠ‚æ•° */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="nf">clientTypeIsSlave</span><span class="p">(</span><span class="n">c</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">atomicIncr</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">stat_net_repl_output_bytes</span><span class="p">,</span> <span class="n">totwritten</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">atomicIncr</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">stat_net_output_bytes</span><span class="p">,</span> <span class="n">totwritten</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* æ£€æŸ¥å†™å…¥æ˜¯å¦æˆåŠŸ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">nwritten</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">connGetState</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CONN_STATE_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">serverLog</span><span class="p">(</span><span class="n">LL_VERBOSE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;Error writing to client: %s&#34;</span><span class="p">,</span> <span class="nf">connGetLastError</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="nf">freeClientAsync</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* å¦‚æœæœ‰æ•°æ®å†™å…¥ï¼Œæ›´æ–°å®¢æˆ·ç«¯çš„æœ€åäº¤äº’æ—¶é—´ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">totwritten</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* å¯¹äºè¡¨ç¤ºä¸»èŠ‚ç‚¹çš„å®¢æˆ·ç«¯ï¼Œä¸è®¡ç®—å‘é€æ•°æ®ä½œä¸ºä¸€æ¬¡äº¤äº’ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">         * å› ä¸ºæˆ‘ä»¬æ€»æ˜¯å‘é€ REPLCONF ACK å‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤åªå ç”¨ä¸€äº›æ—¶é—´æ¥å¡«å……å¥—æ¥å­—è¾“å‡ºç¼“å†²åŒºã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">         * æˆ‘ä»¬ä»…ä¾èµ–æ¥æ”¶åˆ°çš„æ•°æ®æˆ– ping å‘½ä»¤æ¥æ£€æµ‹è¶…æ—¶ã€‚ */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_MASTER</span><span class="p">))</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lastinteraction</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">unixtime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* å¦‚æœå®¢æˆ·ç«¯æ²¡æœ‰å¾…å¤„ç†çš„å›å¤ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">clientHasPendingReplies</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="o">-&gt;</span><span class="n">sentlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* è¯·æ³¨æ„ï¼ŒwriteToClient() æ˜¯åœ¨çº¿ç¨‹ä¸­è°ƒç”¨çš„ï¼Œä½† aeDeleteFileEvent() ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm">         * ç„¶è€Œï¼Œç”±äº writeToClient() æ€»æ˜¯åœ¨çº¿ç¨‹ä¸­å°† handler_installed è®¾ç½®ä¸º 0ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="cm">         * æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ”¾å¿ƒã€‚*/</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">handler_installed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">serverAssert</span><span class="p">(</span><span class="n">io_threads_op</span> <span class="o">==</span> <span class="n">IO_THREADS_OP_IDLE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">connSetWriteHandler</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* åœ¨å‘é€å®Œæ•´å›å¤åå…³é—­è¿æ¥ã€‚ */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_CLOSE_AFTER_REPLY</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">freeClientAsync</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* åœ¨å†™å…¥æ•°æ®åæ›´æ–°å®¢æˆ·ç«¯çš„å†…å­˜ä½¿ç”¨æƒ…å†µã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">     * ç”±äºè¿™ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šæœ‰æ¡ä»¶åœ°æ‰§è¡Œæ­¤æ“ä½œã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">     * å¦‚æœæ˜¯å¤šçº¿ç¨‹å†™å…¥ï¼Œåˆ™å°†åœ¨ handleClientsWithPendingWritesUsingThreads() ä¸­å¤„ç†ã€‚*/</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">io_threads_op</span> <span class="o">==</span> <span class="n">IO_THREADS_OP_IDLE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">updateClientMemUsageAndBucket</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">C_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="å†…æ ¸å‡½æ•°åˆ†æ">å†…æ ¸å‡½æ•°åˆ†æ
</h2><p>docï¼šhttps://man7.org/linux/man-pages/man7/epoll.7.html</p>
<h3 id="epoll_create">epoll_create
</h3><p>int epoll_create(int size);</p>
<h4 id="å‚æ•°ä»‹ç»">å‚æ•°ä»‹ç»
</h4><p><strong>size</strong>ï¼šè¿™ä¸ªå‚æ•°æ˜¯å»ºè®®å€¼ï¼Œç”¨äºæŒ‡å®šå†…éƒ¨äº‹ä»¶æ•°ç»„çš„å¤§å°ã€‚å®é™…åº”ç”¨ä¸­ï¼Œè¿™ä¸ªå€¼ä¸€èˆ¬å¯ä»¥ä¼ å…¥ä¸€ä¸ªåˆé€‚çš„å€¼ï¼Œ<code>epoll</code> å†…éƒ¨ä¼šæ ¹æ®æ“ä½œç³»ç»Ÿçš„èƒ½åŠ›æ¥åˆ†é…å†…å­˜ã€‚æ­¤å‚æ•°å·²ç»åœ¨ Linux 2.6.8 ä¸­è¢«åºŸå¼ƒï¼Œå¹¶ä¸”æ²¡æœ‰å®é™…æ„ä¹‰ï¼Œä½†ä¸ºäº†å…¼å®¹ï¼Œä¾ç„¶å­˜åœ¨ã€‚</p>
<h4 id="è¿”å›å€¼">è¿”å›å€¼
</h4><p>fdæ–‡ä»¶æè¿°ç¬¦idã€‚</p>
<h3 id="epoll_ctl">epoll_ctl
</h3><p>int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event);</p>
<h4 id="å‚æ•°ä»‹ç»-1">å‚æ•°ä»‹ç»
</h4><p><strong>epfd</strong>ï¼šé€šè¿‡ <code>epoll_create</code> åˆ›å»ºçš„ epoll æ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<p><strong>op</strong>ï¼šæ“ä½œç±»å‹ï¼Œ<code>EPOLL_CTL_ADD</code>ã€<code>EPOLL_CTL_MOD</code> å’Œ <code>EPOLL_CTL_DEL</code> åˆ†åˆ«è¡¨ç¤ºæ·»åŠ ã€ä¿®æ”¹å’Œåˆ é™¤æ–‡ä»¶æè¿°ç¬¦çš„æ“ä½œã€‚</p>
<p><strong>fd</strong>ï¼šè¦ç›‘æ§çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<p><strong>event</strong>ï¼šæŒ‡å®šéœ€è¦ç›‘æ§çš„äº‹ä»¶ï¼Œç±»å‹ä¸º <code>struct epoll_event</code>ï¼Œå®ƒå®šä¹‰äº†æ„Ÿå…´è¶£çš„äº‹ä»¶ç±»å‹ï¼ˆå¦‚ <code>EPOLLIN</code>ã€<code>EPOLLOUT</code>ã€<code>EPOLLRDHUP</code> ç­‰ï¼‰ä»¥åŠä¸€ä¸ªç”¨æˆ·è‡ªå®šä¹‰æ•°æ®å­—æ®µã€‚</p>
<h4 id="è¿”å›å€¼-1">è¿”å›å€¼
</h4><p>0ï¼šæˆåŠŸ</p>
<p>-1ï¼šå¤±è´¥</p>
<h3 id="epoll_wait">epoll_wait
</h3><p>int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout);</p>
<h4 id="å‚æ•°ä»‹ç»-2">å‚æ•°ä»‹ç»
</h4><p><strong>epfd</strong>ï¼šé€šè¿‡ <code>epoll_create</code> åˆ›å»ºçš„ epoll æ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<p><strong>events</strong>ï¼šä¸€ä¸ªæ•°ç»„ï¼Œç”¨äºå­˜æ”¾è¿”å›çš„äº‹ä»¶ã€‚</p>
<p><strong>maxevents</strong>ï¼šæŒ‡å®šè¿”å›çš„æœ€å¤§äº‹ä»¶æ•°ã€‚å¦‚æœæœ‰æ›´å¤šçš„äº‹ä»¶å‘ç”Ÿï¼Œåˆ™éœ€è¦è°ƒç”¨å¤šæ¬¡ <code>epoll_wait</code>ã€‚</p>
<p><strong>timeout</strong>ï¼šç­‰å¾…æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ã€‚å¦‚æœè®¾ç½®ä¸º <code>-1</code>ï¼Œåˆ™ä¼šæ— é™æœŸé˜»å¡ï¼Œç›´åˆ°æœ‰äº‹ä»¶å‘ç”Ÿã€‚å¦‚æœè®¾ç½®ä¸º <code>0</code>ï¼Œåˆ™ç«‹åˆ»è¿”å›ï¼Œä¸ä¼šé˜»å¡ã€‚</p>
<h4 id="è¿”å›å€¼-2">è¿”å›å€¼
</h4><p>0ï¼šæˆåŠŸ</p>
<p>-1ï¼šå¤±è´¥</p>
<h3 id="è¾¹ç¼˜è§¦å‘--æ°´å¹³è§¦å‘">è¾¹ç¼˜è§¦å‘ &amp; æ°´å¹³è§¦å‘
</h3><ul>
<li>è¾¹ç¼˜è§¦å‘etï¼šçŠ¶æ€å‘ç”Ÿå˜æ›´æ‰é€šçŸ¥</li>
<li>æ°´å¹³è§¦å‘ltï¼šå¯è¯»/å†™åˆ™é€šçŸ¥</li>
</ul>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: left">ç‰¹æ€§</th>
          <th style="text-align: left">æ°´å¹³è§¦å‘ï¼ˆLTï¼‰</th>
          <th style="text-align: left">è¾¹ç¼˜è§¦å‘ï¼ˆETï¼‰</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">äº‹ä»¶é€šçŸ¥</td>
          <td style="text-align: left">ä¸€æ—¦æ»¡è¶³æ¡ä»¶å°±ä¼šæŒç»­é€šçŸ¥ï¼Œç›´åˆ°äº‹ä»¶è¢«å¤„ç†å®Œ</td>
          <td style="text-align: left">åªåœ¨çŠ¶æ€å˜åŒ–æ—¶é€šçŸ¥ä¸€æ¬¡ï¼Œåç»­ä¸å†é€šçŸ¥ï¼Œç›´åˆ°çŠ¶æ€å†æ¬¡å˜åŒ–</td>
      </tr>
      <tr>
          <td style="text-align: left">äº‹ä»¶ç±»å‹</td>
          <td style="text-align: left">å½“æ–‡ä»¶æè¿°ç¬¦çš„çŠ¶æ€ç¬¦åˆæ¡ä»¶æ—¶ï¼ˆä¾‹å¦‚ï¼Œæœ‰æ•°æ®å¯è¯»ï¼‰ï¼Œä¼šæŒç»­è§¦å‘äº‹ä»¶ï¼Œç›´åˆ°æ¡ä»¶è¢«å¤„ç†</td>
          <td style="text-align: left">åªä¼šåœ¨æ–‡ä»¶æè¿°ç¬¦çš„çŠ¶æ€ä»â€œæœªå°±ç»ªâ€å˜ä¸ºâ€œå°±ç»ªâ€æ—¶è§¦å‘ä¸€æ¬¡äº‹ä»¶</td>
      </tr>
      <tr>
          <td style="text-align: left">å¤„ç†è¦æ±‚</td>
          <td style="text-align: left">å¤„ç†ä¸€æ¬¡äº‹ä»¶åï¼Œå¯èƒ½ä¼šæœ‰æ›´å¤šçš„äº‹ä»¶ç»§ç»­è¢«é€šçŸ¥</td>
          <td style="text-align: left">å¤„ç†å®Œäº‹ä»¶åï¼Œå¿…é¡»å°½å¯èƒ½å¤šåœ°å¤„ç†æ•°æ®ï¼Œå¦åˆ™ä¼šé”™è¿‡åç»­äº‹ä»¶</td>
      </tr>
      <tr>
          <td style="text-align: left">é€‚ç”¨åœºæ™¯</td>
          <td style="text-align: left">é€‚åˆç®€å•åœºæ™¯ï¼Œå®¹æ˜“å¤„ç†</td>
          <td style="text-align: left">é€‚åˆé«˜å¹¶å‘å’Œé«˜æ€§èƒ½è¦æ±‚çš„åœºæ™¯ï¼Œå‡å°‘äº‹ä»¶é€šçŸ¥çš„æ¬¡æ•°</td>
      </tr>
  </tbody>
</table></div>
<h4 id="æ§åˆ¶">æ§åˆ¶
</h4><p>ç”±epoll_ctlæ³¨å†Œçš„event.eventsæ§åˆ¶ï¼Œ<strong>event</strong>ï¼šæŒ‡å®šéœ€è¦ç›‘æ§çš„äº‹ä»¶ï¼Œç±»å‹ä¸º <code>struct epoll_event</code>ï¼Œå®ƒå®šä¹‰äº†æ„Ÿå…´è¶£çš„äº‹ä»¶ç±»å‹ï¼ˆå¦‚ <code>EPOLLIN</code>ã€<code>EPOLLOUT</code>ã€<code>EPOLLRDHUP</code> ç­‰ï¼‰ä»¥åŠä¸€ä¸ªç”¨æˆ·è‡ªå®šä¹‰æ•°æ®å­—æ®µã€‚</p>
<p>å½“ä¼ å…¥äº‹ä»¶ç±»å‹EPOLLETæ—¶ï¼Œè¯¥fdä¸ºè¾¹ç¼˜è§¦å‘ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸ºæ°´å¹³è§¦å‘ã€‚</p>
<ul>
<li>å¯¹äºredisè€Œè¨€ï¼Œä½¿ç”¨çš„å‡ä¸ºæ°´å¹³è§¦å‘</li>
<li>nginxä¸­å­˜åœ¨è¾¹ç¼˜è§¦å‘çš„ä½¿ç”¨</li>
</ul>
<h3 id="epoll_waitå¦‚ä½•å®ç°ç­‰å¾…">epoll_waitå¦‚ä½•å®ç°ç­‰å¾…
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">ep_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">eventpoll</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">__user</span> <span class="o">*</span><span class="n">events</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		   <span class="kt">int</span> <span class="n">maxevents</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timespec64</span> <span class="o">*</span><span class="n">timeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">eavail</span><span class="p">,</span> <span class="n">timed_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">u64</span> <span class="n">slack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">wait_queue_entry_t</span> <span class="n">wait</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">ktime_t</span> <span class="n">expires</span><span class="p">,</span> <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">lockdep_assert_irqs_enabled</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// å¦‚æœæœ‰è¶…æ—¶æ—¶é—´ï¼Œå¹¶ä¸”ä¸ä¸ºé›¶ï¼Œåˆ™è½¬æ¢è¶…æ—¶æ—¶é—´ä¸ºktimeæ ¼å¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">timeout</span><span class="o">-&gt;</span><span class="n">tv_sec</span> <span class="o">|</span> <span class="n">timeout</span><span class="o">-&gt;</span><span class="n">tv_nsec</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">slack</span> <span class="o">=</span> <span class="nf">select_estimate_accuracy</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">to</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">expires</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="nf">timespec64_to_ktime</span><span class="p">(</span><span class="o">*</span><span class="n">timeout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// å¦‚æœè¶…æ—¶æ—¶é—´ä¸ºé›¶ï¼Œè¡¨ç¤ºéé˜»å¡æ“ä½œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">timed_out</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">eavail</span> <span class="o">=</span> <span class="nf">ep_events_available</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// å¦‚æœæœ‰äº‹ä»¶ï¼Œåˆ™å°†äº‹ä»¶å‘é€åˆ°ç”¨æˆ·ç©ºé—´
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="n">eavail</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">res</span> <span class="o">=</span> <span class="nf">ep_send_events</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">maxevents</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// å¦‚æœå‘é€æˆåŠŸï¼ŒæŒ‚èµ· NAPI ä¸­æ–­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="nf">ep_suspend_napi_irqs</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// å¦‚æœè¶…æ—¶æ ‡å¿—ä¸ºçœŸï¼Œç›´æ¥è¿”å›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="n">timed_out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// å¦‚æœæ²¡æœ‰äº‹ä»¶ï¼Œæ‰§è¡Œå¿™ç­‰å¾…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">eavail</span> <span class="o">=</span> <span class="nf">ep_busy_loop</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">timed_out</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">eavail</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// æ£€æŸ¥æ˜¯å¦æœ‰ä¿¡å·ä¸­æ–­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="nf">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// åˆå§‹åŒ–ç­‰å¾…é˜Ÿåˆ—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">init_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">wait</span><span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">ep_autoremove_wake_function</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// åŠ é”ï¼Œæ£€æŸ¥äº‹ä»¶æ˜¯å¦å¯ç”¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">write_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">__set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// å†æ¬¡æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">eavail</span> <span class="o">=</span> <span class="nf">ep_events_available</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eavail</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// å¦‚æœæ²¡æœ‰äº‹ä»¶ï¼ŒåŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nf">__add_wait_queue_exclusive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// å¦‚æœæ²¡æœ‰äº‹ä»¶ï¼Œè°ƒç”¨é«˜ç²¾åº¦å®šæ—¶å™¨è¿›è¡Œç­‰å¾…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eavail</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">timed_out</span> <span class="o">=</span> <span class="o">!</span><span class="nf">schedule_hrtimeout_range</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">slack</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">							      <span class="n">HRTIMER_MODE_ABS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// è®¾ç½®å½“å‰ä»»åŠ¡ä¸ºè¿è¡ŒçŠ¶æ€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">__set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// è¢«å”¤é†’åæ£€æŸ¥æ˜¯å¦æœ‰äº‹ä»¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">eavail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// å¦‚æœç­‰å¾…é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œç§»é™¤å½“å‰ç­‰å¾…æ¡ç›®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">list_empty_careful</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">.</span><span class="n">entry</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">write_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">timed_out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// å¦‚æœè¶…æ—¶ï¼Œåˆ™å†æ¬¡æ£€æŸ¥ç­‰å¾…é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="n">eavail</span> <span class="o">=</span> <span class="nf">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">.</span><span class="n">entry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤å½“å‰æ¡ç›®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nf">__remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="nf">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="æ€»ç»“">æ€»ç»“
</h4><p><strong>é˜»å¡å®ç°</strong>ï¼šå½“æ²¡æœ‰äº‹ä»¶å‘ç”Ÿä¸”è¶…æ—¶æ¡ä»¶ä¸º <code>-1</code> æ—¶ï¼Œ<code>ep_poll</code> ä¼šé€šè¿‡å°†å½“å‰è¿›ç¨‹åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­æ¥å®ç°é˜»å¡ï¼Œç›´åˆ°äº‹ä»¶å‘ç”Ÿæˆ–è€…è¶…æ—¶ã€‚</p>
<p><strong>å¿™ç­‰å¾…çš„ä½œç”¨</strong>ï¼šå¿™ç­‰å¾…æ˜¯åœ¨æ²¡æœ‰äº‹ä»¶çš„æƒ…å†µä¸‹ä¸æ–­è½®è¯¢æ£€æŸ¥äº‹ä»¶é˜Ÿåˆ—ï¼Œå¦‚æœæœ‰äº‹ä»¶ï¼Œåˆ™ç«‹å³å¤„ç†ã€‚å¦‚æœæ²¡æœ‰äº‹ä»¶ï¼Œåˆ™é¿å…è¿‡æ—©åœ°é˜»å¡ã€‚</p>
<p><strong>ç­‰å¾…é˜Ÿåˆ—çš„åŠ å…¥</strong>ï¼šåœ¨å¿™ç­‰å¾…æ£€æŸ¥ä¹‹åï¼Œ<code>ep_poll</code> ä¼šåœ¨ç¡®è®¤æ²¡æœ‰äº‹ä»¶ä¸”æ²¡æœ‰è¶…æ—¶æ—¶ï¼Œå°†è¿›ç¨‹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ã€‚ç­‰å¾…é˜Ÿåˆ—ä¿è¯äº†è¿›ç¨‹å¯ä»¥è¢«æŒ‚èµ·ï¼Œç›´åˆ°æœ‰äº‹ä»¶å‘ç”Ÿæˆ–è€…è¶…æ—¶ã€‚</p>
<h4 id="ä¸€ç›´æ²¡æœ‰äº‹ä»¶å‘ç”Ÿçš„ä¾‹å­">ä¸€ç›´æ²¡æœ‰äº‹ä»¶å‘ç”Ÿçš„ä¾‹å­
</h4><p><strong>æ²¡æœ‰äº‹ä»¶çš„æƒ…å†µä¸‹ï¼Œ<code>eavail</code> ä¼šæŒç»­ä¸º <code>0</code>ã€‚</strong></p>
<ul>
<li>ep_events_availableï¼Œè¿”å›0ï¼Œå½“ <code>eavail == 0</code> æ—¶ï¼Œä»£ç ä¼šå…ˆè¿›å…¥å¿™ç­‰å¾…é˜¶æ®µï¼Œå¹¶å°è¯•é‡æ–°æ£€æŸ¥æ˜¯å¦æœ‰äº‹ä»¶ã€‚
<ul>
<li>é¿å…ç›´æ¥è¿›å…¥é˜»å¡ï¼Œæé«˜æ‰§è¡Œæ•ˆç‡ï¼ˆç±»ä¼¼jvmä¸­å…ˆè½»é‡çº§casé”ï¼Œæ»¡è¶³ä¸€å®šæ¡ä»¶åå†å‡çº§ä¸ºä¾èµ–osçš„é‡é”ï¼‰</li>
</ul>
</li>
<li>å¦‚æœç»è¿‡å¿™ç­‰å¾…ä»ç„¶æ²¡æœ‰äº‹ä»¶ï¼Œep_busy_loopè¿”å›0ï¼Œæ­¤æ—¶ <code>eavail == 0</code> ï¼Œ<code>epoll</code> ä¼šè¿›å…¥ç­‰å¾…é˜Ÿåˆ—å¹¶é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°äº‹ä»¶å‘ç”Ÿã€‚</li>
<li>å½“è¿›ç¨‹è¢«å”¤é†’åï¼Œ<code>eavail</code> è¢«å¼ºåˆ¶è®¾ç½®ä¸º <code>1</code>ï¼Œè¡¨ç¤ºè¿›å…¥ä¸‹ä¸€è½®äº‹ä»¶çš„å¤„ç†ã€‚</li>
</ul>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI&#43;WdtXRGWt2kTvGFasHpSy3SV"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG&#43;vnGctmUb0ZY0l8"crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"integrity="sha384-&#43;VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4&#43;/RRE05"crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.body, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>
    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/zh-cn/p/%E9%AB%98%E6%80%A7%E8%83%BD%E9%AB%98%E5%8F%AF%E7%94%A8-reids-%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4/">
        
        

        <div class="article-details">
            <h2 class="article-title">é«˜æ€§èƒ½&amp;é«˜å¯ç”¨ reids-åˆ†å¸ƒå¼é›†ç¾¤</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/zh-cn/p/%E9%AB%98%E6%80%A7%E8%83%BD-reids-%E5%86%85%E5%AD%98%E6%95%88%E7%8E%87/">
        
        

        <div class="article-details">
            <h2 class="article-title">é«˜æ€§èƒ½ reids-å†…å­˜æ•ˆç‡</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/zh-cn/p/%E6%9D%83%E9%99%90%E8%AE%BE%E8%AE%A1-%E9%89%B4%E6%9D%83%E6%8E%88%E6%9D%83/">
        
        

        <div class="article-details">
            <h2 class="article-title">æƒé™è®¾è®¡-é‰´æƒæˆæƒ</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/zh-cn/p/%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6-orm-spring/">
        
        

        <div class="article-details">
            <h2 class="article-title">å¼€å‘æ¡†æ¶-orm-spring</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/zh-cn/p/%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6-aop-spring/">
        
        

        <div class="article-details">
            <h2 class="article-title">å¼€å‘æ¡†æ¶-aop-spring</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "hugo-theme-stack" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            1998 - 
        
        2024 yuwenxin
    </section>
    
    <section class="powerby">
        
            welcome to wenxin-blog <br/>
        ä½¿ç”¨ <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> æ„å»º <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.27.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
