<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="Âü∫‰∫éÊ∫êÁ†ÅÂàÜÊûêredisÁöÑÈ´òÊÄßËÉΩÈÄö‰ø°Êê≠Âª∫Ôºå‰ª•Âèä‰ΩøÁî®epollÂÅöioÂ§öË∑ØÂ§çÁî®ÁöÑÊµÅÁ®ã">
<title>È´òÊÄßËÉΩ reids-ÈÄö‰ø°</title>

<link rel='canonical' href='https://wencynyu.github.io/zh-cn/p/%E9%AB%98%E6%80%A7%E8%83%BD-reids-%E9%80%9A%E4%BF%A1/'>

<link rel="stylesheet" href="/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css"><meta property='og:title' content="È´òÊÄßËÉΩ reids-ÈÄö‰ø°">
<meta property='og:description' content="Âü∫‰∫éÊ∫êÁ†ÅÂàÜÊûêredisÁöÑÈ´òÊÄßËÉΩÈÄö‰ø°Êê≠Âª∫Ôºå‰ª•Âèä‰ΩøÁî®epollÂÅöioÂ§öË∑ØÂ§çÁî®ÁöÑÊµÅÁ®ã">
<meta property='og:url' content='https://wencynyu.github.io/zh-cn/p/%E9%AB%98%E6%80%A7%E8%83%BD-reids-%E9%80%9A%E4%BF%A1/'>
<meta property='og:site_name' content='wenxin-blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2024-11-20T03:44:33&#43;08:00'/><meta property='article:modified_time' content='2024-11-20T03:44:33&#43;08:00'/>
<meta name="twitter:title" content="È´òÊÄßËÉΩ reids-ÈÄö‰ø°">
<meta name="twitter:description" content="Âü∫‰∫éÊ∫êÁ†ÅÂàÜÊûêredisÁöÑÈ´òÊÄßËÉΩÈÄö‰ø°Êê≠Âª∫Ôºå‰ª•Âèä‰ΩøÁî®epollÂÅöioÂ§öË∑ØÂ§çÁî®ÁöÑÊµÅÁ®ã">
    <link rel="shortcut icon" href="/favicon.png" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="ÂàáÊç¢ËèúÂçï">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/zh-cn/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu897059592634026878.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">üç•</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/zh-cn">wenxin-blog</a></h1>
            <h2 class="site-description">There are some programing and life blog by wenxin.</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/wencynyu'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/zh-cn/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>‰∏ªÈ°µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/zh-cn/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>ÂΩíÊ°£</span>
            </a>
        </li>
        
        
        <li >
            <a href='/zh-cn/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/zh-cn/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                    
                        <li id="i18n-switch">  
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                            <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                                
                                    <option value="https://wencynyu.github.io/en/" >English</option>
                                
                                    <option value="https://wencynyu.github.io/zh-cn/" selected>‰∏≠Êñá</option>
                                
                            </select>
                        </li>
                    
                

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>ÊöóËâ≤Ê®°Âºè</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ÁõÆÂΩï</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#Ê∫êÁ†ÅÂàÜÊûê">Ê∫êÁ†ÅÂàÜÊûê</a>
      <ol>
        <li><a href="#Á≥ªÁªüÂàùÂßãÂåñ--eventloop‰∫ã‰ª∂Âæ™ÁéØÊÄªÁ∫øÊûÑÂª∫">Á≥ªÁªüÂàùÂßãÂåñ &amp; eventloop‰∫ã‰ª∂Âæ™ÁéØÊÄªÁ∫øÊûÑÂª∫</a></li>
        <li><a href="#Â§öË∑ØÂ§çÁî®Â§ÑÁêÜÊñπÊ≥ïÁ±ª‰ººnetty‰∏≠ÁöÑhandlerÂÆûÁé∞">Â§öË∑ØÂ§çÁî®Â§ÑÁêÜÊñπÊ≥ïÔºàÁ±ª‰ººnetty‰∏≠ÁöÑhandlerÂÆûÁé∞Ôºâ</a>
          <ol>
            <li><a href="#processinputbufferËØªÂèñclientËØ∑Ê±Ç‰ø°ÊÅØ">processInputBufferËØªÂèñclientËØ∑Ê±Ç‰ø°ÊÅØ</a></li>
            <li><a href="#ÂçèËÆÆËß£Êûê">ÂçèËÆÆËß£Êûê</a></li>
            <li><a href="#processcommandÂ§ÑÁêÜÂëΩ‰ª§">processCommandÂ§ÑÁêÜÂëΩ‰ª§</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#ÂÜÖÊ†∏ÂáΩÊï∞ÂàÜÊûê">ÂÜÖÊ†∏ÂáΩÊï∞ÂàÜÊûê</a>
      <ol>
        <li><a href="#epoll_create">epoll_create</a>
          <ol>
            <li><a href="#ÂèÇÊï∞‰ªãÁªç">ÂèÇÊï∞‰ªãÁªç</a></li>
            <li><a href="#ËøîÂõûÂÄº">ËøîÂõûÂÄº</a></li>
          </ol>
        </li>
        <li><a href="#epoll_ctl">epoll_ctl</a>
          <ol>
            <li><a href="#ÂèÇÊï∞‰ªãÁªç-1">ÂèÇÊï∞‰ªãÁªç</a></li>
            <li><a href="#ËøîÂõûÂÄº-1">ËøîÂõûÂÄº</a></li>
          </ol>
        </li>
        <li><a href="#epoll_wait">epoll_wait</a>
          <ol>
            <li><a href="#ÂèÇÊï∞‰ªãÁªç-2">ÂèÇÊï∞‰ªãÁªç</a></li>
            <li><a href="#ËøîÂõûÂÄº-2">ËøîÂõûÂÄº</a></li>
          </ol>
        </li>
        <li><a href="#ËæπÁºòËß¶Âèë--Ê∞¥Âπ≥Ëß¶Âèë">ËæπÁºòËß¶Âèë &amp; Ê∞¥Âπ≥Ëß¶Âèë</a>
          <ol>
            <li><a href="#ÊéßÂà∂">ÊéßÂà∂</a></li>
          </ol>
        </li>
        <li><a href="#epoll_waitÂ¶Ç‰ΩïÂÆûÁé∞Á≠âÂæÖ">epoll_waitÂ¶Ç‰ΩïÂÆûÁé∞Á≠âÂæÖ</a>
          <ol>
            <li><a href="#ÊÄªÁªì">ÊÄªÁªì</a></li>
            <li><a href="#‰∏ÄÁõ¥Ê≤°Êúâ‰∫ã‰ª∂ÂèëÁîüÁöÑ‰æãÂ≠ê">‰∏ÄÁõ¥Ê≤°Êúâ‰∫ã‰ª∂ÂèëÁîüÁöÑ‰æãÂ≠ê</a></li>
          </ol>
        </li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/zh-cn/categories/%E5%90%8E%E7%AB%AF/" >
                ÂêéÁ´Ø
            </a>
        
            <a href="/zh-cn/categories/nosql/" >
                NoSql
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/zh-cn/p/%E9%AB%98%E6%80%A7%E8%83%BD-reids-%E9%80%9A%E4%BF%A1/">È´òÊÄßËÉΩ reids-ÈÄö‰ø°</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            Âü∫‰∫éÊ∫êÁ†ÅÂàÜÊûêredisÁöÑÈ´òÊÄßËÉΩÈÄö‰ø°Êê≠Âª∫Ôºå‰ª•Âèä‰ΩøÁî®epollÂÅöioÂ§öË∑ØÂ§çÁî®ÁöÑÊµÅÁ®ã
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Nov 20, 2024</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    ÈòÖËØªÊó∂Èïø: 25 ÂàÜÈíü
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="redisÈÄö‰ø°">redisÈÄö‰ø°
</h1><h2 id="Ê∫êÁ†ÅÂàÜÊûê">Ê∫êÁ†ÅÂàÜÊûê
</h2><h3 id="Á≥ªÁªüÂàùÂßãÂåñ--eventloop‰∫ã‰ª∂Âæ™ÁéØÊÄªÁ∫øÊûÑÂª∫">Á≥ªÁªüÂàùÂßãÂåñ &amp; eventloop‰∫ã‰ª∂Âæ™ÁéØÊÄªÁ∫øÊûÑÂª∫
</h3><ol>
<li>‰ªémainÂáΩÊï∞ËØ¥Ëµ∑ÔºàÂéü300+Ë°åÔºåÁ≤æÁÆÄÈÉ®ÂàÜÈùûÊ†∏ÂøÉÂÜÖÂÆπÂêéÂåÖÂê´Ê≥®Èáä100+Ë°åÔºâ
<ul>
<li>ÁΩëÁªúÈÄö‰ø°Áõ∏ÂÖ≥‰∏ªË¶Å‰∏∫ÔºöÂú®mainÂáΩÊï∞‰∏≠ÂêØÂä®epollÁõëÂê¨ÔºåioÂ§öË∑ØÂ§çÁî®</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">config_from_stdin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Á≥ªÁªüÂü∫Á°Ä‰æùËµñÂàùÂßãÂåñÔºö
</span></span></span><span class="line"><span class="cl"><span class="cm">    1. Êó∂Âå∫ËÆæÁΩÆ
</span></span></span><span class="line"><span class="cl"><span class="cm">    2. ÂÜÖÂ≠òoomÂ§ÑÁêÜÊñπÊ≥ï
</span></span></span><span class="line"><span class="cl"><span class="cm">    3. ÈöèÊú∫Êï∞/ÂìàÂ∏åÁßçÂ≠êÁîüÊàê
</span></span></span><span class="line"><span class="cl"><span class="cm">    4. crc64Ê†°È™åÁ†ÅÂàùÂßãÂåñ
</span></span></span><span class="line"><span class="cl"><span class="cm">    */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">exec_name</span> <span class="o">=</span> <span class="nf">strrchr</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="sc">&#39;/&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">exec_name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="n">exec_name</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="p">.</span><span class="n">sentinel_mode</span> <span class="o">=</span> <span class="nf">checkForSentinelMode</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">,</span> <span class="n">exec_name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">initServerConfig</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">ACLInit</span><span class="p">();</span> <span class="cm">/* ÂàùÂßãÂåñ ACLÔºàËÆøÈóÆÊéßÂà∂ÂàóË°®ÔºâÁ≥ªÁªüÔºåÁΩëÁªúËøûÊé•Êó∂ÈúÄË¶ÅÊ†πÊçÆACLÊéßÂà∂ÊùÉÈôêÔºåÊ≠§Êó∂Êú™Âä†ËΩΩÂÆûÈôÖÈÖçÁΩÆ */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">moduleInitModulesSystem</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">connTypeInitialize</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Â≠òÂÇ®ÂèØÊâßË°åÊñá‰ª∂Ë∑ØÂæÑÂíåÂêØÂä®ÂèÇÊï∞ÔºåÁî®‰∫é‰ª•ÂêéÈáçÂêØÊúçÂä°Âô® */</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="p">.</span><span class="n">executable</span> <span class="o">=</span> <span class="nf">getAbsolutePath</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="p">.</span><span class="n">exec_argv</span> <span class="o">=</span> <span class="nf">zmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">argc</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="p">.</span><span class="n">exec_argv</span><span class="p">[</span><span class="n">argc</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="n">server</span><span class="p">.</span><span class="n">exec_argv</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nf">zstrdup</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* ÂàùÂßãÂåñ Sentinel Áõ∏ÂÖ≥ÈÖçÁΩÆÔºàÂ¶ÇÊûúÊòØ Sentinel Ê®°ÂºèÔºâ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">sentinel_mode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">initSentinelConfig</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nf">initSentinel</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂêØÂä® redis-check-rdb Êàñ redis-check-aof Ê®°Âºè */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">strstr</span><span class="p">(</span><span class="n">exec_name</span><span class="p">,</span><span class="s">&#34;redis-check-rdb&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">redis_check_rdb_main</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nf">strstr</span><span class="p">(</span><span class="n">exec_name</span><span class="p">,</span><span class="s">&#34;redis-check-aof&#34;</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">redis_check_aof_main</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* ÂèÇÊï∞Ëß£Êûê */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">sds</span> <span class="n">options</span> <span class="o">=</span> <span class="nf">sdsempty</span><span class="p">();</span> <span class="c1">// ‰ΩøÁî®ÂÜÖÈÉ®ÂÆö‰πâÁöÑsdsÂ≠óÁ¨¶‰∏≤ÁªìÊûÑ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* Ëß£ÊûêÁâπÊÆäÂèÇÊï∞ --versionÔºå--help */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;-v&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">            <span class="nf">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;--version&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">sds</span> <span class="n">version</span> <span class="o">=</span> <span class="nf">getVersion</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Redis server %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">sdsfree</span><span class="p">(</span><span class="n">version</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;--help&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">            <span class="nf">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#34;-h&#34;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="nf">usage</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">sds</span> <span class="o">*</span><span class="n">argv_tmp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">argc_tmp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">handled_last_config_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span><span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* ÈÅçÂéÜËß£ÊûêÂèÇÊï∞ */</span>
</span></span><span class="line"><span class="cl">            <span class="n">j</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Ê†πÊçÆÂèÇÊï∞ÂÆåÊàêÂøÖË¶ÅÊñá‰ª∂ÈÖçÁΩÆÁöÑÂä†ËΩΩ */</span>
</span></span><span class="line"><span class="cl">        <span class="nf">loadServerConfig</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">configfile</span><span class="p">,</span> <span class="n">config_from_stdin</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">sentinel_mode</span><span class="p">)</span> <span class="nf">loadSentinelConfigFromQueue</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sdsfree</span><span class="p">(</span><span class="n">options</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">sentinel_mode</span><span class="p">)</span> <span class="nf">sentinelCheckConfigFile</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Ê†∏ÂøÉÔºöÂêØÂä®ÊúçÂä° */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">initServer</span><span class="p">();</span> <span class="c1">// Ê†∏ÂøÉ‰∏≠ÁöÑÊ†∏ÂøÉÔºöËΩΩÂÖ•serverÂØπË±°Áõ∏ÂÖ≥ÁöÑÊ†∏ÂøÉÁªÑ‰ª∂Ôºösignal‰ø°Âè∑Â§ÑÁêÜÂô®ÔºåthreadÁ∫øÁ®ãÁÆ°ÁêÜÂô®Ôºåeventloop‰∫ã‰ª∂Â§ÑÁêÜÊÄªÁ∫øÁ≠â
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">background</span> <span class="o">||</span> <span class="n">server</span><span class="p">.</span><span class="n">pidfile</span><span class="p">)</span> <span class="nf">createPidFile</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">set_proc_title</span><span class="p">)</span> <span class="nf">redisSetProcTitle</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">redisAsciiArt</span><span class="p">();</span> <span class="c1">// ÊâìÂç∞ÂêØÂä®redisÁöÑASCIIÊñáÂ≠ó
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">checkTcpBacklogSettings</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">cluster_enabled</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">clusterInit</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="p">.</span><span class="n">sentinel_mode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">moduleInitModulesSystemLast</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nf">moduleLoadFromQueue</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// aclËØªÂèñÂÆûÈôÖÈÖçÁΩÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ACLLoadUsersAtStartup</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">initListeners</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">cluster_enabled</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">clusterInitLast</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">InitServerLast</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="p">.</span><span class="n">sentinel_mode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ÈùûsentinelÊ®°Âºè
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">serverLog</span><span class="p">(</span><span class="n">LL_NOTICE</span><span class="p">,</span><span class="s">&#34;Server initialized&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">aofLoadManifestFromDisk</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nf">loadDataFromDisk</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nf">aofOpenIfNeededOnServerStart</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nf">aofDelHistoryFiles</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nf">applyAppendOnlyConfig</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// ÈõÜÁæ§Ê®°ÂºèÊ†°È™å
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">cluster_enabled</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">serverAssert</span><span class="p">(</span><span class="nf">verifyClusterConfigWithData</span><span class="p">()</span> <span class="o">==</span> <span class="n">C_OK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// ÊâìÂç∞ÊâÄÊúâÁõëÂê¨Âô®ÁöÑÁä∂ÊÄÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">CONN_TYPE_MAX</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">connListener</span> <span class="o">*</span><span class="n">listener</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">server</span><span class="p">.</span><span class="n">listeners</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">listener</span><span class="o">-&gt;</span><span class="n">ct</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nf">serverLog</span><span class="p">(</span><span class="n">LL_NOTICE</span><span class="p">,</span><span class="s">&#34;Ready to accept connections %s&#34;</span><span class="p">,</span> <span class="n">listener</span><span class="o">-&gt;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="nf">get_type</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">supervised_mode</span> <span class="o">==</span> <span class="n">SUPERVISED_SYSTEMD</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Â¶ÇÊûúÊòØÁî± systemd ÁõëÁù£ËøêË°åÁöÑ Redis ÂÆû‰æãÔºåÈÄöÁü• systemd Redis Áä∂ÊÄÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sentinelIsRunning</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">supervised_mode</span> <span class="o">==</span> <span class="n">SUPERVISED_SYSTEMD</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Â¶ÇÊûúÊòØÁî± systemd ÁõëÁù£ËøêË°åÁöÑ sentinel ÂÆû‰æãÔºåÈÄöÁü• systemd sentinel Áä∂ÊÄÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* ÂÜÖÂ≠òÂàÜÈÖçËøáÂ∞èÔºà1MBÔºâË≠¶Âëä */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">maxmemory</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">server</span><span class="p">.</span><span class="n">maxmemory</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">serverLog</span><span class="p">(</span><span class="n">LL_WARNING</span><span class="p">,</span><span class="s">&#34;WARNING: You specified a maxmemory value that is less than 1MB (current value is %llu bytes). Are you sure this is what you really want?&#34;</span><span class="p">,</span> <span class="n">server</span><span class="p">.</span><span class="n">maxmemory</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">redisSetCpuAffinity</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">server_cpulist</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">setOOMScoreAdj</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// epollÁõëÂê¨ÔºåioÂ§öË∑ØÂ§çÁî®ÔºåÊ≠ªÂæ™ÁéØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">aeMain</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">el</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">aeDeleteEventLoop</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">el</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>Ê†∏ÂøÉ‰∏≠ÁöÑÊ†∏ÂøÉÔºöinitServerÊñπÊ≥ïÔºåËΩΩÂÖ•serverÂØπË±°Áõ∏ÂÖ≥ÁöÑÊ†∏ÂøÉÁªÑ‰ª∂Ôºösignal‰ø°Âè∑Â§ÑÁêÜÂô®ÔºåthreadÁ∫øÁ®ãÁÆ°ÁêÜÂô®Ôºåeventloop‰∫ã‰ª∂Â§ÑÁêÜÊÄªÁ∫øÁ≠â„ÄÇÔºàÂéü200+Ë°åÔºåÁ≤æÁÆÄÈÉ®ÂàÜÈùûÊ†∏ÂøÉÂÜÖÂÆπÂêéÂåÖÂê´Ê≥®Èáä60+Ë°åÔºâ
<ul>
<li>ÁΩëÁªúÈÄö‰ø°Áõ∏ÂÖ≥‰∏ªË¶Å‰∏∫ÔºöÂú®ÂàùÂßãÂåñÂáΩÊï∞‰∏≠ÂàõÂª∫threadÁ∫øÁ®ãÁÆ°ÁêÜÂô®Ôºåeventloop‰∫ã‰ª∂Â§ÑÁêÜÊÄªÁ∫ø</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">initServer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ‰ø°Âè∑Â§ÑÁêÜÂô®Ôºå‰æãÂ¶Çctrl+cÂèëÈÄÅSIGKILL‰ø°Âè∑ÔºåÊ≠§Êó∂ÈúÄË¶ÅÂÖ≥Èó≠ÊúçÂä°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">setupSignalHandlers</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Á∫øÁ®ãÁÆ°ÁêÜÂô®ÂàùÂßãÂåñ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ThreadsManager_init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">makeThreadKillable</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Âú®‰ªéÈÖçÁΩÆÁ≥ªÁªüËÆæÁΩÆÈªòËÆ§ÂÄºÂêéËøõË°åÂàùÂßãÂåñ */</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="p">.</span><span class="n">aof_state</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">aof_enabled</span> <span class="o">?</span> <span class="nl">AOF_ON</span> <span class="p">:</span> <span class="n">AOF_OFF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="p">.</span><span class="n">fsynced_reploff</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">aof_enabled</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="p">.</span><span class="n">hz</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">config_hz</span><span class="p">;</span> <span class="c1">// ÂøÉË∑≥È¢ëÁéá
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">server</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="nf">getpid</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂàõÂª∫eventloop‰∫ã‰ª∂Â§ÑÁêÜÊÄªÁ∫øÔºåÂü∫‰∫éepollÊú∫Âà∂ÔºàlinuxÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">server</span><span class="p">.</span><span class="n">el</span> <span class="o">=</span> <span class="nf">aeCreateEventLoop</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">maxclients</span><span class="o">+</span><span class="n">CONFIG_FDSET_INCR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">el</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">serverLog</span><span class="p">(</span><span class="n">LL_WARNING</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;Failed creating the event loop. Error message: &#39;%s&#39;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nf">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="cm">/* ÂàõÂª∫ÂÆöÊó∂Âô®ÂõûË∞ÉÔºåËøôÊòØÊàë‰ª¨Â§ÑÁêÜËÆ∏Â§öÂêéÂè∞Êìç‰ΩúÁöÑÊñπÂºèÔºå
</span></span></span><span class="line"><span class="cl"><span class="cm">       ÊØîÂ¶ÇÂÆ¢Êà∑Á´ØË∂ÖÊó∂„ÄÅÊú™ËÆøÈóÆÁöÑËøáÊúüÈîÆÁöÑÊ∑òÊ±∞Á≠â */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">aeCreateTimeEvent</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">el</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">serverCron</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="n">AE_ERR</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">serverPanic</span><span class="p">(</span><span class="s">&#34;Can&#39;t create event loop timers.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* ‰∏∫Áî®‰∫éÂî§ÈÜí‰∫ã‰ª∂Âæ™ÁéØÁöÑÁÆ°ÈÅìÊ≥®ÂÜå‰∏Ä‰∏™ÂèØËØª‰∫ã‰ª∂Ôºå
</span></span></span><span class="line"><span class="cl"><span class="cm">       Áî®‰∫éÊ®°ÂùóÁ∫øÁ®ãÈó¥ÁöÑÈÄö‰ø° */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">aeCreateFileEvent</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">el</span><span class="p">,</span> <span class="n">server</span><span class="p">.</span><span class="n">module_pipe</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">AE_READABLE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">modulePipeReadable</span><span class="p">,</span><span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="n">AE_ERR</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">serverPanic</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;Error registering the readable event for the module pipe.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Ê≥®ÂÜåepollÈòªÂ°ûÂâçÂêéÁöÑÂõûË∞ÉÂáΩÊï∞ÔºàÈúÄÂú®Âä†ËΩΩÊåÅ‰πÖÂåñ‰πãÂâçÂÆåÊàêÔºåÂõ†‰∏∫ÂÆÉ‰ºöË¢´ processEventsWhileBlocked ‰ΩøÁî®Ôºâ */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">aeSetBeforeSleepProc</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">el</span><span class="p">,</span><span class="n">beforeSleep</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">aeSetAfterSleepProc</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">el</span><span class="p">,</span><span class="n">afterSleep</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* 32‰ΩçËÄÅÁ≥ªÁªüÂèóÈôê‰∫éÂØªÂùÄ‰∏äÈôê32bitÔºåÊúÄÂ§öËÆøÈóÆ2^32‰∏™Â≠óËäÇÔºå‰πüÂ∞±ÊòØ4294967296B -&gt; 4GBÔºåredis‰ºöÈªòËÆ§ÈôêÂà∂3GB‰∏äÈôê */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">arch_bits</span> <span class="o">==</span> <span class="mi">32</span> <span class="o">&amp;&amp;</span> <span class="n">server</span><span class="p">.</span><span class="n">maxmemory</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">serverLog</span><span class="p">(</span><span class="n">LL_WARNING</span><span class="p">,</span><span class="s">&#34;Warning: 32 bit instance detected but no memory limit set. Setting 3 GB maxmemory limit with &#39;noeviction&#39; policy now.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">server</span><span class="p">.</span><span class="n">maxmemory</span> <span class="o">=</span> <span class="mi">3072LL</span><span class="o">*</span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">);</span> <span class="cm">/* 3 GB */</span>
</span></span><span class="line"><span class="cl">        <span class="n">server</span><span class="p">.</span><span class="n">maxmemory_policy</span> <span class="o">=</span> <span class="n">MAXMEMORY_NO_EVICTION</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ËÑöÊú¨Á≥ªÁªüÂàùÂßãÂåñ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">luaEnvInit</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">scriptingInit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">functionsInit</span><span class="p">()</span> <span class="o">==</span> <span class="n">C_ERR</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">serverPanic</span><span class="p">(</span><span class="s">&#34;Functions initialization failed, check the server logs.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Âü∫Êú¨ÁõëÊéßÂàùÂßãÂåñÔºöÊèê‰æõÊÖ¢Êü•ËØ¢ÂëäË≠¶/Âª∂ËøüÁõëÊéßÁ≠âÂäüËÉΩ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">slowlogInit</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nf">latencyMonitorInit</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂèÇÁÖßÈÖçÁΩÆÂàùÂßãÂåñÂØÜÁ†ÅÔºå‰∏ÄËà¨‰∏çÂêØÁî®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">ACLUpdateDefaultUserPassword</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">requirepass</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂÆöÊó∂Âô®ÂäüËÉΩÂàùÂßãÂåñ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">applyWatchdogPeriod</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">maxmemory_clients</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">initServerClientMemUsageBuckets</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>aeCreateEventLoopÊñπÊ≥ïÔºöÂàõÂª∫‰∫ã‰ª∂Âæ™ÁéØÊÄªÁ∫ø</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-C" data-lang="C"><span class="line"><span class="cl"><span class="n">aeEventLoop</span> <span class="o">*</span><span class="nf">aeCreateEventLoop</span><span class="p">(</span><span class="kt">int</span> <span class="n">setsize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">monotonicInit</span><span class="p">();</span>    <span class="cm">/* just in case the calling app didn&#39;t initialize */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂàÜÈÖçÂÜÖÂ≠òÔºöÊúÄÂ§ßÊÑüÂÖ¥Ë∂£ÁöÑfd‰∏∫setsize
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">((</span><span class="n">eventLoop</span> <span class="o">=</span> <span class="nf">zmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eventLoop</span><span class="p">)))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="nf">zmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">aeFileEvent</span><span class="p">)</span><span class="o">*</span><span class="n">setsize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">fired</span> <span class="o">=</span> <span class="nf">zmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">aeFiredEvent</span><span class="p">)</span><span class="o">*</span><span class="n">setsize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">fired</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">setsize</span> <span class="o">=</span> <span class="n">setsize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">timeEventHead</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">timeEventNextId</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">maxfd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">beforesleep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">aftersleep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">aeApiCreate</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">goto</span> <span class="n">err</span><span class="p">;</span> <span class="c1">// Ê†∏ÂøÉÔºöË∞ÉÁî®Â∞ÅË£ÖÁöÑÂáΩÊï∞aeApiCreate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/* EventsÁöÑÂÖ≥Ê≥®‰∫ã‰ª∂ÈªòËÆ§ÁΩÆ‰∏∫0Ôºà‰∏çÂÖ≥Ê≥®‰ªª‰Ωï‰∫ã‰ª∂Ôºâ*/</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">setsize</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span> <span class="o">=</span> <span class="n">AE_NONE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">eventLoop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">err</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Â§±Ë¥•ÂàôÈáäÊîæÂÜÖÂ≠ò
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">eventLoop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">zfree</span><span class="p">(</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">zfree</span><span class="p">(</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">fired</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">zfree</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*  ae_epoll.cÔºå‰ªÖÂú®‰∏äÈù¢‰ª£Á†Å‰∏≠Ë∞ÉÁî®ÔºåÂàõÂª∫‰∫ã‰ª∂ÊÄªÁ∫ø	
</span></span></span><span class="line"><span class="cl"><span class="cm">	ËøôÈáå‰æùËµñÁ≥ªÁªüÂÜÖÁΩÆÂ∫ìÂáΩÊï∞Ôºöepoll_createÔºåÂÖ∂‰∏≠sizeÂèÇÊï∞‰ªÖ‰∏∫ÂèÇËÄÉÂÄºÔºåÂØπËæÉÊñ∞ÁöÑlinuxÁâàÊú¨Êù•ËØ¥Êó†ÂÆûÈôÖ‰ΩúÁî®
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">aeApiCreate</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeApiState</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="nf">zmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">aeApiState</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="nf">zmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">epoll_event</span><span class="p">)</span><span class="o">*</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">setsize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">zfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="o">-&gt;</span><span class="n">epfd</span> <span class="o">=</span> <span class="nf">epoll_create</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span> <span class="cm">/* 1024 is just a hint for the kernel */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">epfd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">zfree</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">zfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">anetCloexec</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">epfd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">apidata</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>ae_epoll.cÂ∞ÅË£ÖÁ≥ªÁªüÂ∫ìÂáΩÊï∞ÔºàÊó†Á≤æÁÆÄÔºâ</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/epoll.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">aeApiState</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">epfd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">epoll_event</span> <span class="o">*</span><span class="n">events</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">aeApiState</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* ‰ªÖÂú®aeCreateEventLoop‰ª£Á†Å‰∏≠Ë∞ÉÁî®ÔºåÂàõÂª∫‰∫ã‰ª∂ÊÄªÁ∫ø	
</span></span></span><span class="line"><span class="cl"><span class="cm">   ‰æùËµñÁ≥ªÁªüÂÜÖÁΩÆÂ∫ìÂáΩÊï∞Ôºöepoll_createÔºåÂÖ∂‰∏≠Ôºö
</span></span></span><span class="line"><span class="cl"><span class="cm">   sizeÂèÇÊï∞‰ªÖ‰∏∫ÂèÇËÄÉÂÄºÔºåÂØπËæÉÊñ∞ÁöÑlinuxÁâàÊú¨Êù•ËØ¥Êó†ÂÆûÈôÖ‰ΩúÁî®
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">aeApiCreate</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeApiState</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="nf">zmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">aeApiState</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="nf">zmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">epoll_event</span><span class="p">)</span><span class="o">*</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">setsize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">zfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="o">-&gt;</span><span class="n">epfd</span> <span class="o">=</span> <span class="nf">epoll_create</span><span class="p">(</span><span class="mi">1024</span><span class="p">);</span> <span class="cm">/* 1024 is just a hint for the kernel */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">epfd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">zfree</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">zfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">anetCloexec</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">epfd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">apidata</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// resize eventÊï∞ÁªÑÔºåÁ±ª‰ººvector(c)/list(java)/slice(golang/python)Âä®ÊÄÅÊâ©ÂÆπ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">aeApiResize</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="kt">int</span> <span class="n">setsize</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeApiState</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">apidata</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="nf">zrealloc</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">epoll_event</span><span class="p">)</span><span class="o">*</span><span class="n">setsize</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ÈáäÊîæËµÑÊ∫ê
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">static</span> <span class="kt">void</span> <span class="nf">aeApiFree</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeApiState</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">apidata</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">close</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">epfd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">zfree</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">zfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Âú®eventloop‰∏≠Ê≥®ÂÜåÊñ∞ÁöÑfdÔºåmask‰∏∫ÊÑüÂÖ¥Ë∂£ÁöÑ‰∫ã‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="cm">   ‰æùËµñÁ≥ªÁªüÂÜÖÁΩÆÂ∫ìÂáΩÊï∞epoll_ctlÔºåÂÖ∂‰∏≠Ôºö
</span></span></span><span class="line"><span class="cl"><span class="cm">   epfd‰∏∫‰∫ã‰ª∂ÊÄªÁ∫øfdÔºå
</span></span></span><span class="line"><span class="cl"><span class="cm">   op‰∏∫Ê≥®ÂÜåÊìç‰ΩúÔºåÊûö‰∏æEPOLL_CTL_ADD, EPOLL_CTL_ADD, EPOLL_CTL_DELÔºå
</span></span></span><span class="line"><span class="cl"><span class="cm">   fd‰∏∫Ê≥®ÂÜåÁöÑÊñ∞fdÔºå
</span></span></span><span class="line"><span class="cl"><span class="cm">   ee‰∏∫Êñ∞Âª∫ÁöÑepoll_eventÁªìÊûÑ‰ΩìÂÆû‰æã
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">aeApiAddEvent</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeApiState</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">apidata</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">ee</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span> <span class="cm">/* avoid valgrind warning */</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* If the fd was already monitored for some event, we need a MOD
</span></span></span><span class="line"><span class="cl"><span class="cm">     * operation. Otherwise we need an ADD operation. */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">op</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">fd</span><span class="p">].</span><span class="n">mask</span> <span class="o">==</span> <span class="n">AE_NONE</span> <span class="o">?</span>
</span></span><span class="line"><span class="cl">            <span class="nl">EPOLL_CTL_ADD</span> <span class="p">:</span> <span class="n">EPOLL_CTL_MOD</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ee</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">mask</span> <span class="o">|=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">fd</span><span class="p">].</span><span class="n">mask</span><span class="p">;</span> <span class="cm">/* Merge old events */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AE_READABLE</span><span class="p">)</span> <span class="n">ee</span><span class="p">.</span><span class="n">events</span> <span class="o">|=</span> <span class="n">EPOLLIN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AE_WRITABLE</span><span class="p">)</span> <span class="n">ee</span><span class="p">.</span><span class="n">events</span> <span class="o">|=</span> <span class="n">EPOLLOUT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ee</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">epoll_ctl</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">epfd</span><span class="p">,</span><span class="n">op</span><span class="p">,</span><span class="n">fd</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ee</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Âú®eventloop‰∏≠Ê≥®ÂÜåÊñ∞ÁöÑfdÔºåmask‰∏∫ÊÑüÂÖ¥Ë∂£ÁöÑ‰∫ã‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="cm">   ‰æùËµñÁ≥ªÁªüÂÜÖÁΩÆÂ∫ìÂáΩÊï∞epoll_ctlÔºåÂÖ∂‰∏≠Ôºö
</span></span></span><span class="line"><span class="cl"><span class="cm">   epfd‰∏∫‰∫ã‰ª∂ÊÄªÁ∫øfdÔºå
</span></span></span><span class="line"><span class="cl"><span class="cm">   op‰∏∫Ê≥®ÂÜåÊìç‰ΩúÔºåÊûö‰∏æEPOLL_CTL_ADD, EPOLL_CTL_ADD, EPOLL_CTL_DELÔºå
</span></span></span><span class="line"><span class="cl"><span class="cm">   fd‰∏∫Ê≥®ÂÜåÁöÑÊñ∞fdÔºå
</span></span></span><span class="line"><span class="cl"><span class="cm">   ee‰∏∫Êñ∞Âª∫ÁöÑepoll_eventÁªìÊûÑ‰ΩìÂÆû‰æãÔºåÂÖ≥Ê≥®ÁöÑmaskÂÜôÂú®Ëøô‰∏™ÁªìÊûÑ‰Ωì‰∏≠
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">aeApiDelEvent</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delmask</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeApiState</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">apidata</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">ee</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span> <span class="cm">/* avoid valgrind warning */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">fd</span><span class="p">].</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">delmask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ee</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AE_READABLE</span><span class="p">)</span> <span class="n">ee</span><span class="p">.</span><span class="n">events</span> <span class="o">|=</span> <span class="n">EPOLLIN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AE_WRITABLE</span><span class="p">)</span> <span class="n">ee</span><span class="p">.</span><span class="n">events</span> <span class="o">|=</span> <span class="n">EPOLLOUT</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ee</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">!=</span> <span class="n">AE_NONE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">epoll_ctl</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">epfd</span><span class="p">,</span><span class="n">EPOLL_CTL_MOD</span><span class="p">,</span><span class="n">fd</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ee</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* Note, Kernel &lt; 2.6.9 requires a non null event pointer even for
</span></span></span><span class="line"><span class="cl"><span class="cm">         * EPOLL_CTL_DEL. */</span>
</span></span><span class="line"><span class="cl">        <span class="nf">epoll_ctl</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">epfd</span><span class="p">,</span><span class="n">EPOLL_CTL_DEL</span><span class="p">,</span><span class="n">fd</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ee</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Âú®eventloop‰∏≠Ê≥®ÂÜåÊñ∞ÁöÑfdÔºåmask‰∏∫ÊÑüÂÖ¥Ë∂£ÁöÑ‰∫ã‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="cm">   ‰æùËµñÁ≥ªÁªüÂÜÖÁΩÆÂ∫ìÂáΩÊï∞epoll_waitÔºåÂÖ∂‰∏≠Ôºö
</span></span></span><span class="line"><span class="cl"><span class="cm">   epfd‰∏∫‰∫ã‰ª∂ÊÄªÁ∫øfdÔºå
</span></span></span><span class="line"><span class="cl"><span class="cm">   events‰∏∫Â∑≤Ê≥®ÂÜåÁöÑÂÖ®ÈÉ®ÊÑüÂÖ¥Ë∂£‰∫ã‰ª∂Ôºå
</span></span></span><span class="line"><span class="cl"><span class="cm">   tvpÁõ∏ÂÖ≥‰∏∫Á≠âÂæÖÊó∂Èó¥Ôºå-1‰∏∫‰∏ÄÁõ¥ÈòªÂ°ûÔºåÁõ¥Âà∞ÊúâÊ≥®ÂÜåÁöÑÊÑüÂÖ¥Ë∂£‰∫ã‰ª∂ÂèëÁîü
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">aeApiPoll</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">tvp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeApiState</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">apidata</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">numevents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">retval</span> <span class="o">=</span> <span class="nf">epoll_wait</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">epfd</span><span class="p">,</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">,</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">setsize</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">tvp</span> <span class="o">?</span> <span class="p">(</span><span class="n">tvp</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="o">*</span><span class="mi">1000</span> <span class="o">+</span> <span class="p">(</span><span class="n">tvp</span><span class="o">-&gt;</span><span class="n">tv_usec</span> <span class="o">+</span> <span class="mi">999</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">numevents</span> <span class="o">=</span> <span class="n">retval</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">numevents</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">struct</span> <span class="n">epoll_event</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">events</span><span class="o">+</span><span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLIN</span><span class="p">)</span> <span class="n">mask</span> <span class="o">|=</span> <span class="n">AE_READABLE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLOUT</span><span class="p">)</span> <span class="n">mask</span> <span class="o">|=</span> <span class="n">AE_WRITABLE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLERR</span><span class="p">)</span> <span class="n">mask</span> <span class="o">|=</span> <span class="n">AE_WRITABLE</span><span class="o">|</span><span class="n">AE_READABLE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLHUP</span><span class="p">)</span> <span class="n">mask</span> <span class="o">|=</span> <span class="n">AE_WRITABLE</span><span class="o">|</span><span class="n">AE_READABLE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">fired</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">fd</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">fired</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">!=</span> <span class="n">EINTR</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">panic</span><span class="p">(</span><span class="s">&#34;aeApiPoll: epoll_wait, %s&#34;</span><span class="p">,</span> <span class="nf">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">numevents</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">aeApiName</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s">&#34;epoll&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="5">
<li>Âì™‰∫õÂú∞ÊñπË∞ÉÁî®‰∫ÜÊ≥®ÂÜå‰∫ã‰ª∂
<ul>
<li><strong>serverÂêØÂä®ËøáÁ®ã‰∏≠ÔºöinitListeners -&gt; createSocketAcceptHandler ÔºàacceptÔºâ</strong>
<ul>
<li>connSocketAcceptHandler</li>
</ul>
</li>
<li><strong>ÂàõÂª∫ÂÆ¢Êà∑Á´ØËøûÊé•Êó∂ÔºöConnectionType -&gt; connSocketConnectÔºàconnectÔºâ</strong>
<ul>
<li>ae_handler -&gt; connSocketSetReadHandler
<ul>
<li>Âª∫Á´ãclientÈÄö‰ø°Êó∂ÔºöcreateClient -&gt; readQueryFromClient</li>
</ul>
</li>
<li>ae_handler -&gt; connSocketSetWriteHandler
<ul>
<li>ÂàùÂßãÂåñÊúçÂä°Á´ØÊó∂ÔºöinitServer -&gt; aeSetBeforeSleepProc -&gt; beforeSleep -&gt; handleClientsWithPendingWritesUsingThreads -&gt; sendReplyToClient</li>
</ul>
</li>
</ul>
</li>
<li>ÂêåÊ≠•rdbÊï∞ÊçÆÔºöinitServer -&gt; aeCreateTimeEvent(server.el, 1, serverCron, NULL, NULL) -&gt; serverCron -&gt; checkChildrenDone -&gt; replicationStartPendingFork -&gt; rdbSaveToSlavesSockets
<ul>
<li>rdbPipeReadHandler</li>
</ul>
</li>
<li>sentinelÈÄö‰ø°ÔºöinitServer -&gt; aeCreateTimeEvent(server.el, 1, serverCron, NULL, NULL) -&gt; serverCron -&gt; sentinelTimer -&gt; sentinelHandleDictOfRedisInstances -&gt; sentinelHandleRedisInstance -&gt; sentinelReconnectInstance -&gt; redisAeAttach -&gt; redisAeAddWrite</li>
<li>pipelineÁÆ°ÈÅìÁöÑbioÈÄö‰ø°ÔºöinitServer -&gt; InitServerLast -&gt; bioInit</li>
</ul>
</li>
<li>Ê≥®ÂÜå‰∫ã‰ª∂Â§ÑÁêÜÔºömain -&gt; aeMain -&gt; aeApiPoll -&gt; epoll_wait</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// Ê≠ªÂæ™ÁéØÂ§ÑÁêÜ‰∫ã‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">aeMain</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">aeProcessEvents</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">,</span> <span class="n">AE_ALL_EVENTS</span><span class="o">|</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">AE_CALL_BEFORE_SLEEP</span><span class="o">|</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">AE_CALL_AFTER_SLEEP</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">aeEventLoop</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">maxfd</span><span class="p">;</span>   <span class="cm">/* highest file descriptor currently registered */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">setsize</span><span class="p">;</span> <span class="cm">/* max number of file descriptors tracked */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="kt">long</span> <span class="n">timeEventNextId</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeFileEvent</span> <span class="o">*</span><span class="n">events</span><span class="p">;</span> <span class="cm">/* Registered events */</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeFiredEvent</span> <span class="o">*</span><span class="n">fired</span><span class="p">;</span> <span class="cm">/* Fired events */</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeTimeEvent</span> <span class="o">*</span><span class="n">timeEventHead</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">stop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span><span class="n">apidata</span><span class="p">;</span> <span class="cm">/* This is used for polling API specific data */</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeBeforeSleepProc</span> <span class="o">*</span><span class="n">beforesleep</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeBeforeSleepProc</span> <span class="o">*</span><span class="n">aftersleep</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">aeEventLoop</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">aeFileEvent</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span> <span class="cm">/* one of AE_(READABLE|WRITABLE|BARRIER) */</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeFileProc</span> <span class="o">*</span><span class="n">rfileProc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">aeFileProc</span> <span class="o">*</span><span class="n">wfileProc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">void</span> <span class="o">*</span><span class="n">clientData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="n">aeFileEvent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">aeProcessEvents</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">numevents</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Â¶ÇÊûúÊ≤°ÊúâÊñá‰ª∂‰∫ã‰ª∂ÂíåÊó∂Èó¥‰∫ã‰ª∂ÈúÄË¶ÅÂ§ÑÁêÜÔºåÁõ¥Êé•ËøîÂõû */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AE_TIME_EVENTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AE_FILE_EVENTS</span><span class="p">))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Âç≥‰ΩøÊ≤°ÊúâÊñá‰ª∂‰∫ã‰ª∂ÔºåÂ¶ÇÊûúÊúâÊó∂Èó¥‰∫ã‰ª∂Ôºå‰πüÈúÄË¶ÅË∞ÉÁî® aeApiPoll Êù•Á≠âÂæÖ‰∏ã‰∏ÄÊ¨°Êó∂Èó¥‰∫ã‰ª∂ÁöÑËß¶Âèë */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">maxfd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AE_TIME_EVENTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AE_DONT_WAIT</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">,</span> <span class="o">*</span><span class="n">tvp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* NULL means infinite wait. */</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int64_t</span> <span class="n">usUntilTimer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">beforesleep</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AE_CALL_BEFORE_SLEEP</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* Before sleep callback. */</span>
</span></span><span class="line"><span class="cl">            <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="nf">beforesleep</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* eventLoop-&gt;flags ÂèØËÉΩ‰ºöÂú® beforeSleep ‰∏≠ÂèëÁîüÊîπÂèòÔºåÊâÄ‰ª•ÈúÄË¶ÅÂú®Ë∞ÉÁî® beforeSleep ÂêéÈáçÊñ∞Ê£ÄÊü•
</span></span></span><span class="line"><span class="cl"><span class="cm">		   ÂêåÊó∂Ôºåflags ÂèÇÊï∞‰ºòÂÖàÁ∫ßÊõ¥È´òÔºåÁâπÂà´ÊòØ AE_DONT_WAIT ËÆæÁΩÆÊó∂ÔºåÂ∫îÂøΩÁï• eventLoop-&gt;flags ‰∏≠ÁöÑÂÄº */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AE_DONT_WAIT</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AE_DONT_WAIT</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="n">tv</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">tvp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tv</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AE_TIME_EVENTS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">usUntilTimer</span> <span class="o">=</span> <span class="nf">usUntilEarliestTimer</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">usUntilTimer</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">tv</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="n">usUntilTimer</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">tv</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="n">usUntilTimer</span> <span class="o">%</span> <span class="mi">1000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">tvp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tv</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* Ë∞ÉÁî®aeApiPollÂ§öË∑ØÂ§çÁî®ÊñπÊ≥ïÔºåCall the multiplexing API, will return only on timeout or when some event fires. */</span>
</span></span><span class="line"><span class="cl">        <span class="n">numevents</span> <span class="o">=</span> <span class="nf">aeApiPoll</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">,</span> <span class="n">tvp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Â¶ÇÊûúÊ≤°ÊúâËØ∑Ê±ÇÂ§ÑÁêÜÊñá‰ª∂‰∫ã‰ª∂ÔºåÂ∞±Ë∑≥ËøáÊñá‰ª∂‰∫ã‰ª∂ÁöÑÂ§ÑÁêÜ */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AE_FILE_EVENTS</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">numevents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* After sleep callback. */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">aftersleep</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AE_CALL_AFTER_SLEEP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="nf">aftersleep</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">numevents</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">fired</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">aeFileEvent</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">fd</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">fired</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">mask</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">fired</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Number of events fired for current fd. */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="cm">/* ÈªòËÆ§ÊÉÖÂÜµ‰∏ãÔºåÂÖàÊâßË°åÂèØËØª‰∫ã‰ª∂ÔºåÂÜçÊâßË°åÂèØÂÜô‰∫ã‰ª∂„ÄÇËøô‰∏™È°∫Â∫èÂèØ‰ª•Á°Æ‰øùÊúâÂèØËØªÊï∞ÊçÆÊó∂Ôºå‰ºòÂÖàÂ§ÑÁêÜËØªÂèñËØ∑Ê±Ç„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">             * Â¶ÇÊûúËÆæÁΩÆ‰∫Ü AE_BARRIER Ê†áÂøóÔºåÂàôË°®Á§∫Êàë‰ª¨Â∏åÊúõÂèçËΩ¨ÊâßË°åÈ°∫Â∫èÔºåÂÖàÊâßË°åÂèØÂÜô‰∫ã‰ª∂„ÄÇ */</span>
</span></span><span class="line"><span class="cl">            <span class="kt">int</span> <span class="n">invert</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AE_BARRIER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="cm">/* Ê£ÄÊü•‰∫ã‰ª∂ÊòØÂê¶‰ªçÁÑ∂ÊúâÊïàÔºöÂèØËÉΩÂ∑≤ÁªèÂ§ÑÁêÜËøáÁöÑ‰∫ã‰ª∂Âú®ÂΩìÂâçÂõûÂêà‰∏≠Â∑≤ÁªèË¢´ÁßªÈô§ */</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">invert</span> <span class="o">&amp;&amp;</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AE_READABLE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">fe</span><span class="o">-&gt;</span><span class="nf">rfileProc</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">,</span><span class="n">fd</span><span class="p">,</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">clientData</span><span class="p">,</span><span class="n">mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">fired</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">fe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">fd</span><span class="p">];</span> <span class="cm">/* Refresh in case of resize. */</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="cm">/* ÊâßË°åÂèØÂÜô‰∫ã‰ª∂ */</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AE_WRITABLE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fired</span> <span class="o">||</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">wfileProc</span> <span class="o">!=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">rfileProc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">fe</span><span class="o">-&gt;</span><span class="nf">wfileProc</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">,</span><span class="n">fd</span><span class="p">,</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">clientData</span><span class="p">,</span><span class="n">mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">fired</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">             <span class="cm">/* Â¶ÇÊûúÈúÄË¶ÅÂèçËΩ¨ÊâßË°åÈ°∫Â∫èÔºåÂú®ÂèØÂÜô‰∫ã‰ª∂ÂêéÊâßË°åÂèØËØª‰∫ã‰ª∂ */</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">invert</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">fe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">fd</span><span class="p">];</span> <span class="cm">/* Refresh in case of resize. */</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">((</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AE_READABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">(</span><span class="o">!</span><span class="n">fired</span> <span class="o">||</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">wfileProc</span> <span class="o">!=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">rfileProc</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">fe</span><span class="o">-&gt;</span><span class="nf">rfileProc</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">,</span><span class="n">fd</span><span class="p">,</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">clientData</span><span class="p">,</span><span class="n">mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">fired</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">processed</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* Â¶ÇÊûúÈúÄË¶ÅÂ§ÑÁêÜÊó∂Èó¥‰∫ã‰ª∂ÔºåÂàôÁªßÁª≠Â§ÑÁêÜÊó∂Èó¥‰∫ã‰ª∂ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AE_TIME_EVENTS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">processed</span> <span class="o">+=</span> <span class="nf">processTimeEvents</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">processed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="Â§öË∑ØÂ§çÁî®Â§ÑÁêÜÊñπÊ≥ïÁ±ª‰ººnetty‰∏≠ÁöÑhandlerÂÆûÁé∞">Â§öË∑ØÂ§çÁî®Â§ÑÁêÜÊñπÊ≥ïÔºàÁ±ª‰ººnetty‰∏≠ÁöÑhandlerÂÆûÁé∞Ôºâ
</h3><ol start="7">
<li>ÂçèËÆÆËß£ÊûêÔºöcreateClient -&gt; readQueryFromClient -&gt; processInputBuffer -&gt; processXXXBuffer -&gt; processCommandAndResetClient
<ul>
<li>inlineÔºöprocessInlineBuffer</li>
<li>multiÔºöprocessMultibulkBuffer</li>
</ul>
</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">readQueryFromClient</span><span class="p">(</span><span class="n">connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">client</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="nf">connGetPrivateData</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">nread</span><span class="p">,</span> <span class="n">big_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">size_t</span> <span class="n">qblen</span><span class="p">,</span> <span class="n">readlen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Â¶ÇÊûúÂêØÁî®‰∫ÜÁ∫øÁ®ãÂåñ I/OÔºåÂπ∂‰∏îÈúÄË¶ÅÂú®ÈÄÄÂá∫‰∫ã‰ª∂Âæ™ÁéØÊó∂Á®çÂêéËØªÂèñÂÆ¢Êà∑Á´ØÊï∞ÊçÆ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">postponeClientRead</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Êõ¥Êñ∞ÊúçÂä°Âô®ÁöÑÊÄªËØªÂèñÊ¨°Êï∞ */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">atomicIncr</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">stat_total_reads_processed</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">readlen</span> <span class="o">=</span> <span class="n">PROTO_IOBUF_LEN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="cm">/* Â¶ÇÊûúËøôÊòØ‰∏Ä‰∏™Â§öÊâπÈáèËØ∑Ê±ÇÔºåÂπ∂‰∏îÊ≠£Âú®Â§ÑÁêÜ‰∏Ä‰∏™ËæÉÂ§ßÁöÑÊâπÈáèÂõûÂ§çÔºåÂ∞ΩÈáèÁ°Æ‰øùÊü•ËØ¢ÁºìÂÜ≤Âå∫
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Á≤æÁ°ÆÂåÖÂê´Ë°®Á§∫ÂØπË±°ÁöÑ SDS Â≠óÁ¨¶‰∏≤ÔºåÂç≥‰ΩøËøôÂèØËÉΩ‰ºöÂØºËá¥Êõ¥Â§öÁöÑ read(2) Ë∞ÉÁî®„ÄÇ 
</span></span></span><span class="line"><span class="cl"><span class="cm">     * ËøôÊ†∑ÔºåÂáΩÊï∞ processMultiBulkBuffer() ÂèØ‰ª•ÈÅøÂÖçÂ§çÂà∂ÁºìÂÜ≤Âå∫Êù•ÂàõÂª∫ Redis ÂØπË±°„ÄÇ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">reqtype</span> <span class="o">==</span> <span class="n">PROTO_REQ_MULTIBULK</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">multibulklen</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bulklen</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bulklen</span> <span class="o">&gt;=</span> <span class="n">PROTO_MBULK_BIG_ARG</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* ÂØπ‰∫éÂ§ßÁöÑÂèÇÊï∞ÔºåÂÆ¢Êà∑Á´ØÊÄªÊòØ‰ΩøÁî®ÂÖ∂ÁßÅÊúâÁöÑÊü•ËØ¢ÁºìÂÜ≤Âå∫„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">         * ‰ΩøÁî®ÂèØÈáçÁî®ÁöÑÊü•ËØ¢ÁºìÂÜ≤Âå∫ÂèØËÉΩ‰ºöÂØºËá¥ÂÖ∂Ë∂ÖÂá∫ 32kÔºåÊúÄÁªàËÆ©ÂÆ¢Êà∑Á´ØÊé•ÁÆ°Ëøô‰∏™ÁºìÂÜ≤Âå∫„ÄÇ */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">)</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">=</span> <span class="nf">sdsempty</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">ssize_t</span> <span class="n">remaining</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bulklen</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">)</span><span class="o">-</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">big_arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Ê≥®ÊÑèÔºö&#39;remaining&#39; ÂèòÈáèÂú®Êüê‰∫õËæπÁºòÊÉÖÂÜµ‰∏ãÂèØËÉΩ‰∏∫Èõ∂Ôºå‰æãÂ¶ÇÂΩìÂú® CLIENT PAUSE ÂêéÊÅ¢Â§çË¢´ÈòªÂ°ûÁöÑÂÆ¢Êà∑Á´ØÊó∂ */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">remaining</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">readlen</span> <span class="o">=</span> <span class="n">remaining</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Â¶ÇÊûúÊòØ‰∏ªÂÆ¢Êà∑Á´ØÔºåÂú®ÈÅáÂà∞Â§ßÂèÇÊï∞Êó∂ÈúÄË¶ÅÊâ©Â§ßËØªÂèñÈïøÂ∫¶Ôºå‰ΩÜ‰∏çÈúÄË¶ÅÂØπÈΩêÂà∞‰∏ã‰∏Ä‰∏™ÂèÇÊï∞ÔºåÂèØ‰ª•ËØªÂèñÊõ¥Â§öÊï∞ÊçÆ */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_MASTER</span> <span class="o">&amp;&amp;</span> <span class="n">readlen</span> <span class="o">&lt;</span> <span class="n">PROTO_IOBUF_LEN</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">readlen</span> <span class="o">=</span> <span class="n">PROTO_IOBUF_LEN</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="n">thread_reusable_qb_used</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* Â¶ÇÊûúÂèØÈáçÁî®ÁöÑÊü•ËØ¢ÁºìÂÜ≤Âå∫Â∑≤Ë¢´ÂÖ∂‰ªñÂÆ¢Êà∑Á´Ø‰ΩøÁî®ÔºåÂàáÊç¢Âà∞‰ΩøÁî®ÂÆ¢Êà∑Á´ØÁöÑÁßÅÊúâÊü•ËØ¢ÁºìÂÜ≤Âå∫„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">             * ËøôÁßçÊÉÖÂÜµ‰ªÖÂú®ÈÄöËøá processEventsWhileBlocked() ÊâßË°åÂµåÂ•óÂëΩ‰ª§Êó∂ÂèëÁîü„ÄÇ */</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">=</span> <span class="nf">sdsnewlen</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">PROTO_IOBUF_LEN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">sdsclear</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* Â¶ÇÊûúÊü•ËØ¢ÁºìÂÜ≤Âå∫‰∏çÂ≠òÂú®ÔºåÂàôÂàõÂª∫ÂèØÈáçÁî®ÁöÑÊü•ËØ¢ÁºìÂÜ≤Âå∫ */</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">thread_reusable_qb</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">thread_reusable_qb</span> <span class="o">=</span> <span class="nf">sdsnewlen</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">PROTO_IOBUF_LEN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">sdsclear</span><span class="p">(</span><span class="n">thread_reusable_qb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="cm">/* Â∞ÜÂèØÈáçÁî®ÁöÑÊü•ËØ¢ÁºìÂÜ≤Âå∫ÂàÜÈÖçÁªôÂÆ¢Êà∑Á´ØÔºåÂπ∂Ê†áËÆ∞‰∏∫Ê≠£Âú®‰ΩøÁî® */</span>
</span></span><span class="line"><span class="cl">            <span class="nf">serverAssert</span><span class="p">(</span><span class="nf">sdslen</span><span class="p">(</span><span class="n">thread_reusable_qb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">=</span> <span class="n">thread_reusable_qb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CLIENT_REUSABLE_QUERYBUFFER</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">thread_reusable_qb_used</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">qblen</span> <span class="o">=</span> <span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_MASTER</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="c1">// ‰∏ªÂÆ¢Êà∑Á´ØÁöÑÊü•ËØ¢ÁºìÂÜ≤Âå∫ÂèØ‰ª•Ë¥™Â©™Êâ©Â±ï
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">(</span><span class="n">big_arg</span> <span class="o">||</span> <span class="nf">sdsalloc</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">PROTO_IOBUF_LEN</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* Âú®ËØªÂèñÂ§ßÂèÇÊï∞Êó∂ÔºåÊàë‰ª¨‰∏ç‰ºöËØªÂèñË∂ÖËøá‰∏Ä‰∏™ÂèÇÊï∞ÁöÑÂÜÖÂÆπÂà∞Êü•ËØ¢ÁºìÂÜ≤Âå∫Ôºå
</span></span></span><span class="line"><span class="cl"><span class="cm">         * ÊâÄ‰ª•‰∏çÈúÄË¶ÅÈ¢ÑÂàÜÈÖçÂ§ö‰∫éÊâÄÈúÄÁöÑÁ©∫Èó¥ÔºåÂõ†Ê≠§‰ΩøÁî®ÈùûË¥™Â©™Êâ©Â±ï„ÄÇ */</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">=</span> <span class="nf">sdsMakeRoomForNonGreedy</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">,</span> <span class="n">readlen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* Á®çÂêéÂ∞ÜÂ≥∞ÂÄºËÆæÁΩÆ‰∏∫Â∑≤‰ΩøÁî®ÁöÑÈÉ®ÂàÜÔºå‰ΩÜËøôÈáåÊàë‰ª¨ËøáÂ∫¶ÂàÜÈÖçÔºåÂõ†‰∏∫Êàë‰ª¨Áü•ÈÅìÈúÄË¶ÅÁöÑÁ©∫Èó¥ÔºåÁ°Æ‰øùÂú®‰ΩøÁî®Ââç‰∏ç‰ºöË¢´Áº©Â∞è„ÄÇ */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf_peak</span> <span class="o">&lt;</span> <span class="n">qblen</span> <span class="o">+</span> <span class="n">readlen</span><span class="p">)</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf_peak</span> <span class="o">=</span> <span class="n">qblen</span> <span class="o">+</span> <span class="n">readlen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">=</span> <span class="nf">sdsMakeRoomFor</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">,</span> <span class="n">readlen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* ‰ªéÂ•óÊé•Â≠ó‰∏≠Â∞ΩÂèØËÉΩÂ§öÂú∞ËØªÂèñÊï∞ÊçÆÔºå‰ª•ËäÇÁúÅ read(2) Á≥ªÁªüË∞ÉÁî®Ê¨°Êï∞„ÄÇ */</span>
</span></span><span class="line"><span class="cl">        <span class="n">readlen</span> <span class="o">=</span> <span class="nf">sdsavail</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">nread</span> <span class="o">=</span> <span class="nf">connRead</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="o">+</span><span class="n">qblen</span><span class="p">,</span> <span class="n">readlen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">nread</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">connGetState</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span> <span class="o">==</span> <span class="n">CONN_STATE_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">serverLog</span><span class="p">(</span><span class="n">LL_VERBOSE</span><span class="p">,</span> <span class="s">&#34;‰ªéÂÆ¢Êà∑Á´ØËØªÂèñÊï∞ÊçÆÊó∂Âá∫Èîô: %s&#34;</span><span class="p">,</span> <span class="nf">connGetLastError</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="nf">freeClientAsync</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nread</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">verbosity</span> <span class="o">&lt;=</span> <span class="n">LL_VERBOSE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">sds</span> <span class="n">info</span> <span class="o">=</span> <span class="nf">catClientInfoString</span><span class="p">(</span><span class="nf">sdsempty</span><span class="p">(),</span> <span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">serverLog</span><span class="p">(</span><span class="n">LL_VERBOSE</span><span class="p">,</span> <span class="s">&#34;ÂÆ¢Êà∑Á´ØÂÖ≥Èó≠‰∫ÜËøûÊé• %s&#34;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">sdsfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">freeClientAsync</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Êõ¥Êñ∞Êü•ËØ¢ÁºìÂÜ≤Âå∫ÁöÑÈïøÂ∫¶ */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">sdsIncrLen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">,</span> <span class="n">nread</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">qblen</span> <span class="o">=</span> <span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf_peak</span> <span class="o">&lt;</span> <span class="n">qblen</span><span class="p">)</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf_peak</span> <span class="o">=</span> <span class="n">qblen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Êõ¥Êñ∞ÊúÄÂêé‰∫§‰∫íÊó∂Èó¥ */</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span><span class="o">-&gt;</span><span class="n">lastinteraction</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">unixtime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_MASTER</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="o">-&gt;</span><span class="n">read_reploff</span> <span class="o">+=</span> <span class="n">nread</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">atomicIncr</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">stat_net_repl_input_bytes</span><span class="p">,</span> <span class="n">nread</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">atomicIncr</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">stat_net_input_bytes</span><span class="p">,</span> <span class="n">nread</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* ÂØπ‰∫éÊôÆÈÄöÂÆ¢Êà∑Á´ØÔºåÂ¶ÇÊûúÊü•ËØ¢ÁºìÂÜ≤Âå∫ÁöÑÂ§ßÂ∞èË∂ÖËøáÈôêÂà∂ÊàñÈúÄË¶ÅË∫´‰ªΩÈ™åËØÅÔºåÂàôÂÖ≥Èó≠ÂÆ¢Êà∑Á´ØËøûÊé• */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_MASTER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* MULTI/EXEC ÈòüÂàó‰∏≠ÁöÑÂëΩ‰ª§Â∞öÊú™ÊâßË°åÔºåÂõ†Ê≠§ÂÆÉ‰ª¨‰πüÁÆó‰ΩúÊü•ËØ¢ÁºìÂÜ≤Âå∫ÁöÑ‰∏ÄÈÉ®ÂàÜ */</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mstate</span><span class="p">.</span><span class="n">argv_len_sums</span> <span class="o">+</span> <span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">server</span><span class="p">.</span><span class="n">client_max_querybuf_len</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">         <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">mstate</span><span class="p">.</span><span class="n">argv_len_sums</span> <span class="o">+</span> <span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span> <span class="o">&amp;&amp;</span> <span class="nf">authRequired</span><span class="p">(</span><span class="n">c</span><span class="p">))))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">sds</span> <span class="n">ci</span> <span class="o">=</span> <span class="nf">catClientInfoString</span><span class="p">(</span><span class="nf">sdsempty</span><span class="p">(),</span><span class="n">c</span><span class="p">),</span> <span class="n">bytes</span> <span class="o">=</span> <span class="nf">sdsempty</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">bytes</span> <span class="o">=</span> <span class="nf">sdscatrepr</span><span class="p">(</span><span class="n">bytes</span><span class="p">,</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">,</span><span class="mi">64</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">serverLog</span><span class="p">(</span><span class="n">LL_WARNING</span><span class="p">,</span><span class="s">&#34;ÂÖ≥Èó≠ÂÆ¢Êà∑Á´ØÔºåÊü•ËØ¢ÁºìÂÜ≤Âå∫Ë∂ÖËøáÊúÄÂ§ßÈôêÂà∂: %s (Êü•ËØ¢ÁºìÂÜ≤Âå∫ÂàùÂßãÂ≠óËäÇ: %s)&#34;</span><span class="p">,</span> <span class="n">ci</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sdsfree</span><span class="p">(</span><span class="n">ci</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sdsfree</span><span class="p">(</span><span class="n">bytes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">freeClientAsync</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">atomicIncr</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">stat_client_qbuf_limit_disconnections</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Â¶ÇÊûúÂÆ¢Êà∑Á´ØËæìÂÖ•ÁºìÂÜ≤Âå∫ËøòÊúâÊï∞ÊçÆÔºåÁªßÁª≠Ëß£ÊûêÂπ∂Ê£ÄÊü•ÊòØÂê¶ÊúâÂÆåÊï¥ÁöÑÂëΩ‰ª§ÈúÄË¶ÅÊâßË°å */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">processInputBuffer</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="n">C_ERR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="n">c</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nl">done</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_REUSABLE_QUERYBUFFER</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">serverAssert</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* Á°Æ‰øùÂÆ¢Êà∑Á´ØÁöÑÊü•ËØ¢ÁºìÂÜ≤Âå∫Âú® processInputBuffer ‰∏≠Ë¢´‰øÆÂâ™ */</span>
</span></span><span class="line"><span class="cl">        <span class="nf">resetReusableQueryBuf</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">beforeNextClient</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="processinputbufferËØªÂèñclientËØ∑Ê±Ç‰ø°ÊÅØ">processInputBufferËØªÂèñclientËØ∑Ê±Ç‰ø°ÊÅØ
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* ËØ•ÂáΩÊï∞Âú®ÊØèÊ¨°ÂÆ¢Êà∑Á´ØÁªìÊûÑ‰Ωì &#39;c&#39; ‰∏≠ÊúâÊõ¥Â§öÊü•ËØ¢ÁºìÂÜ≤Âå∫ÈúÄË¶ÅÂ§ÑÁêÜÊó∂Ë¢´Ë∞ÉÁî®Ôºå
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ÂèØËÉΩÊòØÂõ†‰∏∫Êàë‰ª¨‰ªéÂ•óÊé•Â≠óËØªÂèñ‰∫ÜÊõ¥Â§öÁöÑÊï∞ÊçÆÔºåÊàñËÄÖÂÆ¢Êà∑Á´ØË¢´ÈòªÂ°ûÂπ∂Âú®‰πãÂêéÈáçÊñ∞ÊøÄÊ¥ªÔºå
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ÊâÄ‰ª•ÂèØËÉΩÂ≠òÂú®ÂæÖÂ§ÑÁêÜÁöÑÊü•ËØ¢ÁºìÂÜ≤Âå∫ÔºåËøô‰∫õÁºìÂÜ≤Âå∫ÂèØËÉΩÂ∑≤Áªè‰ª£Ë°®‰∏Ä‰∏™ÂÆåÊï¥ÁöÑÂëΩ‰ª§ÈúÄË¶ÅÂ§ÑÁêÜ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Â¶ÇÊûúÂú®Â§ÑÁêÜËøáÁ®ã‰∏≠ÂÆ¢Êà∑Á´ØÂ∑≤ÁªèË¢´ÈáäÊîæÔºåÂàôËøîÂõû C_ERR */</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">processInputBuffer</span><span class="p">(</span><span class="n">client</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* ÂΩìËæìÂÖ•ÁºìÂÜ≤Âå∫ÊúâÂÜÖÂÆπÊó∂ÔºåÁªßÁª≠Â§ÑÁêÜ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">&lt;</span> <span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* Â¶ÇÊûúÂÆ¢Êà∑Á´ØÂΩìÂâçË¢´ÈòªÂ°ûÔºåÁ´ãÂç≥‰∏≠Ê≠¢ */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_BLOCKED</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Â¶ÇÊûúÂÆ¢Êà∑Á´ØÊúâÂæÖÂ§ÑÁêÜÁöÑÂëΩ‰ª§Ôºå‰∏çË¶ÅÁªßÁª≠Â§ÑÁêÜÊõ¥Â§öÁöÑÁºìÂÜ≤Âå∫ */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_PENDING_COMMAND</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Â¶ÇÊûúÂÆ¢Êà∑Á´ØÊòØ‰∏ªÂÆ¢Êà∑Á´ØÔºåÂπ∂‰∏îÂΩìÂâçÊúâÂøôÁ¢åËÑöÊú¨ÔºåÊöÇÂÅúÂ§ÑÁêÜËæìÂÖ• */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">isInsideYieldingLongCommand</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_MASTER</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Â¶ÇÊûúËÆæÁΩÆ‰∫Ü CLIENT_CLOSE_AFTER_REPLY Ê†áÂøóÔºåÂ§ÑÁêÜÂÆåÂõûÂ§çÂêéÂ∞±ÂÖ≥Èó≠ËøûÊé•Ôºå
</span></span></span><span class="line"><span class="cl"><span class="cm">         * ‰∏çÂÖÅËÆ∏ÁªßÁª≠Â§ÑÁêÜÊõ¥Â§öÁöÑÂëΩ‰ª§ */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CLIENT_CLOSE_AFTER_REPLY</span><span class="o">|</span><span class="n">CLIENT_CLOSE_ASAP</span><span class="p">))</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Â¶ÇÊûúËØ∑Ê±ÇÁ±ªÂûãÊú™Áü•ÔºåÂà§Êñ≠ËØ∑Ê±ÇÁ±ªÂûã */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">reqtype</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;*&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">c</span><span class="o">-&gt;</span><span class="n">reqtype</span> <span class="o">=</span> <span class="n">PROTO_REQ_MULTIBULK</span><span class="p">;</span>  <span class="c1">// Â§öÊâπÈáèËØ∑Ê±Ç
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">c</span><span class="o">-&gt;</span><span class="n">reqtype</span> <span class="o">=</span> <span class="n">PROTO_REQ_INLINE</span><span class="p">;</span>  <span class="c1">// ÂçïË°åÂëΩ‰ª§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Ê†πÊçÆËØ∑Ê±ÇÁ±ªÂûãÂ§ÑÁêÜÁºìÂÜ≤Âå∫ */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">reqtype</span> <span class="o">==</span> <span class="n">PROTO_REQ_INLINE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nf">processInlineBuffer</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">!=</span> <span class="n">C_OK</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>  <span class="c1">// Â§ÑÁêÜÂçïË°åÂëΩ‰ª§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">reqtype</span> <span class="o">==</span> <span class="n">PROTO_REQ_MULTIBULK</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nf">processMultibulkBuffer</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">!=</span> <span class="n">C_OK</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>  <span class="c1">// Â§ÑÁêÜÂ§öÊâπÈáèÂëΩ‰ª§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">serverPanic</span><span class="p">(</span><span class="s">&#34;Unknown request type&#34;</span><span class="p">);</span>  <span class="c1">// Êú™Áü•ÁöÑËØ∑Ê±ÇÁ±ªÂûãÔºåÁ®ãÂ∫èÂ¥©Ê∫É
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Â§öÊâπÈáèËØ∑Ê±ÇÂ§ÑÁêÜÂèØËÉΩÂØºËá¥ argc &lt;= 0 */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">resetClientInternal</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>  <span class="c1">// Â¶ÇÊûúÊ≤°ÊúâÊúâÊïàÁöÑÂèÇÊï∞ÔºåÈáçÁΩÆÂÆ¢Êà∑Á´Ø
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* Â¶ÇÊûúÊòØ I/O Á∫øÁ®ã‰∏ä‰∏ãÊñáÔºå‰∏çËÉΩÂú®Ê≠§ÊâßË°åÂëΩ‰ª§ÔºåÂè™ËÉΩÊ†áËÆ∞ÂÆ¢Êà∑Á´ØÈúÄË¶ÅÂ§ÑÁêÜÂëΩ‰ª§ */</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">io_threads_op</span> <span class="o">!=</span> <span class="n">IO_THREADS_OP_IDLE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">serverAssert</span><span class="p">(</span><span class="n">io_threads_op</span> <span class="o">==</span> <span class="n">IO_THREADS_OP_READ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CLIENT_PENDING_COMMAND</span><span class="p">;</span>  <span class="c1">// ËÆæÁΩÆ‰∏∫ÂæÖÂ§ÑÁêÜÂëΩ‰ª§Áä∂ÊÄÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="cm">/* ÂáÜÂ§áÂ•ΩÊâßË°åÂëΩ‰ª§‰∫Ü */</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nf">processCommandAndResetClient</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="n">C_ERR</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="cm">/* Â¶ÇÊûúÂÆ¢Êà∑Á´ØÂ∑≤Áªè‰∏çÂÜçÊúâÊïàÔºåÈÅøÂÖçÁªßÁª≠ÊâßË°åÔºåÁõ¥Êé•ËøîÂõû */</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Â¶ÇÊûúÂÆ¢Êà∑Á´ØÊòØ‰∏ªÂÆ¢Êà∑Á´ØÔºåÈúÄË¶ÅË£ÅÂâ™Êü•ËØ¢ÁºìÂÜ≤Âå∫ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_MASTER</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* Â¶ÇÊûúÂÆ¢Êà∑Á´ØÊòØ‰∏ªÂÆ¢Êà∑Á´ØÔºåË£ÅÂâ™Êü•ËØ¢ÁºìÂÜ≤Âå∫Âà∞ repl_applied ÊåáÂÆöÁöÑ‰ΩçÁΩÆÔºå
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Âõ†‰∏∫‰∏ªÂÆ¢Êà∑Á´ØÁöÑÊü•ËØ¢ÁºìÂÜ≤Âå∫‰∏ç‰ªÖÁî®‰∫éËß£ÊûêÂëΩ‰ª§ÔºåËøòÁî®‰∫é‰ª£ÁêÜÁªôÂ≠êÂ§çÂà∂ÂÆû‰æã„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         * ÈúÄË¶ÅË£ÅÂâ™Êü•ËØ¢ÁºìÂÜ≤Âå∫ÁöÑÂú∫ÊôØÔºö
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 1. Ê≤°ÊúâÊé•Êî∂Âà∞ÂÆåÊï¥ÁöÑÂëΩ‰ª§
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 2. ‰∏ªÂÆ¢Êà∑Á´ØÂõ†‰∏∫ÂÆ¢Êà∑Á´ØÊöÇÂÅúËÄåË¢´ÈòªÂ°û
</span></span></span><span class="line"><span class="cl"><span class="cm">         * 3. I/O Á∫øÁ®ãÊìç‰ΩúËØªÂèñÔºå‰∏ªÂÆ¢Êà∑Á´ØË¢´Ê†áËÆ∞‰∏∫ CLIENT_PENDING_COMMAND
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Âú®Ëøô‰∫õÂú∫ÊôØ‰∏ãÔºåqb_pos ÊåáÂêëÂΩìÂâçÂëΩ‰ª§ÁöÑ‰∏ÄÈÉ®ÂàÜÊàñ‰∏ã‰∏Ä‰∏™ÂëΩ‰ª§ÁöÑÂºÄÂßã‰ΩçÁΩÆÔºå
</span></span></span><span class="line"><span class="cl"><span class="cm">         * ÂΩìÂâçÂëΩ‰ª§Â∞öÊú™Â∫îÁî®ÔºåÂõ†Ê≠§ repl_applied ‰∏çÁ≠â‰∫é qb_pos„ÄÇ*/</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">repl_applied</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">sdsrange</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">repl_applied</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>  <span class="c1">// Ââ©‰ΩôÁöÑÂëΩ‰ª§Êï∞ÊçÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">-=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">repl_applied</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span><span class="o">-&gt;</span><span class="n">repl_applied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* Â¶ÇÊûúÂÆ¢Êà∑Á´Ø‰∏çÊòØ‰∏ªÂÆ¢Êà∑Á´ØÔºåË£ÅÂâ™Êü•ËØ¢ÁºìÂÜ≤Âå∫ */</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sdsrange</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>  <span class="c1">// Â∞ÜÊü•ËØ¢ÁºìÂÜ≤Âå∫Ë£ÅÂâ™Âà∞ÂΩìÂâç‰ΩçÁΩÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// ÈáçÁΩÆÊü•ËØ¢ÁºìÂÜ≤Âå∫‰ΩçÁΩÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Âú®Â§ÑÁêÜÊü•ËØ¢ÁºìÂÜ≤Âå∫ÂêéÊõ¥Êñ∞ÂÆ¢Êà∑Á´ØÁöÑÂÜÖÂ≠ò‰ΩøÁî®ÊÉÖÂÜµÔºå
</span></span></span><span class="line"><span class="cl"><span class="cm">     * ËøôÂØπÊü•ËØ¢ÁºìÂÜ≤Âå∫ÊØîËæÉÂ§ß‰∏îÊ≤°ÊúâÂú®‰∏äËø∞Âæ™ÁéØ‰∏≠Ë¢´ÂÆåÂÖ®Â§ÑÁêÜÁöÑÂÆ¢Êà∑Á´ØÂæàÈáçË¶ÅÔºà
</span></span></span><span class="line"><span class="cl"><span class="cm">     * ‰æãÂ¶ÇÈÉ®ÂàÜÂèëÈÄÅÁöÑÂ§ßÂëΩ‰ª§Ôºâ„ÄÇ*/</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">io_threads_op</span> <span class="o">==</span> <span class="n">IO_THREADS_OP_IDLE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">updateClientMemUsageAndBucket</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">C_OK</span><span class="p">;</span>  <span class="c1">// ËøîÂõûÂ§ÑÁêÜÊàêÂäü
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ÂçèËÆÆËß£Êûê">ÂçèËÆÆËß£Êûê
</h4><ul>
<li>processInlineBufferÔºöset a bËøôÊ†∑ÁöÑÁÆÄÂçïÂëΩ‰ª§</li>
<li>processMultibulkBufferÔºömset a b c dËøôÊ†∑ÁöÑÂ§çÂêàÂëΩ‰ª§</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* Á±ª‰ºº‰∫é processMultibulkBuffer()Ôºå‰ΩÜÊòØÁî®‰∫éÂ§ÑÁêÜ inline ÂçèËÆÆÔºåËÄå‰∏çÊòØ RESP ÂçèËÆÆ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ËØ•ÂáΩÊï∞Ê∂àËÄóÂÆ¢Êà∑Á´ØÁöÑÊü•ËØ¢ÁºìÂÜ≤Âå∫ÔºåÂπ∂Âú®ÂÆ¢Êà∑Á´ØÁªìÊûÑ‰Ωì‰∏≠ÂàõÂª∫‰∏Ä‰∏™ÂáÜÂ§áÊâßË°åÁöÑÂëΩ‰ª§„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Â¶ÇÊûúÂëΩ‰ª§Â∑≤ÁªèÂáÜÂ§áÂ•ΩÊâßË°åÔºåÂàôËøîÂõû C_OKÔºõÂ¶ÇÊûú‰ªçÁÑ∂ÈúÄË¶ÅËØªÂèñÊõ¥Â§öÂçèËÆÆÊï∞ÊçÆÊâçËÉΩÂΩ¢Êàê‰∏Ä‰∏™ÊúâÊïàÁöÑÂëΩ‰ª§ÔºåÂàôËøîÂõû C_ERR„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ÂΩìÂá∫Áé∞ÂçèËÆÆÈîôËØØÊó∂ÔºåËøîÂõû C_ERRÔºõÂú®ËøôÁßçÊÉÖÂÜµ‰∏ãÔºåÂÆ¢Êà∑Á´ØÁªìÊûÑ‰Ωì‰ºöË¢´ËÆæÁΩÆ‰∏∫ÂõûÂ§çÈîôËØØÂπ∂ÂÖ≥Èó≠ËøûÊé•„ÄÇ */</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">processInlineBuffer</span><span class="p">(</span><span class="n">client</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">newline</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">linefeed_chars</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">sds</span> <span class="o">*</span><span class="n">argv</span><span class="p">,</span> <span class="n">aux</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">size_t</span> <span class="n">querylen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Êü•ÊâæÊç¢Ë°åÁ¨¶ÁöÑ‰ΩçÁΩÆ */</span>
</span></span><span class="line"><span class="cl">    <span class="n">newline</span> <span class="o">=</span> <span class="nf">strchr</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ \r\n ÂàôËøîÂõûÔºå‰∏çÂÅöÂ§ÑÁêÜ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">newline</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">)</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">&gt;</span> <span class="n">PROTO_INLINE_MAX_SIZE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">addReplyError</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&#34;Protocol error: too big inline request&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">setProtocolError</span><span class="p">(</span><span class="s">&#34;too big inline request&#34;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Â§ÑÁêÜ \r\n ÁöÑÊÉÖÂÜµ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">newline</span> <span class="o">!=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="n">newline</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;\r&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">newline</span><span class="o">--</span><span class="p">;</span>  <span class="c1">// Â∞Ü newline ÊåáÂêë \r ÁöÑÂâç‰∏Ä‰∏™Â≠óÁ¨¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">linefeed_chars</span><span class="o">++</span><span class="p">;</span>  <span class="c1">// ËÆ°ÁÆóÊç¢Ë°åÁ¨¶ÁöÑÂ≠óÁ¨¶Êï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Êà™Âèñ‰ªéÂΩìÂâçÊåáÈíàÂà∞ \r\n ‰πãÈó¥ÁöÑÂÜÖÂÆπ */</span>
</span></span><span class="line"><span class="cl">    <span class="n">querylen</span> <span class="o">=</span> <span class="n">newline</span> <span class="o">-</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">aux</span> <span class="o">=</span> <span class="nf">sdsnewlen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">,</span> <span class="n">querylen</span><span class="p">);</span>  <span class="c1">// ÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑ sds Â≠óÁ¨¶‰∏≤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">argv</span> <span class="o">=</span> <span class="nf">sdssplitargs</span><span class="p">(</span><span class="n">aux</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">argc</span><span class="p">);</span>  <span class="c1">// ÂàÜÂâ≤ÂëΩ‰ª§Ë°åÂèÇÊï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">sdsfree</span><span class="p">(</span><span class="n">aux</span><span class="p">);</span>  <span class="c1">// ÈáäÊîæ‰∏¥Êó∂ÂèòÈáè aux
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">argv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">addReplyError</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&#34;Protocol error: unbalanced quotes in request&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">setProtocolError</span><span class="p">(</span><span class="s">&#34;unbalanced quotes in inline request&#34;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Â¶ÇÊûúÊü•ËØ¢ÈïøÂ∫¶‰∏∫ 0 ‰∏îÂÆ¢Êà∑Á´ØÊòØ‰ªéÂ±ûËäÇÁÇπÔºå
</span></span></span><span class="line"><span class="cl"><span class="cm">     * ÂàôË°®Á§∫ÈÄöËøáÊç¢Ë°åÁ¨¶Âà∑Êñ∞ÊúÄÂêéÁöÑ ACK Êó∂Èó¥„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">     * ËøôÊòØ‰∏∫‰∫ÜËÆ©‰ªéÂ±ûËäÇÁÇπÂú®Âä†ËΩΩÂ§ßÂûã RDB Êñá‰ª∂Êó∂ËÉΩÂ§üÊåÅÁª≠‰øùÊåÅËøûÊé• */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">querylen</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nf">clientTypeIsSlave</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="o">-&gt;</span><span class="n">repl_ack_time</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">unixtime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* ‰∏ªËäÇÁÇπ‰∏çÂ∫îËØ•ÂèëÈÄÅ inline ÂçèËÆÆÊù•ÊâßË°åÂÆûÈôÖÁöÑÂëΩ‰ª§„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Â¶ÇÊûúÂèëÁîüËøôÁßçÊÉÖÂÜµÔºåÂèØËÉΩÊòØ Redis ÂçèËÆÆÂá∫Áé∞‰∫ÜÂêåÊ≠•ÈóÆÈ¢òÔºå
</span></span></span><span class="line"><span class="cl"><span class="cm">     * ÊØîÂ¶ÇÁî±‰∫é PSYNC Âá∫ÈîôÂØºËá¥ÁöÑÂçèËÆÆ‰∏ç‰∏ÄËá¥„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">     *
</span></span></span><span class="line"><span class="cl"><span class="cm">     * ‰ΩÜÊòØÊúâ‰∏Ä‰∏™‰æãÂ§ñÔºö‰∏ªËäÇÁÇπÂèØËÉΩÂè™‰ºöÂèëÈÄÅ‰∏Ä‰∏™Êç¢Ë°åÁ¨¶Êù•‰øùÊåÅËøûÊé•Ê¥ªÂä®„ÄÇ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">querylen</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_MASTER</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">sdsfreesplitres</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="n">argc</span><span class="p">);</span>  <span class="c1">// ÈáäÊîæÂèÇÊï∞Êï∞ÁªÑ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">serverLog</span><span class="p">(</span><span class="n">LL_WARNING</span><span class="p">,</span> <span class="s">&#34;WARNING: Receiving inline protocol from master, master stream corruption? Closing the master connection and discarding the cached master.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">setProtocolError</span><span class="p">(</span><span class="s">&#34;Master using the inline protocol. Desync?&#34;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* ÁßªÂä®Êü•ËØ¢ÁºìÂÜ≤Âå∫‰ΩçÁΩÆÔºåÊåáÂêë‰∏ã‰∏Ä‰∏™Êü•ËØ¢ÂëΩ‰ª§ */</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">+=</span> <span class="n">querylen</span> <span class="o">+</span> <span class="n">linefeed_chars</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Âú®ÂÆ¢Êà∑Á´ØÁªìÊûÑ‰Ωì‰∏≠ËÆæÁΩÆ argv Êï∞ÁªÑ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* Â¶ÇÊûúÂèÇÊï∞Êï∞ÈáèË∂ÖËøáÂΩìÂâçÂàÜÈÖçÁöÑÁ©∫Èó¥ÔºåÈáçÊñ∞ÂàÜÈÖçÂÜÖÂ≠ò */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">zfree</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">);</span>  <span class="c1">// ÈáäÊîæÊóßÁöÑ argv
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span> <span class="o">=</span> <span class="nf">zmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">robj</span><span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">argc</span><span class="p">);</span>  <span class="c1">// ÂàÜÈÖçÊñ∞ÁöÑ argv Êï∞ÁªÑ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len</span> <span class="o">=</span> <span class="n">argc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len_sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// ÈáçÁΩÆÂèÇÊï∞ÈïøÂ∫¶ÊÄªÂíå
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* ‰∏∫ÊâÄÊúâÁöÑÂèÇÊï∞ÂàõÂª∫ Redis ÂØπË±° */</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">]</span> <span class="o">=</span> <span class="nf">createObject</span><span class="p">(</span><span class="n">OBJ_STRING</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>  <span class="c1">// ÂàõÂª∫Â≠óÁ¨¶‰∏≤Á±ªÂûãÁöÑ Redis ÂØπË±°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">c</span><span class="o">-&gt;</span><span class="n">argc</span><span class="o">++</span><span class="p">;</span>  <span class="c1">// Â¢ûÂä†ÂèÇÊï∞ËÆ°Êï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len_sum</span> <span class="o">+=</span> <span class="nf">sdslen</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>  <span class="c1">// Êõ¥Êñ∞ÂèÇÊï∞ÊÄªÈïøÂ∫¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nf">zfree</span><span class="p">(</span><span class="n">argv</span><span class="p">);</span>  <span class="c1">// ÈáäÊîæ‰∏¥Êó∂ÂàÜÂâ≤ÂêéÁöÑÂèÇÊï∞Êï∞ÁªÑ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">C_OK</span><span class="p">;</span>  <span class="c1">// ËøîÂõûÂëΩ‰ª§Â∑≤ÂáÜÂ§áÂ•ΩÊâßË°å
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* Â§ÑÁêÜÂÆ¢Êà∑Á´Ø &#39;c&#39; ÁöÑÊü•ËØ¢ÁºìÂÜ≤Âå∫ÔºåÂπ∂‰∏∫ÂëΩ‰ª§ÊâßË°åËÆæÁΩÆÂÆ¢Êà∑Á´ØÁöÑÂèÇÊï∞ÂêëÈáè„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Â¶ÇÊûúÂÆ¢Êà∑Á´ØÊúâ‰∏Ä‰∏™Ê†ºÂºèÊ≠£Á°Æ„ÄÅÂáÜÂ§áÊâßË°åÁöÑÂëΩ‰ª§ÔºåËøîÂõû C_OKÔºå
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Âê¶ÂàôÔºåÂ¶ÇÊûúËøòÈúÄË¶ÅÊõ¥Â§öÁöÑÊï∞ÊçÆÊâçËÉΩËé∑ÂæóÂÆåÊï¥ÁöÑÂëΩ‰ª§ÔºåËøîÂõû C_ERR„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Â¶ÇÊûúÂá∫Áé∞ÂçèËÆÆÈîôËØØÔºåËøîÂõû C_ERRÔºõÂú®ËøôÁßçÊÉÖÂÜµ‰∏ãÔºåÂÆ¢Êà∑Á´ØÁªìÊûÑ‰ºöË¢´ËÆæÁΩÆ‰∏∫ÂõûÂ§çÈîôËØØÂπ∂ÂÖ≥Èó≠ËøûÊé•„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ÂΩì processInputBuffer() Ê£ÄÊµãÂà∞‰∏ã‰∏Ä‰∏™ÂëΩ‰ª§ÊòØ RESP Ê†ºÂºèÊó∂‰ºöË∞ÉÁî®Ê≠§ÂáΩÊï∞Ôºå
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Âõ†‰∏∫ÂëΩ‰ª§ÁöÑÁ¨¨‰∏Ä‰∏™Â≠óËäÇÊòØ &#39;*&#39;„ÄÇÂê¶ÂàôÔºåÂØπ‰∫é inline ÂëΩ‰ª§‰ºöË∞ÉÁî® processInlineBuffer()„ÄÇ*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">processMultibulkBuffer</span><span class="p">(</span><span class="n">client</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="o">*</span><span class="n">newline</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">long</span> <span class="kt">long</span> <span class="n">ll</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">multibulklen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* ÂÆ¢Êà∑Á´ØÂ∫îËØ•Â∑≤ÁªèË¢´ÈáçÁΩÆ */</span>
</span></span><span class="line"><span class="cl">        <span class="nf">serverAssertWithInfo</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Â§öÈáçÊâπÈáèÈïøÂ∫¶‰∏çËÉΩÂú®Ê≤°Êúâ \r\n ÁöÑÊÉÖÂÜµ‰∏ãËØªÂèñ */</span>
</span></span><span class="line"><span class="cl">        <span class="n">newline</span> <span class="o">=</span> <span class="nf">strchr</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">,</span> <span class="sc">&#39;\r&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">newline</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">)</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">&gt;</span> <span class="n">PROTO_INLINE_MAX_SIZE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">addReplyError</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&#34;Protocol error: too big mbulk count string&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">setProtocolError</span><span class="p">(</span><span class="s">&#34;too big mbulk count string&#34;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* ÁºìÂÜ≤Âå∫‰∏≠Â∫î‰πüÂåÖÂê´ \n */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">newline</span> <span class="o">-</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)(</span><span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">)</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Á°ÆÂÆöËøôÊòØ‰∏ÄÊï¥Ë°åÔºåÂõ†‰∏∫ newline != NULLÔºå
</span></span></span><span class="line"><span class="cl"><span class="cm">         * ÊâÄ‰ª•ÂèØ‰ª•ÁªßÁª≠Ëß£ÊûêÂ§öÈáçÊâπÈáèÈïøÂ∫¶ */</span>
</span></span><span class="line"><span class="cl">        <span class="nf">serverAssertWithInfo</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;*&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ok</span> <span class="o">=</span> <span class="nf">string2ll</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">,</span> <span class="n">newline</span> <span class="o">-</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ll</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span> <span class="o">||</span> <span class="n">ll</span> <span class="o">&gt;</span> <span class="n">INT_MAX</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">addReplyError</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&#34;Protocol error: invalid multibulk length&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">setProtocolError</span><span class="p">(</span><span class="s">&#34;invalid mbulk count&#34;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ll</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="nf">authRequired</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">addReplyError</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&#34;Protocol error: unauthenticated multibulk length&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">setProtocolError</span><span class="p">(</span><span class="s">&#34;unauth mbulk count&#34;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">newline</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">ll</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">C_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="o">-&gt;</span><span class="n">multibulklen</span> <span class="o">=</span> <span class="n">ll</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Âú®ÂÆ¢Êà∑Á´ØÁªìÊûÑ‰Ωì‰∏≠ËÆæÁΩÆ argv Êï∞ÁªÑ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Â¶ÇÊûúÁ©∫Èó¥‰∏çË∂≥ÊàñËÄÖÈúÄË¶ÅÈÄêÊ≠•ÂàÜÈÖçÁ©∫Èó¥ÔºåÂàõÂª∫Êñ∞ÁöÑ argv */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">multibulklen</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len</span> <span class="o">||</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">multibulklen</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">zfree</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">multibulklen</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span> <span class="o">=</span> <span class="nf">zmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">robj</span><span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len_sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">serverAssertWithInfo</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">multibulklen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">multibulklen</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* Â¶ÇÊûúÊú™Áü•ÔºåËØªÂèñÊâπÈáèÈïøÂ∫¶ */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bulklen</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">newline</span> <span class="o">=</span> <span class="nf">strchr</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">,</span> <span class="sc">&#39;\r&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">newline</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">)</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">&gt;</span> <span class="n">PROTO_INLINE_MAX_SIZE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">addReplyError</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&#34;Protocol error: too big bulk count string&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">setProtocolError</span><span class="p">(</span><span class="s">&#34;too big bulk count string&#34;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="cm">/* ÁºìÂÜ≤Âå∫‰∏≠‰πüÂ∫îËØ•ÂåÖÂê´ \n */</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">newline</span> <span class="o">-</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)(</span><span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">)</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;$&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">addReplyErrorFormat</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&#34;Protocol error: expected &#39;$&#39;, got &#39;%c&#39;&#34;</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">setProtocolError</span><span class="p">(</span><span class="s">&#34;expected $ but got something else&#34;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">ok</span> <span class="o">=</span> <span class="nf">string2ll</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">newline</span> <span class="o">-</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ll</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span> <span class="o">||</span> <span class="n">ll</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">                <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_MASTER</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ll</span> <span class="o">&gt;</span> <span class="n">server</span><span class="p">.</span><span class="n">proto_max_bulk_len</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">addReplyError</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&#34;Protocol error: invalid bulk length&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">setProtocolError</span><span class="p">(</span><span class="s">&#34;invalid bulk length&#34;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ll</span> <span class="o">&gt;</span> <span class="mi">16384</span> <span class="o">&amp;&amp;</span> <span class="nf">authRequired</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">addReplyError</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s">&#34;Protocol error: unauthenticated bulk length&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">setProtocolError</span><span class="p">(</span><span class="s">&#34;unauth bulk length&#34;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">=</span> <span class="n">newline</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_MASTER</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ll</span> <span class="o">&gt;=</span> <span class="n">PROTO_MBULK_BIG_ARG</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="cm">/* Â¶ÇÊûúÂÆ¢Êà∑Á´Ø‰∏çÊòØ‰∏ªËäÇÁÇπÔºàÂõ†‰∏∫‰∏ªËäÇÁÇπÁöÑÊü•ËØ¢ÁºìÂÜ≤Âå∫Âè™ËÉΩÂú®Êï∞ÊçÆÂ∫îÁî®Âπ∂ÂèëÈÄÅÁªô‰ªéËäÇÁÇπÂêé‰øÆÂâ™Ôºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">                 *
</span></span></span><span class="line"><span class="cl"><span class="cm">                 * Â¶ÇÊûúÊàë‰ª¨Â∞Ü‰ªéÁΩëÁªúËØªÂèñ‰∏Ä‰∏™ËæÉÂ§ßÁöÑÂØπË±°ÔºåÂ∞ùËØï‰ΩøÂÖ∂‰ªé c-&gt;querybuf ËæπÁïåÂºÄÂßãÔºåËøôÊ†∑ÂèØ‰ª•‰ºòÂåñÂØπË±°ÂàõÂª∫Ôºå
</span></span></span><span class="line"><span class="cl"><span class="cm">                 * ÈÅøÂÖçÂØπÊï∞ÊçÆËøõË°åÂ§ßÈáèÂ§çÂà∂„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">                 *
</span></span></span><span class="line"><span class="cl"><span class="cm">                 * ‰ΩÜÊòØÂè™ÊúâÂΩìÊú™Ëß£ÊûêÁöÑÊï∞ÊçÆÈïøÂ∫¶Â∞è‰∫éÊàñÁ≠â‰∫é ll+2 Êó∂ÊâçËøôÊ†∑ÂÅö„ÄÇÂê¶ÂàôÔºå‰øÆÂâ™Êü•ËØ¢ÁºìÂÜ≤Âå∫Â∞±ÊòØÊµ™Ë¥πÊó∂Èó¥Ôºå
</span></span></span><span class="line"><span class="cl"><span class="cm">                 * Âõ†‰∏∫Ê≠§Êó∂Êü•ËØ¢ÁºìÂÜ≤Âå∫‰∏ç‰ªÖ‰ªÖÂåÖÂê´Êàë‰ª¨ÁöÑÂ§ßÊâπÈáèÊï∞ÊçÆ„ÄÇ */</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">)</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">ll</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">sdsrange</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/* ÊèêÁ§∫ sds Â∫ìÊúâÂÖ≥Â≠óÁ¨¶‰∏≤ÈïøÂ∫¶ÁöÑÈ¢ÑÊúü */</span>
</span></span><span class="line"><span class="cl">                    <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">=</span> <span class="nf">sdsMakeRoomForNonGreedy</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">,</span> <span class="n">ll</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">-</span> <span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">                    <span class="cm">/* Êàë‰ª¨ÂêéÁª≠‰ºöËÆæÁΩÆÂ≥∞ÂÄº‰∏∫‰ΩøÁî®ÁöÑÈÉ®ÂàÜÔºå‰ΩÜÊ≠§Êó∂Ë∂ÖÈ¢ùÂàÜÈÖçÊòØ‰∏∫‰∫ÜÁ°Æ‰øù‰∏ç‰ºöÂú®‰ΩøÁî®ÂâçË¢´Áº©Â∞è */</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf_peak</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">ll</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf_peak</span> <span class="o">=</span> <span class="n">ll</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span><span class="o">-&gt;</span><span class="n">bulklen</span> <span class="o">=</span> <span class="n">ll</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* ËØªÂèñÊâπÈáèÂèÇÊï∞ */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">)</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bulklen</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* Êï∞ÊçÆ‰∏çË∂≥Ôºà+2 ÊòØÊåáÂ∞æÈÉ®ÁöÑ \r\nÔºâ */</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="cm">/* Ê£ÄÊü•ÊòØÂê¶ÊúâË∂≥Â§üÁöÑÁ©∫Èó¥Â≠òÂÇ®ÂèÇÊï∞ÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôËøõË°åÊâ©Â±ï */</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">&gt;=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len</span> <span class="o">&lt;</span> <span class="n">INT_MAX</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">?</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">:</span> <span class="n">INT_MAX</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">argc</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">multibulklen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span> <span class="o">=</span> <span class="nf">zrealloc</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">robj</span><span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="cm">/* ‰ºòÂåñÔºöÂ¶ÇÊûúÈùû‰∏ªËäÇÁÇπÂÆ¢Êà∑Á´ØÁöÑÁºìÂÜ≤Âå∫‰ªÖÂåÖÂê´Êàë‰ª¨ÁöÑÊâπÈáèÂÖÉÁ¥†Ôºå
</span></span></span><span class="line"><span class="cl"><span class="cm">             * ÈÇ£‰πàÁõ¥Êé•‰ΩøÁî®ÂΩìÂâçÁöÑ sds Â≠óÁ¨¶‰∏≤ËÄå‰∏çÊòØÈÄöËøáÂ§çÂà∂ÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑÂØπË±° */</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_MASTER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                <span class="n">c</span><span class="o">-&gt;</span><span class="n">bulklen</span> <span class="o">&gt;=</span> <span class="n">PROTO_MBULK_BIG_ARG</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                <span class="nf">sdslen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">bulklen</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argc</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nf">createObject</span><span class="p">(</span><span class="n">OBJ_STRING</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len_sum</span> <span class="o">+=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bulklen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nf">sdsIncrLen</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">);</span> <span class="cm">/* ÂéªÈô§ CRLF */</span>
</span></span><span class="line"><span class="cl">                <span class="cm">/* ÂÅáËÆæÂ¶ÇÊûúÊàë‰ª¨ÁúãÂà∞‰∏Ä‰∏™Â§ßÁöÑÂèÇÊï∞ÔºåÊé•‰∏ãÊù•ÂèØËÉΩ‰ºöÁúãÂà∞Âè¶‰∏Ä‰∏™Á±ª‰ººÁöÑ */</span>
</span></span><span class="line"><span class="cl">                <span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">=</span> <span class="nf">sdsnewlen</span><span class="p">(</span><span class="n">SDS_NOINIT</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bulklen</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">sdsclear</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">[</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argc</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                    <span class="nf">createStringObject</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">querybuf</span> <span class="o">+</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bulklen</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">c</span><span class="o">-&gt;</span><span class="n">argv_len_sum</span> <span class="o">+=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bulklen</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">c</span><span class="o">-&gt;</span><span class="n">qb_pos</span> <span class="o">+=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">bulklen</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span><span class="o">-&gt;</span><span class="n">bulklen</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">c</span><span class="o">-&gt;</span><span class="n">multibulklen</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* ÂΩì c-&gt;multibulklen ‰∏∫ 0 Êó∂ÔºåË°®Á§∫ÂëΩ‰ª§Â§ÑÁêÜÂÆåÊàê */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">multibulklen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">C_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* ‰ªçÁÑ∂Ê≤°ÊúâÂáÜÂ§áÂ•ΩÂ§ÑÁêÜÂëΩ‰ª§ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="processcommandÂ§ÑÁêÜÂëΩ‰ª§">processCommandÂ§ÑÁêÜÂëΩ‰ª§
</h4><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* Ëøô‰∏™ÂáΩÊï∞Ë∞ÉÁî® processCommand()ÔºåÂêåÊó∂ÊâßË°å‰∏Ä‰∫õÂØπ‰∫éÂÆ¢Êà∑Á´ØÊù•ËØ¥ÊúâÁî®ÁöÑÈ¢ùÂ§ñ‰ªªÂä°Ôºö
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 1. Â∞ÜÂΩìÂâçÂÆ¢Êà∑Á´ØËÆæÁΩÆ‰∏∫ &#39;c&#39;„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm"> * 2. Â¶ÇÊûúÂëΩ‰ª§Â∑≤Â§ÑÁêÜÔºåÂàôË∞ÉÁî® commandProcessed()„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Â¶ÇÊûúÂ§ÑÁêÜÂëΩ‰ª§ËøáÁ®ã‰∏≠ÂÆ¢Êà∑Á´ØË¢´ÈáäÊîæÔºåÂàôËøîÂõû C_ERRÔºåÂê¶ÂàôËøîÂõû C_OK„ÄÇ */</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">processCommandAndResetClient</span><span class="p">(</span><span class="n">client</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">deadclient</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">client</span> <span class="o">*</span><span class="n">old_client</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">current_client</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// ËÆæÁΩÆÂΩìÂâçÂ§ÑÁêÜÁöÑÂÆ¢Êà∑Á´Ø‰∏∫ &#39;c&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">server</span><span class="p">.</span><span class="n">current_client</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// Â§ÑÁêÜÂëΩ‰ª§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nf">processCommand</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">==</span> <span class="n">C_OK</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â¶ÇÊûúÂëΩ‰ª§ÊàêÂäüÂ§ÑÁêÜÔºåË∞ÉÁî® commandProcessed()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nf">commandProcessed</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="c1">// Êõ¥Êñ∞ÂÆ¢Êà∑Á´ØÁöÑÂÜÖÂ≠ò‰ΩøÁî®ÊÉÖÂÜµÔºåËÄÉËôëÂà∞ÂëΩ‰ª§ÊâßË°åÂêéÂèØËÉΩÂØºËá¥ËæìÂá∫ÁºìÂÜ≤Âå∫ÁöÑÂ¢ûÈïø
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">)</span> <span class="nf">updateClientMemUsageAndBucket</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Ê£ÄÊü•ÂΩìÂâçÂÆ¢Êà∑Á´ØÊòØÂê¶‰∏∫Á©∫ÔºåÂ¶ÇÊûú‰∏∫Á©∫Ë°®Á§∫ÂÆ¢Êà∑Á´ØÂ∑≤ÁªèË¢´ÈáäÊîæ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">current_client</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="n">deadclient</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">     * ÊÅ¢Â§ç‰πãÂâçÁöÑÂÆ¢Êà∑Á´ØËÆæÁΩÆ„ÄÇËøô‰∏™ÊÅ¢Â§çÊòØÂøÖË¶ÅÁöÑÔºåÂõ†‰∏∫Âú®ËÑöÊú¨Ë∂ÖÊó∂ÁöÑÊÉÖÂÜµ‰∏ãÔºå
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Êàë‰ª¨‰ºö‰ªé processEventsWhileBlocked ‰∏≠ËøõÂÖ•ËØ•‰ª£Á†ÅÔºåËøô‰ºöÂØºËá¥ËÆæÁΩÆ server.current_client„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Â¶ÇÊûú‰∏çÊÅ¢Â§çÔºåÂèØËÉΩ‰ºöÈîôËØØÂú∞ËøîÂõû 1ÔºåË°®Á§∫ÂÆ¢Êà∑Á´ØÂ∑≤ÁªèÊ≠ªÊéâÔºåÂπ∂ÂÅúÊ≠¢‰ªéÂÆ¢Êà∑Á´ØÁºìÂÜ≤Âå∫ËØªÂèñÊï∞ÊçÆ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">     */</span>
</span></span><span class="line"><span class="cl">    <span class="n">server</span><span class="p">.</span><span class="n">current_client</span> <span class="o">=</span> <span class="n">old_client</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1">// performEvictions ÂèØËÉΩ‰ºöÂà∑Êñ∞‰ªéËäÇÁÇπÁöÑËæìÂá∫ÁºìÂÜ≤Âå∫ÔºåËøôÂèØËÉΩÂØºËá¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ‰ªéËäÇÁÇπÔºàÂèØËÉΩÊòØÂΩìÂâçÊ¥ªÂä®ÁöÑÂÆ¢Êà∑Á´ØÔºâË¢´ÈáäÊîæ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">deadclient</span> <span class="o">?</span> <span class="nl">C_ERR</span> <span class="p">:</span> <span class="n">C_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="8">
<li>ËøîÂõûÂÜôÂÖ•ÁöÑrespÁªôclientÔºöinitServer -&gt; aeSetBeforeSleepProc -&gt; beforeSleep -&gt; handleClientsWithPendingWritesUsingThreads -&gt; sendReplyToClient</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* Â∞ÜÊï∞ÊçÆÂÜôÂÖ•ÂÆ¢Êà∑Á´ØÁöÑËæìÂá∫ÁºìÂÜ≤Âå∫„ÄÇÂ¶ÇÊûúÂÆ¢Êà∑Á´ØÂú®Ë∞ÉÁî®Âêé‰ªçÁÑ∂ÊúâÊïàÔºåËøîÂõû C_OKÔºå
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Â¶ÇÊûúÂõ†ÈîôËØØËÄåË¢´ÈáäÊîæÔºåËøîÂõû C_ERR„ÄÇÂ¶ÇÊûúËÆæÁΩÆ‰∫Ü handler_installedÔºåÂàô‰ºöÂ∞ùËØïÊ∏ÖÈô§ÂÜô‰∫ã‰ª∂„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm"> *
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ËØ•ÂáΩÊï∞Áî±Á∫øÁ®ãË∞ÉÁî®Ôºå‰ΩÜÊÄªÊòØÂ∞Ü handler_installed ËÆæÁΩÆ‰∏∫ 0„ÄÇÂõ†Ê≠§ÔºåÂΩì handler_installed ËÆæÁΩÆ‰∏∫ 0 Êó∂Ôºå
</span></span></span><span class="line"><span class="cl"><span class="cm"> * ËØ•ÂáΩÊï∞ÂøÖÈ°ªÊòØÁ∫øÁ®ãÂÆâÂÖ®ÁöÑ„ÄÇ*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">writeToClient</span><span class="p">(</span><span class="n">client</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">handler_installed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* Êõ¥Êñ∞ÊúçÂä°Âô®ÁöÑÊÄªÂÜôÂÖ•Ê¨°Êï∞ */</span>
</span></span><span class="line"><span class="cl">    <span class="nf">atomicIncr</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">stat_total_writes_processed</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">ssize_t</span> <span class="n">nwritten</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">totwritten</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Âæ™ÁéØÂÜôÂÖ•ÂÆ¢Êà∑Á´ØÁöÑÂæÖÂ§ÑÁêÜÂõûÂ§ç */</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span><span class="p">(</span><span class="nf">clientHasPendingReplies</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="nf">_writeToClient</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nwritten</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">C_ERR</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">totwritten</span> <span class="o">+=</span> <span class="n">nwritten</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* Ê≥®ÊÑèÔºöÊàë‰ª¨ÈÅøÂÖç‰∏ÄÊ¨°ÂÜôÂÖ•Ë∂ÖËøá NET_MAX_WRITES_PER_EVENT Â≠óËäÇ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Âú®ÂçïÁ∫øÁ®ãÊúçÂä°Âô®‰∏≠ÔºåÂç≥‰ΩøÊù•Ëá™Ë∂ÖÈ´òÈÄüÈìæÊé•ÁöÑÂ§ßËØ∑Ê±ÇÊÄªÊòØËÉΩÊé•ÂèóÊï∞ÊçÆÔºå
</span></span></span><span class="line"><span class="cl"><span class="cm">         * ‰πüÂ∫îËØ•ÊúçÂä°ÂÖ∂‰ªñÂÆ¢Êà∑Á´ØÔºàÂú®ÂÆûÈôÖÂú∫ÊôØ‰∏≠ÂèØ‰ª•ËÄÉËôë &#39;KEYS *&#39; ÂëΩ‰ª§ÈÄöËøáÂõûÁéØÊé•Âè£Ôºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         * ÁÑ∂ËÄåÔºåÂ¶ÇÊûúË∂ÖÂá∫‰∫ÜÊúÄÂ§ßÂÜÖÂ≠òÈôêÂà∂ÔºåÊàë‰ª¨‰ºöÂøΩÁï•Ê≠§ÈôêÂà∂ÔºåÂ∞ΩÂèØËÉΩÂú∞ÂèëÈÄÅÊï∞ÊçÆ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">         *
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Ê≠§Â§ñÔºåÂ¶ÇÊûúÂÆ¢Êà∑Á´ØÊòØ‰ªéËäÇÁÇπÊàñÁõëËßÜÂô®ÔºåÊàë‰ª¨‰ºöÂ∞ΩÂèØËÉΩÂ§öÂú∞ÂèëÈÄÅÊï∞ÊçÆÔºå
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Âê¶ÂàôÔºåÂú®È´òÈÄüÊµÅÈáè‰∏ãÔºåÂ§çÂà∂/ËæìÂá∫ÁºìÂÜ≤Âå∫ÂèØËÉΩ‰ºöÊó†ÈôêÂ¢ûÈïø„ÄÇ*/</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">totwritten</span> <span class="o">&gt;</span> <span class="n">NET_MAX_WRITES_PER_EVENT</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">maxmemory</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">             <span class="nf">zmalloc_used_memory</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">server</span><span class="p">.</span><span class="n">maxmemory</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">            <span class="o">!</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_SLAVE</span><span class="p">))</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØÔºåËÆ∞ÂΩïÂ∑≤ÁªèÂèëÈÄÅÁöÑÂ≠óËäÇÊï∞ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="nf">clientTypeIsSlave</span><span class="p">(</span><span class="n">c</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">atomicIncr</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">stat_net_repl_output_bytes</span><span class="p">,</span> <span class="n">totwritten</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">atomicIncr</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">stat_net_output_bytes</span><span class="p">,</span> <span class="n">totwritten</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Ê£ÄÊü•ÂÜôÂÖ•ÊòØÂê¶ÊàêÂäü */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">nwritten</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">connGetState</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">)</span> <span class="o">!=</span> <span class="n">CONN_STATE_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">serverLog</span><span class="p">(</span><span class="n">LL_VERBOSE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;Error writing to client: %s&#34;</span><span class="p">,</span> <span class="nf">connGetLastError</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="nf">freeClientAsync</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Â¶ÇÊûúÊúâÊï∞ÊçÆÂÜôÂÖ•ÔºåÊõ¥Êñ∞ÂÆ¢Êà∑Á´ØÁöÑÊúÄÂêé‰∫§‰∫íÊó∂Èó¥ */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">totwritten</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* ÂØπ‰∫éË°®Á§∫‰∏ªËäÇÁÇπÁöÑÂÆ¢Êà∑Á´ØÔºå‰∏çËÆ°ÁÆóÂèëÈÄÅÊï∞ÊçÆ‰Ωú‰∏∫‰∏ÄÊ¨°‰∫§‰∫íÔºå
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Âõ†‰∏∫Êàë‰ª¨ÊÄªÊòØÂèëÈÄÅ REPLCONF ACK ÂëΩ‰ª§ÔºåËøô‰∫õÂëΩ‰ª§Âè™Âç†Áî®‰∏Ä‰∫õÊó∂Èó¥Êù•Â°´ÂÖÖÂ•óÊé•Â≠óËæìÂá∫ÁºìÂÜ≤Âå∫„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">         * Êàë‰ª¨‰ªÖ‰æùËµñÊé•Êî∂Âà∞ÁöÑÊï∞ÊçÆÊàñ ping ÂëΩ‰ª§Êù•Ê£ÄÊµãË∂ÖÊó∂„ÄÇ */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_MASTER</span><span class="p">))</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">lastinteraction</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">unixtime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Â¶ÇÊûúÂÆ¢Êà∑Á´ØÊ≤°ÊúâÂæÖÂ§ÑÁêÜÁöÑÂõûÂ§ç */</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">clientHasPendingReplies</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="o">-&gt;</span><span class="n">sentlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="cm">/* ËØ∑Ê≥®ÊÑèÔºåwriteToClient() ÊòØÂú®Á∫øÁ®ã‰∏≠Ë∞ÉÁî®ÁöÑÔºå‰ΩÜ aeDeleteFileEvent() ‰∏çÊòØÁ∫øÁ®ãÂÆâÂÖ®ÁöÑÔºö
</span></span></span><span class="line"><span class="cl"><span class="cm">         * ÁÑ∂ËÄåÔºåÁî±‰∫é writeToClient() ÊÄªÊòØÂú®Á∫øÁ®ã‰∏≠Â∞Ü handler_installed ËÆæÁΩÆ‰∏∫ 0Ôºå
</span></span></span><span class="line"><span class="cl"><span class="cm">         * ÊâÄ‰ª•Êàë‰ª¨ÂèØ‰ª•ÊîæÂøÉ„ÄÇ*/</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">handler_installed</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">serverAssert</span><span class="p">(</span><span class="n">io_threads_op</span> <span class="o">==</span> <span class="n">IO_THREADS_OP_IDLE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">connSetWriteHandler</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="cm">/* Âú®ÂèëÈÄÅÂÆåÊï¥ÂõûÂ§çÂêéÂÖ≥Èó≠ËøûÊé•„ÄÇ */</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_CLOSE_AFTER_REPLY</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">freeClientAsync</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/* Âú®ÂÜôÂÖ•Êï∞ÊçÆÂêéÊõ¥Êñ∞ÂÆ¢Êà∑Á´ØÁöÑÂÜÖÂ≠ò‰ΩøÁî®ÊÉÖÂÜµ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Áî±‰∫éËøô‰∏çÊòØÁ∫øÁ®ãÂÆâÂÖ®ÁöÑÔºåÊâÄ‰ª•Êàë‰ª¨‰ºöÊúâÊù°‰ª∂Âú∞ÊâßË°åÊ≠§Êìç‰Ωú„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">     * Â¶ÇÊûúÊòØÂ§öÁ∫øÁ®ãÂÜôÂÖ•ÔºåÂàôÂ∞ÜÂú® handleClientsWithPendingWritesUsingThreads() ‰∏≠Â§ÑÁêÜ„ÄÇ*/</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">io_threads_op</span> <span class="o">==</span> <span class="n">IO_THREADS_OP_IDLE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">updateClientMemUsageAndBucket</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">C_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ÂÜÖÊ†∏ÂáΩÊï∞ÂàÜÊûê">ÂÜÖÊ†∏ÂáΩÊï∞ÂàÜÊûê
</h2><p>docÔºöhttps://man7.org/linux/man-pages/man7/epoll.7.html</p>
<h3 id="epoll_create">epoll_create
</h3><p>int epoll_create(int size);</p>
<h4 id="ÂèÇÊï∞‰ªãÁªç">ÂèÇÊï∞‰ªãÁªç
</h4><p><strong>size</strong>ÔºöËøô‰∏™ÂèÇÊï∞ÊòØÂª∫ËÆÆÂÄºÔºåÁî®‰∫éÊåáÂÆöÂÜÖÈÉ®‰∫ã‰ª∂Êï∞ÁªÑÁöÑÂ§ßÂ∞è„ÄÇÂÆûÈôÖÂ∫îÁî®‰∏≠ÔºåËøô‰∏™ÂÄº‰∏ÄËà¨ÂèØ‰ª•‰º†ÂÖ•‰∏Ä‰∏™ÂêàÈÄÇÁöÑÂÄºÔºå<code>epoll</code> ÂÜÖÈÉ®‰ºöÊ†πÊçÆÊìç‰ΩúÁ≥ªÁªüÁöÑËÉΩÂäõÊù•ÂàÜÈÖçÂÜÖÂ≠ò„ÄÇÊ≠§ÂèÇÊï∞Â∑≤ÁªèÂú® Linux 2.6.8 ‰∏≠Ë¢´Â∫üÂºÉÔºåÂπ∂‰∏îÊ≤°ÊúâÂÆûÈôÖÊÑè‰πâÔºå‰ΩÜ‰∏∫‰∫ÜÂÖºÂÆπÔºå‰æùÁÑ∂Â≠òÂú®„ÄÇ</p>
<h4 id="ËøîÂõûÂÄº">ËøîÂõûÂÄº
</h4><p>fdÊñá‰ª∂ÊèèËø∞Á¨¶id„ÄÇ</p>
<h3 id="epoll_ctl">epoll_ctl
</h3><p>int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event);</p>
<h4 id="ÂèÇÊï∞‰ªãÁªç-1">ÂèÇÊï∞‰ªãÁªç
</h4><p><strong>epfd</strong>ÔºöÈÄöËøá <code>epoll_create</code> ÂàõÂª∫ÁöÑ epoll Êñá‰ª∂ÊèèËø∞Á¨¶„ÄÇ</p>
<p><strong>op</strong>ÔºöÊìç‰ΩúÁ±ªÂûãÔºå<code>EPOLL_CTL_ADD</code>„ÄÅ<code>EPOLL_CTL_MOD</code> Âíå <code>EPOLL_CTL_DEL</code> ÂàÜÂà´Ë°®Á§∫Ê∑ªÂä†„ÄÅ‰øÆÊîπÂíåÂà†Èô§Êñá‰ª∂ÊèèËø∞Á¨¶ÁöÑÊìç‰Ωú„ÄÇ</p>
<p><strong>fd</strong>ÔºöË¶ÅÁõëÊéßÁöÑÊñá‰ª∂ÊèèËø∞Á¨¶„ÄÇ</p>
<p><strong>event</strong>ÔºöÊåáÂÆöÈúÄË¶ÅÁõëÊéßÁöÑ‰∫ã‰ª∂ÔºåÁ±ªÂûã‰∏∫ <code>struct epoll_event</code>ÔºåÂÆÉÂÆö‰πâ‰∫ÜÊÑüÂÖ¥Ë∂£ÁöÑ‰∫ã‰ª∂Á±ªÂûãÔºàÂ¶Ç <code>EPOLLIN</code>„ÄÅ<code>EPOLLOUT</code>„ÄÅ<code>EPOLLRDHUP</code> Á≠âÔºâ‰ª•Âèä‰∏Ä‰∏™Áî®Êà∑Ëá™ÂÆö‰πâÊï∞ÊçÆÂ≠óÊÆµ„ÄÇ</p>
<h4 id="ËøîÂõûÂÄº-1">ËøîÂõûÂÄº
</h4><p>0ÔºöÊàêÂäü</p>
<p>-1ÔºöÂ§±Ë¥•</p>
<h3 id="epoll_wait">epoll_wait
</h3><p>int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout);</p>
<h4 id="ÂèÇÊï∞‰ªãÁªç-2">ÂèÇÊï∞‰ªãÁªç
</h4><p><strong>epfd</strong>ÔºöÈÄöËøá <code>epoll_create</code> ÂàõÂª∫ÁöÑ epoll Êñá‰ª∂ÊèèËø∞Á¨¶„ÄÇ</p>
<p><strong>events</strong>Ôºö‰∏Ä‰∏™Êï∞ÁªÑÔºåÁî®‰∫éÂ≠òÊîæËøîÂõûÁöÑ‰∫ã‰ª∂„ÄÇ</p>
<p><strong>maxevents</strong>ÔºöÊåáÂÆöËøîÂõûÁöÑÊúÄÂ§ß‰∫ã‰ª∂Êï∞„ÄÇÂ¶ÇÊûúÊúâÊõ¥Â§öÁöÑ‰∫ã‰ª∂ÂèëÁîüÔºåÂàôÈúÄË¶ÅË∞ÉÁî®Â§öÊ¨° <code>epoll_wait</code>„ÄÇ</p>
<p><strong>timeout</strong>ÔºöÁ≠âÂæÖÊó∂Èó¥ÔºàÊØ´ÁßíÔºâ„ÄÇÂ¶ÇÊûúËÆæÁΩÆ‰∏∫ <code>-1</code>ÔºåÂàô‰ºöÊó†ÈôêÊúüÈòªÂ°ûÔºåÁõ¥Âà∞Êúâ‰∫ã‰ª∂ÂèëÁîü„ÄÇÂ¶ÇÊûúËÆæÁΩÆ‰∏∫ <code>0</code>ÔºåÂàôÁ´ãÂàªËøîÂõûÔºå‰∏ç‰ºöÈòªÂ°û„ÄÇ</p>
<h4 id="ËøîÂõûÂÄº-2">ËøîÂõûÂÄº
</h4><p>0ÔºöÊàêÂäü</p>
<p>-1ÔºöÂ§±Ë¥•</p>
<h3 id="ËæπÁºòËß¶Âèë--Ê∞¥Âπ≥Ëß¶Âèë">ËæπÁºòËß¶Âèë &amp; Ê∞¥Âπ≥Ëß¶Âèë
</h3><ul>
<li>ËæπÁºòËß¶ÂèëetÔºöÁä∂ÊÄÅÂèëÁîüÂèòÊõ¥ÊâçÈÄöÁü•</li>
<li>Ê∞¥Âπ≥Ëß¶ÂèëltÔºöÂèØËØª/ÂÜôÂàôÈÄöÁü•</li>
</ul>
<div class="table-wrapper"><table>
  <thead>
      <tr>
          <th style="text-align: left">ÁâπÊÄß</th>
          <th style="text-align: left">Ê∞¥Âπ≥Ëß¶ÂèëÔºàLTÔºâ</th>
          <th style="text-align: left">ËæπÁºòËß¶ÂèëÔºàETÔºâ</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">‰∫ã‰ª∂ÈÄöÁü•</td>
          <td style="text-align: left">‰∏ÄÊó¶Êª°Ë∂≥Êù°‰ª∂Â∞±‰ºöÊåÅÁª≠ÈÄöÁü•ÔºåÁõ¥Âà∞‰∫ã‰ª∂Ë¢´Â§ÑÁêÜÂÆå</td>
          <td style="text-align: left">Âè™Âú®Áä∂ÊÄÅÂèòÂåñÊó∂ÈÄöÁü•‰∏ÄÊ¨°ÔºåÂêéÁª≠‰∏çÂÜçÈÄöÁü•ÔºåÁõ¥Âà∞Áä∂ÊÄÅÂÜçÊ¨°ÂèòÂåñ</td>
      </tr>
      <tr>
          <td style="text-align: left">‰∫ã‰ª∂Á±ªÂûã</td>
          <td style="text-align: left">ÂΩìÊñá‰ª∂ÊèèËø∞Á¨¶ÁöÑÁä∂ÊÄÅÁ¨¶ÂêàÊù°‰ª∂Êó∂Ôºà‰æãÂ¶ÇÔºåÊúâÊï∞ÊçÆÂèØËØªÔºâÔºå‰ºöÊåÅÁª≠Ëß¶Âèë‰∫ã‰ª∂ÔºåÁõ¥Âà∞Êù°‰ª∂Ë¢´Â§ÑÁêÜ</td>
          <td style="text-align: left">Âè™‰ºöÂú®Êñá‰ª∂ÊèèËø∞Á¨¶ÁöÑÁä∂ÊÄÅ‰ªé‚ÄúÊú™Â∞±Áª™‚ÄùÂèò‰∏∫‚ÄúÂ∞±Áª™‚ÄùÊó∂Ëß¶Âèë‰∏ÄÊ¨°‰∫ã‰ª∂</td>
      </tr>
      <tr>
          <td style="text-align: left">Â§ÑÁêÜË¶ÅÊ±Ç</td>
          <td style="text-align: left">Â§ÑÁêÜ‰∏ÄÊ¨°‰∫ã‰ª∂ÂêéÔºåÂèØËÉΩ‰ºöÊúâÊõ¥Â§öÁöÑ‰∫ã‰ª∂ÁªßÁª≠Ë¢´ÈÄöÁü•</td>
          <td style="text-align: left">Â§ÑÁêÜÂÆå‰∫ã‰ª∂ÂêéÔºåÂøÖÈ°ªÂ∞ΩÂèØËÉΩÂ§öÂú∞Â§ÑÁêÜÊï∞ÊçÆÔºåÂê¶Âàô‰ºöÈîôËøáÂêéÁª≠‰∫ã‰ª∂</td>
      </tr>
      <tr>
          <td style="text-align: left">ÈÄÇÁî®Âú∫ÊôØ</td>
          <td style="text-align: left">ÈÄÇÂêàÁÆÄÂçïÂú∫ÊôØÔºåÂÆπÊòìÂ§ÑÁêÜ</td>
          <td style="text-align: left">ÈÄÇÂêàÈ´òÂπ∂ÂèëÂíåÈ´òÊÄßËÉΩË¶ÅÊ±ÇÁöÑÂú∫ÊôØÔºåÂáèÂ∞ë‰∫ã‰ª∂ÈÄöÁü•ÁöÑÊ¨°Êï∞</td>
      </tr>
  </tbody>
</table></div>
<h4 id="ÊéßÂà∂">ÊéßÂà∂
</h4><p>Áî±epoll_ctlÊ≥®ÂÜåÁöÑevent.eventsÊéßÂà∂Ôºå<strong>event</strong>ÔºöÊåáÂÆöÈúÄË¶ÅÁõëÊéßÁöÑ‰∫ã‰ª∂ÔºåÁ±ªÂûã‰∏∫ <code>struct epoll_event</code>ÔºåÂÆÉÂÆö‰πâ‰∫ÜÊÑüÂÖ¥Ë∂£ÁöÑ‰∫ã‰ª∂Á±ªÂûãÔºàÂ¶Ç <code>EPOLLIN</code>„ÄÅ<code>EPOLLOUT</code>„ÄÅ<code>EPOLLRDHUP</code> Á≠âÔºâ‰ª•Âèä‰∏Ä‰∏™Áî®Êà∑Ëá™ÂÆö‰πâÊï∞ÊçÆÂ≠óÊÆµ„ÄÇ</p>
<p>ÂΩì‰º†ÂÖ•‰∫ã‰ª∂Á±ªÂûãEPOLLETÊó∂ÔºåËØ•fd‰∏∫ËæπÁºòËß¶Âèë„ÄÇ</p>
<p>ÈªòËÆ§ÊÉÖÂÜµ‰∏∫Ê∞¥Âπ≥Ëß¶Âèë„ÄÇ</p>
<ul>
<li>ÂØπ‰∫éredisËÄåË®ÄÔºå‰ΩøÁî®ÁöÑÂùá‰∏∫Ê∞¥Âπ≥Ëß¶Âèë</li>
<li>nginx‰∏≠Â≠òÂú®ËæπÁºòËß¶ÂèëÁöÑ‰ΩøÁî®</li>
</ul>
<h3 id="epoll_waitÂ¶Ç‰ΩïÂÆûÁé∞Á≠âÂæÖ">epoll_waitÂ¶Ç‰ΩïÂÆûÁé∞Á≠âÂæÖ
</h3><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">ep_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">eventpoll</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">__user</span> <span class="o">*</span><span class="n">events</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		   <span class="kt">int</span> <span class="n">maxevents</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timespec64</span> <span class="o">*</span><span class="n">timeout</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">eavail</span><span class="p">,</span> <span class="n">timed_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">u64</span> <span class="n">slack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">wait_queue_entry_t</span> <span class="n">wait</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">ktime_t</span> <span class="n">expires</span><span class="p">,</span> <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">lockdep_assert_irqs_enabled</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Â¶ÇÊûúÊúâË∂ÖÊó∂Êó∂Èó¥ÔºåÂπ∂‰∏î‰∏ç‰∏∫Èõ∂ÔºåÂàôËΩ¨Êç¢Ë∂ÖÊó∂Êó∂Èó¥‰∏∫ktimeÊ†ºÂºè
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">timeout</span><span class="o">-&gt;</span><span class="n">tv_sec</span> <span class="o">|</span> <span class="n">timeout</span><span class="o">-&gt;</span><span class="n">tv_nsec</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">slack</span> <span class="o">=</span> <span class="nf">select_estimate_accuracy</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">to</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">expires</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="nf">timespec64_to_ktime</span><span class="p">(</span><span class="o">*</span><span class="n">timeout</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Â¶ÇÊûúË∂ÖÊó∂Êó∂Èó¥‰∏∫Èõ∂ÔºåË°®Á§∫ÈùûÈòªÂ°ûÊìç‰Ωú
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">timed_out</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// Ê£ÄÊü•ÊòØÂê¶ÊúâÂèØÁî®ÁöÑ‰∫ã‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">eavail</span> <span class="o">=</span> <span class="nf">ep_events_available</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// Â¶ÇÊûúÊúâ‰∫ã‰ª∂ÔºåÂàôÂ∞Ü‰∫ã‰ª∂ÂèëÈÄÅÂà∞Áî®Êà∑Á©∫Èó¥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="n">eavail</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">res</span> <span class="o">=</span> <span class="nf">ep_send_events</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">maxevents</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// Â¶ÇÊûúÂèëÈÄÅÊàêÂäüÔºåÊåÇËµ∑ NAPI ‰∏≠Êñ≠
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">					<span class="nf">ep_suspend_napi_irqs</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">				<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Â¶ÇÊûúË∂ÖÊó∂Ê†áÂøó‰∏∫ÁúüÔºåÁõ¥Êé•ËøîÂõû
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="n">timed_out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Â¶ÇÊûúÊ≤°Êúâ‰∫ã‰ª∂ÔºåÊâßË°åÂøôÁ≠âÂæÖ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">eavail</span> <span class="o">=</span> <span class="nf">ep_busy_loop</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">timed_out</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">eavail</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Ê£ÄÊü•ÊòØÂê¶Êúâ‰ø°Âè∑‰∏≠Êñ≠
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="nf">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// ÂàùÂßãÂåñÁ≠âÂæÖÈòüÂàó
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">init_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">wait</span><span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">ep_autoremove_wake_function</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Âä†ÈîÅÔºåÊ£ÄÊü•‰∫ã‰ª∂ÊòØÂê¶ÂèØÁî®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">write_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">__set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// ÂÜçÊ¨°Ê£ÄÊü•ÊòØÂê¶ÊúâÂèØÁî®‰∫ã‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">eavail</span> <span class="o">=</span> <span class="nf">ep_events_available</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eavail</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// Â¶ÇÊûúÊ≤°Êúâ‰∫ã‰ª∂ÔºåÂä†ÂÖ•Âà∞Á≠âÂæÖÈòüÂàó
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nf">__add_wait_queue_exclusive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Â¶ÇÊûúÊ≤°Êúâ‰∫ã‰ª∂ÔºåË∞ÉÁî®È´òÁ≤æÂ∫¶ÂÆöÊó∂Âô®ËøõË°åÁ≠âÂæÖ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eavail</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="n">timed_out</span> <span class="o">=</span> <span class="o">!</span><span class="nf">schedule_hrtimeout_range</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">slack</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">							      <span class="n">HRTIMER_MODE_ABS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// ËÆæÁΩÆÂΩìÂâç‰ªªÂä°‰∏∫ËøêË°åÁä∂ÊÄÅ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">__set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Ë¢´Âî§ÈÜíÂêéÊ£ÄÊü•ÊòØÂê¶Êúâ‰∫ã‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">eavail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// Â¶ÇÊûúÁ≠âÂæÖÈòüÂàó‰∏ç‰∏∫Á©∫ÔºåÁßªÈô§ÂΩìÂâçÁ≠âÂæÖÊù°ÁõÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">list_empty_careful</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">.</span><span class="n">entry</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">write_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="p">(</span><span class="n">timed_out</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">				<span class="c1">// Â¶ÇÊûúË∂ÖÊó∂ÔºåÂàôÂÜçÊ¨°Ê£ÄÊü•Á≠âÂæÖÈòüÂàóÊòØÂê¶‰∏∫Á©∫
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="n">eavail</span> <span class="o">=</span> <span class="nf">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">.</span><span class="n">entry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// ‰ªéÁ≠âÂæÖÈòüÂàó‰∏≠ÁßªÈô§ÂΩìÂâçÊù°ÁõÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nf">__remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="nf">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="ÊÄªÁªì">ÊÄªÁªì
</h4><p><strong>ÈòªÂ°ûÂÆûÁé∞</strong>ÔºöÂΩìÊ≤°Êúâ‰∫ã‰ª∂ÂèëÁîü‰∏îË∂ÖÊó∂Êù°‰ª∂‰∏∫ <code>-1</code> Êó∂Ôºå<code>ep_poll</code> ‰ºöÈÄöËøáÂ∞ÜÂΩìÂâçËøõÁ®ãÂä†ÂÖ•Âà∞Á≠âÂæÖÈòüÂàó‰∏≠Êù•ÂÆûÁé∞ÈòªÂ°ûÔºåÁõ¥Âà∞‰∫ã‰ª∂ÂèëÁîüÊàñËÄÖË∂ÖÊó∂„ÄÇ</p>
<p><strong>ÂøôÁ≠âÂæÖÁöÑ‰ΩúÁî®</strong>ÔºöÂøôÁ≠âÂæÖÊòØÂú®Ê≤°Êúâ‰∫ã‰ª∂ÁöÑÊÉÖÂÜµ‰∏ã‰∏çÊñ≠ËΩÆËØ¢Ê£ÄÊü•‰∫ã‰ª∂ÈòüÂàóÔºåÂ¶ÇÊûúÊúâ‰∫ã‰ª∂ÔºåÂàôÁ´ãÂç≥Â§ÑÁêÜ„ÄÇÂ¶ÇÊûúÊ≤°Êúâ‰∫ã‰ª∂ÔºåÂàôÈÅøÂÖçËøáÊó©Âú∞ÈòªÂ°û„ÄÇ</p>
<p><strong>Á≠âÂæÖÈòüÂàóÁöÑÂä†ÂÖ•</strong>ÔºöÂú®ÂøôÁ≠âÂæÖÊ£ÄÊü•‰πãÂêéÔºå<code>ep_poll</code> ‰ºöÂú®Á°ÆËÆ§Ê≤°Êúâ‰∫ã‰ª∂‰∏îÊ≤°ÊúâË∂ÖÊó∂Êó∂ÔºåÂ∞ÜËøõÁ®ãÂä†ÂÖ•Á≠âÂæÖÈòüÂàó„ÄÇÁ≠âÂæÖÈòüÂàó‰øùËØÅ‰∫ÜËøõÁ®ãÂèØ‰ª•Ë¢´ÊåÇËµ∑ÔºåÁõ¥Âà∞Êúâ‰∫ã‰ª∂ÂèëÁîüÊàñËÄÖË∂ÖÊó∂„ÄÇ</p>
<h4 id="‰∏ÄÁõ¥Ê≤°Êúâ‰∫ã‰ª∂ÂèëÁîüÁöÑ‰æãÂ≠ê">‰∏ÄÁõ¥Ê≤°Êúâ‰∫ã‰ª∂ÂèëÁîüÁöÑ‰æãÂ≠ê
</h4><p><strong>Ê≤°Êúâ‰∫ã‰ª∂ÁöÑÊÉÖÂÜµ‰∏ãÔºå<code>eavail</code> ‰ºöÊåÅÁª≠‰∏∫ <code>0</code>„ÄÇ</strong></p>
<ul>
<li>ep_events_availableÔºåËøîÂõû0ÔºåÂΩì <code>eavail == 0</code> Êó∂Ôºå‰ª£Á†Å‰ºöÂÖàËøõÂÖ•ÂøôÁ≠âÂæÖÈò∂ÊÆµÔºåÂπ∂Â∞ùËØïÈáçÊñ∞Ê£ÄÊü•ÊòØÂê¶Êúâ‰∫ã‰ª∂„ÄÇ
<ul>
<li>ÈÅøÂÖçÁõ¥Êé•ËøõÂÖ•ÈòªÂ°ûÔºåÊèêÈ´òÊâßË°åÊïàÁéáÔºàÁ±ª‰ººjvm‰∏≠ÂÖàËΩªÈáèÁ∫ßcasÈîÅÔºåÊª°Ë∂≥‰∏ÄÂÆöÊù°‰ª∂ÂêéÂÜçÂçáÁ∫ß‰∏∫‰æùËµñosÁöÑÈáçÈîÅÔºâ</li>
</ul>
</li>
<li>Â¶ÇÊûúÁªèËøáÂøôÁ≠âÂæÖ‰ªçÁÑ∂Ê≤°Êúâ‰∫ã‰ª∂Ôºåep_busy_loopËøîÂõû0ÔºåÊ≠§Êó∂ <code>eavail == 0</code> Ôºå<code>epoll</code> ‰ºöËøõÂÖ•Á≠âÂæÖÈòüÂàóÂπ∂ÈòªÂ°ûÂΩìÂâçÁ∫øÁ®ãÔºåÁõ¥Âà∞‰∫ã‰ª∂ÂèëÁîü„ÄÇ</li>
<li>ÂΩìËøõÁ®ãË¢´Âî§ÈÜíÂêéÔºå<code>eavail</code> Ë¢´Âº∫Âà∂ËÆæÁΩÆ‰∏∫ <code>1</code>ÔºåË°®Á§∫ËøõÂÖ•‰∏ã‰∏ÄËΩÆ‰∫ã‰ª∂ÁöÑÂ§ÑÁêÜ„ÄÇ</li>
</ul>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI&#43;WdtXRGWt2kTvGFasHpSy3SV"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG&#43;vnGctmUb0ZY0l8"crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"integrity="sha384-&#43;VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4&#43;/RRE05"crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.body, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>
    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Áõ∏ÂÖ≥ÊñáÁ´†</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/zh-cn/p/%E9%AB%98%E6%80%A7%E8%83%BD%E9%AB%98%E5%8F%AF%E7%94%A8-reids-%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4/">
        
        

        <div class="article-details">
            <h2 class="article-title">È´òÊÄßËÉΩ&amp;È´òÂèØÁî® reids-ÂàÜÂ∏ÉÂºèÈõÜÁæ§</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/zh-cn/p/%E9%AB%98%E6%80%A7%E8%83%BD-reids-%E5%86%85%E5%AD%98%E6%95%88%E7%8E%87/">
        
        

        <div class="article-details">
            <h2 class="article-title">È´òÊÄßËÉΩ reids-ÂÜÖÂ≠òÊïàÁéá</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/zh-cn/p/%E6%9D%83%E9%99%90%E8%AE%BE%E8%AE%A1-%E9%89%B4%E6%9D%83%E6%8E%88%E6%9D%83/">
        
        

        <div class="article-details">
            <h2 class="article-title">ÊùÉÈôêËÆæËÆ°-Èâ¥ÊùÉÊéàÊùÉ</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/zh-cn/p/%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6-orm-spring/">
        
        

        <div class="article-details">
            <h2 class="article-title">ÂºÄÂèëÊ°ÜÊû∂-orm-spring</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/zh-cn/p/%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6-aop-spring/">
        
        

        <div class="article-details">
            <h2 class="article-title">ÂºÄÂèëÊ°ÜÊû∂-aop-spring</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "hugo-theme-stack" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            1998 - 
        
        2024 yuwenxin
    </section>
    
    <section class="powerby">
        
            welcome to wenxin-blog <br/>
        ‰ΩøÁî® <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> ÊûÑÂª∫ <br />
        ‰∏ªÈ¢ò <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.27.0">Stack</a></b> Áî± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> ËÆæËÆ°
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
